/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../constants","./Bone","../math/Matrix4","../textures/DataTexture","../math/MathUtils"],(function(e,t,n,s,o,r){"use strict";var i=new s.Matrix4,a=new s.Matrix4,h=function(){function e(e,t){void 0===e&&(e=[]),void 0===t&&(t=[]),this.uuid=r.generateUUID(),this.bones=e.slice(0),this.boneInverses=t,this.boneMatrices=null,this.boneTexture=null,this.boneTextureSize=0,this.frame=-1,this.init()}var h=e.prototype;return h.init=function(){var e=this.bones,t=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===t.length)this.calculateInverses();else if(e.length!==t.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(var n=0,o=this.bones.length;n<o;n++)this.boneInverses.push(new s.Matrix4)}},h.calculateInverses=function(){this.boneInverses.length=0;for(var e=0,t=this.bones.length;e<t;e++){var n=new s.Matrix4;this.bones[e]&&n.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(n)}},h.pose=function(){for(var e=0,t=this.bones.length;e<t;e++){var n=this.bones[e];n&&n.matrixWorld.copy(this.boneInverses[e]).invert()}for(var s=0,o=this.bones.length;s<o;s++){var r=this.bones[s];r&&(r.parent&&r.parent.isBone?(r.matrix.copy(r.parent.matrixWorld).invert(),r.matrix.multiply(r.matrixWorld)):r.matrix.copy(r.matrixWorld),r.matrix.decompose(r.position,r.quaternion,r.scale))}},h.update=function(){for(var e=this.bones,t=this.boneInverses,n=this.boneMatrices,s=this.boneTexture,o=0,r=e.length;o<r;o++){var h=e[o]?e[o].matrixWorld:a;i.multiplyMatrices(h,t[o]),i.toArray(n,16*o)}null!==s&&(s.needsUpdate=!0)},h.clone=function(){return new e(this.bones,this.boneInverses)},h.computeBoneTexture=function(){var e=Math.sqrt(4*this.bones.length);e=r.ceilPowerOfTwo(e),e=Math.max(e,4);var n=new Float32Array(e*e*4);n.set(this.boneMatrices);var s=new o.DataTexture(n,e,e,t.RGBAFormat,t.FloatType);return s.needsUpdate=!0,this.boneMatrices=n,this.boneTexture=s,this.boneTextureSize=e,this},h.getBoneByName=function(e){for(var t=0,n=this.bones.length;t<n;t++){var s=this.bones[t];if(s.name===e)return s}},h.dispose=function(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)},h.fromJSON=function(e,t){this.uuid=e.uuid;for(var o=0,r=e.bones.length;o<r;o++){var i=e.bones[o],a=t[i];void 0===a&&(console.warn("THREE.Skeleton: No bone found with UUID:",i),a=new n.Bone),this.bones.push(a),this.boneInverses.push((new s.Matrix4).fromArray(e.boneInverses[o]))}return this.init(),this},h.toJSON=function(){var e={metadata:{version:4.5,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;for(var t=this.bones,n=this.boneInverses,s=0,o=t.length;s<o;s++){var r=t[s];e.bones.push(r.uuid);var i=n[s];e.boneInverses.push(i.toArray())}return e},e}();e.Skeleton=h,Object.defineProperty(e,"__esModule",{value:!0})}));

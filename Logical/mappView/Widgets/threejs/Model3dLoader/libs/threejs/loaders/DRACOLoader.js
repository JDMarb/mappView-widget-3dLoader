/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","../core/BufferAttribute","../core/BufferGeometry","./FileLoader","./Loader"],(function(e,r,t,o,n,a){"use strict";var i=new WeakMap,s=function(e){function a(r){var t;return(t=e.call(this,r)||this).decoderPath="",t.decoderConfig={},t.decoderBinary=null,t.decoderPending=null,t.workerLimit=4,t.workerPool=[],t.workerNextTaskID=1,t.workerSourceURL="",t.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},t.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"},t}r.inheritsLoose(a,e);var s=a.prototype;return s.setDecoderPath=function(e){return this.decoderPath=e,this},s.setDecoderConfig=function(e){return this.decoderConfig=e,this},s.setWorkerLimit=function(e){return this.workerLimit=e,this},s.load=function(e,r,t,o){var a=this,i=new n.FileLoader(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,(function(e){var t={attributeIDs:a.defaultAttributeIDs,attributeTypes:a.defaultAttributeTypes,useUniqueIDs:!1};a.decodeGeometry(e,t).then(r).catch(o)}),t,o)},s.decodeDracoFile=function(e,r,t,o){var n={attributeIDs:t||this.defaultAttributeIDs,attributeTypes:o||this.defaultAttributeTypes,useUniqueIDs:!!t};this.decodeGeometry(e,n).then(r)},s.decodeGeometry=function(e,r){var t=this;for(var o in r.attributeTypes){var n=r.attributeTypes[o];void 0!==n.BYTES_PER_ELEMENT&&(r.attributeTypes[o]=n.name)}var a,s=JSON.stringify(r);if(i.has(e)){var d=i.get(e);if(d.key===s)return d.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var u=this.workerNextTaskID++,c=e.byteLength,f=this._getWorker(u,c).then((function(t){return a=t,new Promise((function(t,o){a._callbacks[u]={resolve:t,reject:o},a.postMessage({type:"decode",id:u,taskConfig:r,buffer:e},[e])}))})).then((function(e){return t._createGeometry(e.geometry)}));return f.catch((function(){return!0})).then((function(){a&&u&&t._releaseTask(a,u)})),i.set(e,{key:s,promise:f}),f},s._createGeometry=function(e){var r=new o.BufferGeometry;e.index&&r.setIndex(new t.BufferAttribute(e.index.array,1));for(var n=0;n<e.attributes.length;n++){var a=e.attributes[n],i=a.name,s=a.array,d=a.itemSize;r.setAttribute(i,new t.BufferAttribute(s,d))}return r},s._loadLibrary=function(e,r){var t=new n.FileLoader(this.manager);return t.setPath(this.decoderPath),t.setResponseType(r),t.setWithCredentials(this.withCredentials),new Promise((function(r,o){t.load(e,r,void 0,o)}))},s.preload=function(){return this._initDecoder(),this},s._initDecoder=function(){var e=this;if(this.decoderPending)return this.decoderPending;var r="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return r?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((function(t){var o=t[0];r||(e.decoderConfig.wasmBinary=t[1]);var n=d.toString(),a=["/* draco decoder */",o,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");e.workerSourceURL=URL.createObjectURL(new Blob([a]))})),this.decoderPending},s._getWorker=function(e,r){var t=this;return this._initDecoder().then((function(){if(t.workerPool.length<t.workerLimit){var o=new Worker(t.workerSourceURL);o._callbacks={},o._taskCosts={},o._taskLoad=0,o.postMessage({type:"init",decoderConfig:t.decoderConfig}),o.onmessage=function(e){var r=e.data;switch(r.type){case"decode":o._callbacks[r.id].resolve(r);break;case"error":o._callbacks[r.id].reject(r);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+r.type+'"')}},t.workerPool.push(o)}else t.workerPool.sort((function(e,r){return e._taskLoad>r._taskLoad?-1:1}));var n=t.workerPool[t.workerPool.length-1];return n._taskCosts[e]=r,n._taskLoad+=r,n}))},s._releaseTask=function(e,r){e._taskLoad-=e._taskCosts[r],delete e._callbacks[r],delete e._taskCosts[r]},s.debug=function(){console.log("Task load: ",this.workerPool.map((function(e){return e._taskLoad})))},s.dispose=function(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this},a}(a.Loader);function d(){var e,r;function t(e,r,t,o,n,a){var i=a.num_components(),s=t.num_points()*i,d=s*n.BYTES_PER_ELEMENT,u=function(e,r){switch(r){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,n),c=e._malloc(d);r.GetAttributeDataArrayForAllPoints(t,a,u,d,c);var f=new n(e.HEAPF32.buffer,c,s).slice();return e._free(c),{name:o,array:f,itemSize:i}}onmessage=function(o){var n=o.data;switch(n.type){case"init":e=n.decoderConfig,r=new Promise((function(r){e.onModuleLoaded=function(e){r({draco:e})},DracoDecoderModule(e)}));break;case"decode":var a=n.buffer,i=n.taskConfig;r.then((function(e){var r=e.draco,o=new r.Decoder,s=new r.DecoderBuffer;s.Init(new Int8Array(a),a.byteLength);try{var d=function(e,r,o,n){var a,i,s=n.attributeIDs,d=n.attributeTypes,u=r.GetEncodedGeometryType(o);if(u===e.TRIANGULAR_MESH)a=new e.Mesh,i=r.DecodeBufferToMesh(o,a);else{if(u!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");a=new e.PointCloud,i=r.DecodeBufferToPointCloud(o,a)}if(!i.ok()||0===a.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+i.error_msg());var c={index:null,attributes:[]};for(var f in s){var l=self[d[f]],h=void 0,y=void 0;if(n.useUniqueIDs)y=s[f],h=r.GetAttributeByUniqueId(a,y);else{if(-1===(y=r.GetAttributeId(a,e[s[f]])))continue;h=r.GetAttribute(a,y)}c.attributes.push(t(e,r,a,f,l,h))}u===e.TRIANGULAR_MESH&&(c.index=function(e,r,t){var o=3*t.num_faces(),n=4*o,a=e._malloc(n);r.GetTrianglesUInt32Array(t,n,a);var i=new Uint32Array(e.HEAPF32.buffer,a,o).slice();return e._free(a),{array:i,itemSize:1}}(e,r,a));return e.destroy(a),c}(r,o,s,i),u=d.attributes.map((function(e){return e.array.buffer}));d.index&&u.push(d.index.array.buffer),self.postMessage({type:"decode",id:n.id,geometry:d},u)}catch(e){console.error(e),self.postMessage({type:"error",id:n.id,error:e.message})}finally{r.destroy(s),r.destroy(o)}}))}}}e.DRACOLoader=s,Object.defineProperty(e,"__esModule",{value:!0})}));

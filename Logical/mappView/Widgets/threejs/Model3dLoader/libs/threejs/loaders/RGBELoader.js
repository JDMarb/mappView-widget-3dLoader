/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","./DataTextureLoader","../extras/DataUtils","../constants"],(function(r,e,a,t,n){"use strict";var o=function(r){function a(e){var a;return(a=r.call(this,e)||this).type=n.HalfFloatType,a}e.inheritsLoose(a,r);var o=a.prototype;return o.parse=function(r){var e=function(r,e){switch(r){case 1:console.error("THREE.RGBELoader Read Error: "+(e||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(e||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(e||""));break;default:console.error("THREE.RGBELoader: Error: "+(e||""))}return-1},a=function(r,e,a){e=e||1024;for(var t=r.pos,n=-1,o=0,i="",s=String.fromCharCode.apply(null,new Uint16Array(r.subarray(t,t+128)));0>(n=s.indexOf("\n"))&&o<e&&t<r.byteLength;)i+=s,o+=s.length,t+=128,s+=String.fromCharCode.apply(null,new Uint16Array(r.subarray(t,t+128)));return-1<n&&(!1!==a&&(r.pos+=o+n+1),i+s.slice(0,n))},o=function(r,e,a,n){var o=r[e+3],i=Math.pow(2,o-128)/255;a[n+0]=t.toHalfFloat(Math.min(r[e+0]*i,65504)),a[n+1]=t.toHalfFloat(Math.min(r[e+1]*i,65504)),a[n+2]=t.toHalfFloat(Math.min(r[e+2]*i,65504)),a[n+3]=t.toHalfFloat(1)},i=new Uint8Array(r);i.pos=0;var s,l,f,u,p,d,c=function(r){var t,n,o=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,s=/^\s*FORMAT=(\S+)\s*$/,l=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,f={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};if(r.pos>=r.byteLength||!(t=a(r)))return e(1,"no header found");if(!(n=t.match(/^#\?(\S+)/)))return e(3,"bad initial token");for(f.valid|=1,f.programtype=n[1],f.string+=t+"\n";!1!==(t=a(r));)if(f.string+=t+"\n","#"!==t.charAt(0)){if((n=t.match(o))&&(f.gamma=parseFloat(n[1])),(n=t.match(i))&&(f.exposure=parseFloat(n[1])),(n=t.match(s))&&(f.valid|=2,f.format=n[1]),(n=t.match(l))&&(f.valid|=4,f.height=parseInt(n[1],10),f.width=parseInt(n[2],10)),2&f.valid&&4&f.valid)break}else f.comments+=t+"\n";return 2&f.valid?4&f.valid?f:e(3,"missing image size specifier"):e(3,"missing format specifier")}(i);if(-1!==c){var h=c.width,y=c.height,g=function(r,a,t){var n=a;if(n<8||n>32767||2!==r[0]||2!==r[1]||128&r[2])return new Uint8Array(r);if(n!==(r[2]<<8|r[3]))return e(3,"wrong scanline width");var o=new Uint8Array(4*a*t);if(!o.length)return e(4,"unable to allocate buffer space");for(var i=0,s=0,l=4*n,f=new Uint8Array(4),u=new Uint8Array(l),p=t;p>0&&s<r.byteLength;){if(s+4>r.byteLength)return e(1);if(f[0]=r[s++],f[1]=r[s++],f[2]=r[s++],f[3]=r[s++],2!=f[0]||2!=f[1]||(f[2]<<8|f[3])!=n)return e(3,"bad rgbe scanline format");for(var d=0,c=void 0;d<l&&s<r.byteLength;){var h=(c=r[s++])>128;if(h&&(c-=128),0===c||d+c>l)return e(3,"bad scanline data");if(h)for(var y=r[s++],g=0;g<c;g++)u[d++]=y;else u.set(r.subarray(s,s+c),d),d+=c,s+=c}for(var m=n,v=0;v<m;v++){var b=0;o[i]=u[v+b],b+=n,o[i+1]=u[v+b],b+=n,o[i+2]=u[v+b],b+=n,o[i+3]=u[v+b],i+=4}p--}return o}(i.subarray(i.pos),h,y);if(-1!==g){var m,v,b;switch(this.type){case n.FloatType:b=g.length/4;for(var E=new Float32Array(4*b),F=0;F<b;F++)f=E,u=4*F,p=void 0,d=void 0,p=(s=g)[(l=4*F)+3],d=Math.pow(2,p-128)/255,f[u+0]=s[l+0]*d,f[u+1]=s[l+1]*d,f[u+2]=s[l+2]*d,f[u+3]=1;m=E,v=n.FloatType;break;case n.HalfFloatType:b=g.length/4;for(var w=new Uint16Array(4*b),L=0;L<b;L++)o(g,4*L,w,4*L);m=w,v=n.HalfFloatType;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:h,height:y,data:m,header:c.string,gamma:c.gamma,exposure:c.exposure,type:v}}}return null},o.setDataType=function(r){return this.type=r,this},o.load=function(e,a,t,o){return r.prototype.load.call(this,e,(function(r,e){switch(r.type){case n.FloatType:case n.HalfFloatType:r.encoding=n.LinearEncoding,r.minFilter=n.LinearFilter,r.magFilter=n.LinearFilter,r.generateMipmaps=!1,r.flipY=!0}a&&a(r,e)}),t,o)},a}(a.DataTextureLoader);r.RGBELoader=o,Object.defineProperty(r,"__esModule",{value:!0})}));

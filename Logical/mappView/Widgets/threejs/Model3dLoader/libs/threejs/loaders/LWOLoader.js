/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","../constants","../core/BufferAttribute","../core/BufferGeometry","../math/Color","./FileLoader","../materials/LineBasicMaterial","../objects/LineSegments","./Loader","../objects/Mesh","../materials/MeshPhongMaterial","../materials/MeshPhysicalMaterial","../materials/MeshStandardMaterial","../objects/Points","../materials/PointsMaterial","./TextureLoader","../math/Vector2","./lwo/IFFParser"],(function(e,a,t,r,s,i,n,o,u,p,l,c,h,f,m,v,d,g,M){"use strict";var y,b=function(e){function t(a,t){var r;return void 0===t&&(t={}),(r=e.call(this,a)||this).resourcePath=void 0!==t.resourcePath?t.resourcePath:"",r}a.inheritsLoose(t,e);var r=t.prototype;return r.load=function(e,a,t,r){var s=this,i=""===s.path?function(e,a){var t=e.indexOf(a);return-1===t?"./":e.slice(0,t)}(e,"Objects"):s.path,o=e.split(i).pop().split(".")[0],u=new n.FileLoader(this.manager);u.setPath(s.path),u.setResponseType("arraybuffer"),u.load(e,(function(t){try{a(s.parse(t,i,o))}catch(a){r?r(a):console.error(a),s.manager.itemError(e)}}),t,r)},r.parse=function(e,a,t){y=(new M.IFFParser).parse(e);var r=new d.TextureLoader(this.manager).setPath(this.resourcePath||a).setCrossOrigin(this.crossOrigin);return new w(r).parse(t)},t}(p.Loader),w=function(){function e(e){this.textureLoader=e}var a=e.prototype;return a.parse=function(e){return this.materials=new L(this.textureLoader).parse(),this.defaultLayerName=e,this.meshes=this.parseLayers(),{materials:this.materials,meshes:this.meshes}},a.parseLayers=function(){var e=[],a=[],t=new T,r=this;return y.layers.forEach((function(s){var i=t.parse(s.geometry,s),n=r.parseMesh(i,s);e[s.number]=n,-1===s.parent?a.push(n):e[s.parent].add(n)})),this.applyPivots(a),a},a.parseMesh=function(e,a){var t,r=this.getMaterials(e.userData.matNames,a.geometry.type);return this.duplicateUVs(e,r),t="points"===a.geometry.type?new m.Points(e,r):"lines"===a.geometry.type?new u.LineSegments(e,r):new l.Mesh(e,r),a.name?t.name=a.name:t.name=this.defaultLayerName+"_layer_"+a.number,t.userData.pivot=a.pivot,t},a.applyPivots=function(e){e.forEach((function(e){e.traverse((function(e){var a=e.userData.pivot;if(e.position.x+=a[0],e.position.y+=a[1],e.position.z+=a[2],e.parent){var t=e.parent.userData.pivot;e.position.x-=t[0],e.position.y-=t[1],e.position.z-=t[2]}}))}))},a.getMaterials=function(e,a){var t=[],r=this;e.forEach((function(e,a){t[a]=r.getMaterialByName(e)})),"points"!==a&&"lines"!==a||t.forEach((function(e,r){var s={color:e.color};"points"===a?(s.size=.1,s.map=e.map,t[r]=new v.PointsMaterial(s)):"lines"===a&&(t[r]=new o.LineBasicMaterial(s))}));var s=t.filter(Boolean);return 1===s.length?s[0]:t},a.getMaterialByName=function(e){return this.materials.filter((function(a){return a.name===e}))[0]},a.duplicateUVs=function(e,a){var t=!1;Array.isArray(a)?a.forEach((function(e){e.aoMap&&(t=!0)})):a.aoMap&&(t=!0),t&&e.setAttribute("uv2",new r.BufferAttribute(e.attributes.uv.array,2))},e}(),L=function(){function e(e){this.textureLoader=e}var a=e.prototype;return a.parse=function(){var e=[];for(var a in this.textures={},y.materials)"LWO3"===y.format?e.push(this.parseMaterial(y.materials[a],a,y.textures)):"LWO2"===y.format&&e.push(this.parseMaterialLwo2(y.materials[a],a,y.textures));return e},a.parseMaterial=function(e,a,t){var r={name:a,side:this.getSide(e.attributes),flatShading:this.getSmooth(e.attributes)},s=this.parseConnections(e.connections,e.nodes),i=this.parseTextureNodes(s.maps);this.parseAttributeImageMaps(s.attributes,t,i,e.maps);var n=this.parseAttributes(s.attributes,i);this.parseEnvMap(s,i,n),r=Object.assign(i,r),r=Object.assign(r,n);var o=this.getMaterialType(s.attributes);return o!==c.MeshPhongMaterial&&delete r.refractionRatio,new o(r)},a.parseMaterialLwo2=function(e,a){var t={name:a,side:this.getSide(e.attributes),flatShading:this.getSmooth(e.attributes)},r=this.parseAttributes(e.attributes,{});return t=Object.assign(t,r),new c.MeshPhongMaterial(t)},a.getSide=function(e){if(!e.side)return t.BackSide;switch(e.side){case 0:case 1:return t.BackSide;case 2:return t.FrontSide;case 3:return t.DoubleSide}},a.getSmooth=function(e){return!e.smooth||!e.smooth},a.parseConnections=function(e,a){var t={maps:{}},r=e.inputName,s=e.inputNodeName,i=e.nodeName,n=this;return r.forEach((function(e,r){if("Material"===e){var i=n.getNodeByRefName(s[r],a);t.attributes=i.attributes,t.envMap=i.fileName,t.name=s[r]}})),i.forEach((function(e,i){e===t.name&&(t.maps[r[i]]=n.getNodeByRefName(s[i],a))})),t},a.getNodeByRefName=function(e,a){for(var t in a)if(a[t].refName===e)return a[t]},a.parseTextureNodes=function(e){var a={};for(var t in e){var r=e[t],s=r.fileName;if(!s)return;var i=this.loadTexture(s);switch(void 0!==r.widthWrappingMode&&(i.wrapS=this.getWrappingType(r.widthWrappingMode)),void 0!==r.heightWrappingMode&&(i.wrapT=this.getWrappingType(r.heightWrappingMode)),t){case"Color":a.map=i;break;case"Roughness":a.roughnessMap=i,a.roughness=1;break;case"Specular":a.specularMap=i,a.specular=16777215;break;case"Luminous":a.emissiveMap=i,a.emissive=8421504;break;case"Luminous Color":a.emissive=8421504;break;case"Metallic":a.metalnessMap=i,a.metalness=1;break;case"Transparency":case"Alpha":a.alphaMap=i,a.transparent=!0;break;case"Normal":a.normalMap=i,void 0!==r.amplitude&&(a.normalScale=new g.Vector2(r.amplitude,r.amplitude));break;case"Bump":a.bumpMap=i}}return a.roughnessMap&&a.specularMap&&delete a.specularMap,a},a.parseAttributeImageMaps=function(e,a,t){for(var r in e){var s=e[r];if(s.maps){var i=s.maps[0],n=this.getTexturePathByIndex(i.imageIndex,a);if(!n)return;var o=this.loadTexture(n);switch(void 0!==i.wrap&&(o.wrapS=this.getWrappingType(i.wrap.w)),void 0!==i.wrap&&(o.wrapT=this.getWrappingType(i.wrap.h)),r){case"Color":t.map=o;break;case"Diffuse":t.aoMap=o;break;case"Roughness":t.roughnessMap=o,t.roughness=1;break;case"Specular":t.specularMap=o,t.specular=16777215;break;case"Luminosity":t.emissiveMap=o,t.emissive=8421504;break;case"Metallic":t.metalnessMap=o,t.metalness=1;break;case"Transparency":case"Alpha":t.alphaMap=o,t.transparent=!0;break;case"Normal":t.normalMap=o;break;case"Bump":t.bumpMap=o}}}},a.parseAttributes=function(e,a){var t={};return e.Color&&!a.map?t.color=(new i.Color).fromArray(e.Color.value):t.color=new i.Color,e.Transparency&&0!==e.Transparency.value&&(t.opacity=1-e.Transparency.value,t.transparent=!0),e["Bump Height"]&&(t.bumpScale=.1*e["Bump Height"].value),this.parsePhysicalAttributes(t,e,a),this.parseStandardAttributes(t,e,a),this.parsePhongAttributes(t,e,a),t},a.parsePhysicalAttributes=function(e,a){a.Clearcoat&&a.Clearcoat.value>0&&(e.clearcoat=a.Clearcoat.value,a["Clearcoat Gloss"]&&(e.clearcoatRoughness=.5*(1-a["Clearcoat Gloss"].value)))},a.parseStandardAttributes=function(e,a,t){a.Luminous&&(e.emissiveIntensity=a.Luminous.value,a["Luminous Color"]&&!t.emissive?e.emissive=(new i.Color).fromArray(a["Luminous Color"].value):e.emissive=new i.Color(8421504)),a.Roughness&&!t.roughnessMap&&(e.roughness=a.Roughness.value),a.Metallic&&!t.metalnessMap&&(e.metalness=a.Metallic.value)},a.parsePhongAttributes=function(e,a,r){a["Refraction Index"]&&(e.refractionRatio=.98/a["Refraction Index"].value),a.Diffuse&&e.color.multiplyScalar(a.Diffuse.value),a.Reflection&&(e.reflectivity=a.Reflection.value,e.combine=t.AddOperation),a.Luminosity&&(e.emissiveIntensity=a.Luminosity.value,r.emissiveMap||r.map?e.emissive=new i.Color(8421504):e.emissive=e.color),a.Roughness||!a.Specular||r.specularMap||(a["Color Highlight"]?e.specular=(new i.Color).setScalar(a.Specular.value).lerp(e.color.clone().multiplyScalar(a.Specular.value),a["Color Highlight"].value):e.specular=(new i.Color).setScalar(a.Specular.value)),e.specular&&a.Glossiness&&(e.shininess=7+Math.pow(2,12*a.Glossiness.value+2))},a.parseEnvMap=function(e,a,r){if(e.envMap){var s=this.loadTexture(e.envMap);r.transparent&&r.opacity<.999?(s.mapping=t.EquirectangularRefractionMapping,void 0!==r.reflectivity&&(delete r.reflectivity,delete r.combine),void 0!==r.metalness&&(r.metalness=1),r.opacity=1):s.mapping=t.EquirectangularReflectionMapping,a.envMap=s}},a.getTexturePathByIndex=function(e){var a="";return y.textures?(y.textures.forEach((function(t){t.index===e&&(a=t.fileName)})),a):a},a.loadTexture=function(e){return e?this.textureLoader.load(e,void 0,void 0,(function(){console.warn("LWOLoader: non-standard resource hierarchy. Use `resourcePath` parameter to specify root content directory.")})):null},a.getWrappingType=function(e){switch(e){case 0:return console.warn('LWOLoader: "Reset" texture wrapping type is not supported in three.js'),t.ClampToEdgeWrapping;case 1:return t.RepeatWrapping;case 2:return t.MirroredRepeatWrapping;case 3:return t.ClampToEdgeWrapping}},a.getMaterialType=function(e){return e.Clearcoat&&e.Clearcoat.value>0?h.MeshPhysicalMaterial:e.Roughness?f.MeshStandardMaterial:c.MeshPhongMaterial},e}(),T=function(){function e(){}var a=e.prototype;return a.parse=function(e,a){var t=new s.BufferGeometry;t.setAttribute("position",new r.Float32BufferAttribute(e.points,3));var i=this.splitIndices(e.vertexIndices,e.polygonDimensions);return t.setIndex(i),this.parseGroups(t,e),t.computeVertexNormals(),this.parseUVs(t,a,i),this.parseMorphTargets(t,a,i),t.translate(-a.pivot[0],-a.pivot[1],-a.pivot[2]),t},a.splitIndices=function(e,a){var t=[],r=0;return a.forEach((function(a){if(a<4)for(var s=0;s<a;s++)t.push(e[r+s]);else if(4===a)t.push(e[r],e[r+1],e[r+2],e[r],e[r+2],e[r+3]);else if(a>4){for(var i=1;i<a-1;i++)t.push(e[r],e[r+i],e[r+i+1]);console.warn("LWOLoader: polygons with greater than 4 sides are not supported")}r+=a})),t},a.parseGroups=function(e,a){var t=y.tags,r=[],s=3;"lines"===a.type&&(s=2),"points"===a.type&&(s=1);for(var i,n,o,u=this.splitMaterialIndices(a.polygonDimensions,a.materialIndices),p=0,l={},c=0,h=0,f=0;f<u.length;f+=2){if(n=u[f+1],0===f&&(r[p]=t[n]),void 0===i&&(i=n),n!==i){var m=void 0;l[t[i]]?m=l[t[i]]:(m=p,l[t[i]]=p,r[p]=t[i],p++),e.addGroup(c,h,m),c+=h,i=n,h=0}h+=s}e.groups.length>0&&(l[t[n]]?o=l[t[n]]:(o=p,l[t[n]]=p,r[p]=t[n]),e.addGroup(c,h,o));e.userData.matNames=r},a.splitMaterialIndices=function(e,a){var t=[];return e.forEach((function(e,r){if(e<=3)t.push(a[2*r],a[2*r+1]);else if(4===e)t.push(a[2*r],a[2*r+1],a[2*r],a[2*r+1]);else for(var s=0;s<e-2;s++)t.push(a[2*r],a[2*r+1])})),t},a.parseUVs=function(e,a){var t=Array.from(Array(2*e.attributes.position.count),(function(){return 0})),s=function(e){var r=a.uvs[e].uvs;a.uvs[e].uvIndices.forEach((function(e,a){t[2*e]=r[2*a],t[2*e+1]=r[2*a+1]}))};for(var i in a.uvs)s(i);e.setAttribute("uv",new r.Float32BufferAttribute(t,2))},a.parseMorphTargets=function(e,a){var t=0,s=function(s){var i=e.attributes.position.array.slice();e.morphAttributes.position||(e.morphAttributes.position=[]);var n=a.morphTargets[s].points,o=a.morphTargets[s].indices,u=a.morphTargets[s].type;o.forEach((function(e,a){"relative"===u?(i[3*e]+=n[3*a],i[3*e+1]+=n[3*a+1],i[3*e+2]+=n[3*a+2]):(i[3*e]=n[3*a],i[3*e+1]=n[3*a+1],i[3*e+2]=n[3*a+2])})),e.morphAttributes.position[t]=new r.Float32BufferAttribute(i,3),e.morphAttributes.position[t].name=s,t++};for(var i in a.morphTargets)s(i);e.morphTargetsRelative=!1},e}();e.LWOLoader=b,Object.defineProperty(e,"__esModule",{value:!0})}));

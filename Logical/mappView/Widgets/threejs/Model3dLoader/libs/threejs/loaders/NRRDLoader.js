/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","./FileLoader","./Loader","../math/Matrix4","../math/Vector3","../libs/fflate.module","../misc/Volume"],(function(r,e,t,n,a,s,i,o){"use strict";var c=function(r){function n(e){return r.call(this,e)||this}e.inheritsLoose(n,r);var c=n.prototype;return c.load=function(r,e,n,a){var s=this,i=new t.FileLoader(s.manager);i.setPath(s.path),i.setResponseType("arraybuffer"),i.setRequestHeader(s.requestHeader),i.setWithCredentials(s.withCredentials),i.load(r,(function(t){try{e(s.parse(t))}catch(e){a?a(e):console.error(e),s.manager.itemError(r)}}),n,a)},c.parse=function(r){var e=r,t=0,n=new Int8Array(new Int16Array([1]).buffer)[0]>0,c={};var h,l=function(r,a){null==a&&(a=1);var s=1,i=Uint8Array;switch(r){case"uchar":break;case"schar":i=Int8Array;break;case"ushort":i=Uint16Array,s=2;break;case"sshort":i=Int16Array,s=2;break;case"uint":i=Uint32Array,s=4;break;case"sint":i=Int32Array,s=4;break;case"float":i=Float32Array,s=4;break;case"complex":case"double":i=Float64Array,s=8}var o=new i(e.slice(t,t+=a*s));return true!=n&&(o=function(r,e){for(var t=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),n=0;n<r.byteLength;n+=e)for(var a=n+e-1,s=n;a>s;a--,s++){var i=t[s];t[s]=t[a],t[a]=i}return r}(o,s)),1==a?o[0]:o}("uchar",r.byteLength),f=l.length,d=null,p=0;for(h=1;h<f;h++)if(10==l[h-1]&&10==l[h]){d=this.parseChars(l,0,h-2),p=h+1;break}if(function(r){var e,t,n,a,s,i,o,h,l=r.split(/\r?\n/);for(o=0,h=l.length;o<h;o++)(s=l[o]).match(/NRRD\d+/)?c.isNrrd=!0:!s.match(/^#/)&&(i=s.match(/(.*):(.*)/))&&(t=i[1].trim(),e=i[2].trim(),(n=u[t])?n.call(c,e):c[t]=e);if(!c.isNrrd)throw new Error("Not an NRRD file");if("bz2"===c.encoding||"bzip2"===c.encoding)throw new Error("Bzip is not supported");if(!c.vectors&&(c.vectors=[],c.vectors.push([1,0,0]),c.vectors.push([0,1,0]),c.vectors.push([0,0,1]),c.spacings))for(a=0;a<=2;a++)if(!isNaN(c.spacings[a]))for(var f=0;f<=2;f++)c.vectors[a][f]*=c.spacings[a]}(d),e=l.subarray(p),"gz"===c.encoding.substring(0,2))e=i.gunzipSync(new Uint8Array(e));else if("ascii"===c.encoding||"text"===c.encoding||"txt"===c.encoding||"hex"===c.encoding)e=function(r,e,t){var n,a="";e=e||0,t=t||r.length;var s=c.sizes.reduce((function(r,e){return r*e}),1),i=10;"hex"===c.encoding&&(i=16);var o=new c.__array(s),u=0,h=parseInt;c.__array!==Float32Array&&c.__array!==Float64Array||(h=parseFloat);for(var l=e;l<t;l++)((n=r[l])<9||n>13)&&32!==n?a+=String.fromCharCode(n):(""!==a&&(o[u]=h(a,i),u++),a="");return""!==a&&(o[u]=h(a,i),u++),o}(e);else if("raw"===c.encoding){for(var y=new Uint8Array(e.length),g=0;g<e.length;g++)y[g]=e[g];e=y}e=e.buffer;var v=new o.Volume;v.header=c,v.data=new c.__array(e);var m=v.computeMinMax(),w=m[0],_=m[1];if(v.windowLow=w,v.windowHigh=_,v.dimensions=[c.sizes[0],c.sizes[1],c.sizes[2]],v.xLength=v.dimensions[0],v.yLength=v.dimensions[1],v.zLength=v.dimensions[2],c.vectors){var b=c.vectors.findIndex((function(r){return 0!==r[0]})),x=c.vectors.findIndex((function(r){return 0!==r[1]})),A=c.vectors.findIndex((function(r){return 0!==r[2]})),k=[];k[b]="x",k[x]="y",k[A]="z",v.axisOrder=k}else v.axisOrder=["x","y","z"];var L=(new s.Vector3).fromArray(c.vectors[0]).length(),z=(new s.Vector3).fromArray(c.vectors[1]).length(),I=(new s.Vector3).fromArray(c.vectors[2]).length();v.spacing=[L,z,I],v.matrix=new a.Matrix4;var M=new a.Matrix4;if("left-posterior-superior"===c.space?M.set(-1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1):"left-anterior-superior"===c.space&&M.set(1,0,0,0,0,1,0,0,0,0,-1,0,0,0,0,1),c.vectors){var F=c.vectors,R=(new a.Matrix4).set(F[0][0],F[1][0],F[2][0],0,F[0][1],F[1][1],F[2][1],0,F[0][2],F[1][2],F[2][2],0,0,0,0,1),U=(new a.Matrix4).multiplyMatrices(R,M);v.matrix=U}else v.matrix.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return v.inverseMatrix=new a.Matrix4,v.inverseMatrix.copy(v.matrix).invert(),v.RASDimensions=new s.Vector3(v.xLength,v.yLength,v.zLength).applyMatrix4(v.matrix).round().toArray().map(Math.abs),v.lowerThreshold===-1/0&&(v.lowerThreshold=w),v.upperThreshold===1/0&&(v.upperThreshold=_),v},c.parseChars=function(r,e,t){void 0===e&&(e=0),void 0===t&&(t=r.length);var n="",a=0;for(a=e;a<t;++a)n+=String.fromCharCode(r[a]);return n},n}(n.Loader),u={type:function(r){switch(r){case"uchar":case"unsigned char":case"uint8":case"uint8_t":this.__array=Uint8Array;break;case"signed char":case"int8":case"int8_t":this.__array=Int8Array;break;case"short":case"short int":case"signed short":case"signed short int":case"int16":case"int16_t":this.__array=Int16Array;break;case"ushort":case"unsigned short":case"unsigned short int":case"uint16":case"uint16_t":this.__array=Uint16Array;break;case"int":case"signed int":case"int32":case"int32_t":this.__array=Int32Array;break;case"uint":case"unsigned int":case"uint32":case"uint32_t":this.__array=Uint32Array;break;case"float":this.__array=Float32Array;break;case"double":this.__array=Float64Array;break;default:throw new Error("Unsupported NRRD data type: "+r)}return this.type=r},endian:function(r){return this.endian=r},encoding:function(r){return this.encoding=r},dimension:function(r){return this.dim=parseInt(r,10)},sizes:function(r){var e;return this.sizes=function(){for(var t=r.split(/\s+/),n=[],a=0,s=t.length;a<s;a++)e=t[a],n.push(parseInt(e,10));return n}()},space:function(r){return this.space=r},"space origin":function(r){return this.space_origin=r.split("(")[1].split(")")[0].split(",")},"space directions":function(r){var e,t,n=r.match(/\(.*?\)/g);return this.vectors=function(){for(var r=[],a=0,s=n.length;a<s;a++)t=n[a],r.push(function(){for(var r=t.slice(1,-1).split(/,/),n=[],a=0,s=r.length;a<s;a++)e=r[a],n.push(parseFloat(e));return n}());return r}()},spacings:function(r){var e,t=r.split(/\s+/);return this.spacings=function(){for(var r=[],n=0,a=t.length;n<a;n++)e=t[n],r.push(parseFloat(e));return r}()}};r.NRRDLoader=c,Object.defineProperty(r,"__esModule",{value:!0})}));

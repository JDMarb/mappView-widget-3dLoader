/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","../constants","../core/BufferGeometry","../math/Color","./FileLoader","../objects/Group","../core/BufferAttribute","./Loader","./LoaderUtils","../math/Matrix4","../objects/Mesh","../materials/MeshPhongMaterial","./TextureLoader"],(function(e,t,s,a,r,i,n,d,o,h,u,g,l,f){"use strict";var c=function(e){function o(t){var s;return(s=e.call(this,t)||this).debug=!1,s.group=null,s.materials=[],s.meshes=[],s}t.inheritsLoose(o,e);var c=o.prototype;return c.load=function(e,t,s,a){var r=this,n=""===this.path?h.LoaderUtils.extractUrlBase(e):this.path,d=new i.FileLoader(this.manager);d.setPath(this.path),d.setResponseType("arraybuffer"),d.setRequestHeader(this.requestHeader),d.setWithCredentials(this.withCredentials),d.load(e,(function(s){try{t(r.parse(s,n))}catch(t){a?a(t):console.error(t),r.manager.itemError(e)}}),s,a)},c.parse=function(e,t){this.group=new n.Group,this.materials=[],this.meshes=[],this.readFile(e,t);for(var s=0;s<this.meshes.length;s++)this.group.add(this.meshes[s]);return this.group},c.readFile=function(e,t){var s=new DataView(e),a=new p(s,0,this.debugMessage);if(a.id===b||a.id===m||a.id===M)for(var r=a.readChunk();r;){if(r.id===v){var i=r.readDWord();this.debugMessage("3DS file version: "+i)}else r.id===B?this.readMeshData(r,t):this.debugMessage("Unknown main chunk: "+r.hexId);r=a.readChunk()}this.debugMessage("Parsed "+this.meshes.length+" meshes")},c.readMeshData=function(e,t){for(var s=e.readChunk();s;){if(s.id===W){var a=+s.readDWord();this.debugMessage("Mesh Version: "+a)}else if(s.id===U){var r=s.readFloat();this.debugMessage("Master scale: "+r),this.group.scale.set(r,r,r)}else s.id===J?(this.debugMessage("Named Object"),this.readNamedObject(s)):s.id===S?(this.debugMessage("Material"),this.readMaterialEntry(s,t)):this.debugMessage("Unknown MDATA chunk: "+s.hexId);s=e.readChunk()}},c.readNamedObject=function(e){for(var t=e.readString(),s=e.readChunk();s;){if(s.id===K){var a=this.readMesh(s);a.name=t,this.meshes.push(a)}else this.debugMessage("Unknown named object chunk: "+s.hexId);s=e.readChunk()}},c.readMaterialEntry=function(e,t){for(var a=e.readChunk(),r=new l.MeshPhongMaterial;a;){if(a.id===A)r.name=a.readString(),this.debugMessage("\t Name: "+r.name);else if(a.id===j)this.debugMessage("\t Wireframe"),r.wireframe=!0;else if(a.id===N){var i=a.readByte();r.wireframeLinewidth=i,this.debugMessage("\t Wireframe Thickness: "+i)}else if(a.id===G)r.side=s.DoubleSide,this.debugMessage("\t DoubleSided");else if(a.id===T)this.debugMessage("\t Additive Blending"),r.blending=s.AdditiveBlending;else if(a.id===I)this.debugMessage("\t Diffuse Color"),r.color=this.readColor(a);else if(a.id===O)this.debugMessage("\t Specular Color"),r.specular=this.readColor(a);else if(a.id===D)this.debugMessage("\t Ambient color"),r.color=this.readColor(a);else if(a.id===L){var n=this.readPercentage(a);r.shininess=100*n,this.debugMessage("\t Shininess : "+n)}else if(a.id===P){var d=this.readPercentage(a);r.opacity=1-d,this.debugMessage("\tTransparency : "+d),r.transparent=r.opacity<1}else a.id===R?(this.debugMessage("\t ColorMap"),r.map=this.readMap(a,t)):a.id===z?(this.debugMessage("\t BumpMap"),r.bumpMap=this.readMap(a,t)):a.id===V?(this.debugMessage("\t OpacityMap"),r.alphaMap=this.readMap(a,t)):a.id===_?(this.debugMessage("\t SpecularMap"),r.specularMap=this.readMap(a,t)):this.debugMessage("\t Unknown material chunk: "+a.hexId);a=e.readChunk()}this.materials[r.name]=r},c.readMesh=function(e){var t=e.readChunk(),s=new a.BufferGeometry,r=new l.MeshPhongMaterial,i=new g.Mesh(s,r);for(i.name="mesh";t;){if(t.id===Q){var n=t.readWord();this.debugMessage("\t Vertex: "+n);for(var o=[],h=0;h<n;h++)o.push(t.readFloat()),o.push(t.readFloat()),o.push(t.readFloat());s.setAttribute("position",new d.Float32BufferAttribute(o,3))}else if(t.id===Z)this.readFaceArray(t,i);else if(t.id===ee){var f=t.readWord();this.debugMessage("\t UV: "+f);for(var c=[],p=0;p<f;p++)c.push(t.readFloat()),c.push(t.readFloat());s.setAttribute("uv",new d.Float32BufferAttribute(c,2))}else if(t.id===te){this.debugMessage("\t Tranformation Matrix (TODO)");for(var M=[],b=0;b<12;b++)M[b]=t.readFloat();var m=new u.Matrix4;m.elements[0]=M[0],m.elements[1]=M[6],m.elements[2]=M[3],m.elements[3]=M[9],m.elements[4]=M[2],m.elements[5]=M[8],m.elements[6]=M[5],m.elements[7]=M[11],m.elements[8]=M[1],m.elements[9]=M[7],m.elements[10]=M[4],m.elements[11]=M[10],m.elements[12]=0,m.elements[13]=0,m.elements[14]=0,m.elements[15]=1,m.transpose();var v=new u.Matrix4;v.copy(m).invert(),s.applyMatrix4(v),m.decompose(i.position,i.quaternion,i.scale)}else this.debugMessage("\t Unknown mesh chunk: "+t.hexId);t=e.readChunk()}return s.computeVertexNormals(),i},c.readFaceArray=function(e,t){var s=e.readWord();this.debugMessage("\t Faces: "+s);for(var a=[],r=0;r<s;++r)a.push(e.readWord(),e.readWord(),e.readWord()),e.readWord();t.geometry.setIndex(a);for(var i=0,n=0;!e.endOfChunk;){var d=e.readChunk();if(d.id===$){this.debugMessage("\t\t\tMaterial Group");var o=this.readMaterialGroup(d),h=3*o.index.length;t.geometry.addGroup(n,h,i),n+=h,i++;var u=this.materials[o.name];!1===Array.isArray(t.material)&&(t.material=[]),void 0!==u&&t.material.push(u)}else this.debugMessage("\t\t\tUnknown face array chunk: "+d.hexId)}1===t.material.length&&(t.material=t.material[0])},c.readMap=function(e,t){var s=e.readChunk(),a={},r=new f.TextureLoader(this.manager);for(r.setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);s;){if(s.id===q){var i=s.readString();a=r.load(i),this.debugMessage("\t\t\tFile: "+t+i)}else s.id===X?(a.offset.x=s.readFloat(),this.debugMessage("\t\t\tOffsetX: "+a.offset.x)):s.id===Y?(a.offset.y=s.readFloat(),this.debugMessage("\t\t\tOffsetY: "+a.offset.y)):s.id===E?(a.repeat.x=s.readFloat(),this.debugMessage("\t\t\tRepeatX: "+a.repeat.x)):s.id===H?(a.repeat.y=s.readFloat(),this.debugMessage("\t\t\tRepeatY: "+a.repeat.y)):this.debugMessage("\t\t\tUnknown map chunk: "+s.hexId);s=e.readChunk()}return a},c.readMaterialGroup=function(e){var t=e.readString(),s=e.readWord();this.debugMessage("\t\t\t\t Name: "+t),this.debugMessage("\t\t\t\t Faces: "+s);for(var a=[],r=0;r<s;++r)a.push(e.readWord());return{name:t,index:a}},c.readColor=function(e){var t=e.readChunk(),s=new r.Color;if(t.id===y||t.id===C){var a=t.readByte(),i=t.readByte(),n=t.readByte();s.setRGB(a/255,i/255,n/255),this.debugMessage("\t\t\tColor: "+s.r+", "+s.g+", "+s.b)}else if(t.id===k||t.id===w){var d=t.readFloat(),o=t.readFloat(),h=t.readFloat();s.setRGB(d,o,h),this.debugMessage("\t\t\tColor: "+s.r+", "+s.g+", "+s.b)}else this.debugMessage("\t\t\tUnknown color chunk: "+t.hexId);return s},c.readPercentage=function(e){var t=e.readChunk();switch(t.id){case F:return t.readShort()/100;case x:return t.readFloat();default:return this.debugMessage("\t\t\tUnknown percentage chunk: "+t.hexId),0}},c.debugMessage=function(e){this.debug&&console.log(e)},o}(o.Loader),p=function(){function e(e,t,s){this.data=e,this.offset=t,this.position=t,this.debugMessage=s,this.debugMessage instanceof Function&&(this.debugMessage=function(){}),this.id=this.readWord(),this.size=this.readDWord(),this.end=this.offset+this.size,this.end>e.byteLength&&this.debugMessage("Bad chunk size for chunk at "+t)}var s=e.prototype;return s.readChunk=function(){if(this.endOfChunk)return null;try{var t=new e(this.data,this.position,this.debugMessage);return this.position+=t.size,t}catch(e){return this.debugMessage("Unable to read chunk at "+this.position),null}},s.readByte=function(){var e=this.data.getUint8(this.position,!0);return this.position+=1,e},s.readFloat=function(){try{var e=this.data.getFloat32(this.position,!0);return this.position+=4,e}catch(e){return this.debugMessage(e+" "+this.position+" "+this.data.byteLength),0}},s.readInt=function(){var e=this.data.getInt32(this.position,!0);return this.position+=4,e},s.readShort=function(){var e=this.data.getInt16(this.position,!0);return this.position+=2,e},s.readDWord=function(){var e=this.data.getUint32(this.position,!0);return this.position+=4,e},s.readWord=function(){var e=this.data.getUint16(this.position,!0);return this.position+=2,e},s.readString=function(){for(var e="",t=this.readByte();t;)e+=String.fromCharCode(t),t=this.readByte();return e},t.createClass(e,[{key:"hexId",get:function(){return this.id.toString(16)}},{key:"endOfChunk",get:function(){return this.position>=this.end}}]),e}(),M=19789,b=15786,m=49725,v=2,k=16,y=17,C=18,w=19,F=48,x=49,B=15677,W=15678,U=256,S=45055,A=40960,D=40976,I=40992,O=41008,L=41024,P=41040,G=41089,T=41091,j=41093,N=41095,R=41472,V=41488,z=41520,_=41476,q=41728,E=41812,H=41814,X=41816,Y=41818,J=16384,K=16640,Q=16656,Z=16672,$=16688,ee=16704,te=16736;e.TDSLoader=c,Object.defineProperty(e,"__esModule",{value:!0})}));

/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","../constants","../animation/AnimationClip","../objects/Bone","../core/BufferGeometry","../math/Color","../math/Euler","./FileLoader","../core/BufferAttribute","../math/Interpolant","./Loader","./LoaderUtils","../renderers/shaders/UniformsUtils","../materials/ShaderMaterial","../animation/tracks/NumberKeyframeTrack","../math/Quaternion","../animation/tracks/QuaternionKeyframeTrack","../objects/Skeleton","../objects/SkinnedMesh","./TextureLoader","../math/Vector3","../animation/tracks/VectorKeyframeTrack","../shaders/MMDToonShader","./TGALoader","../libs/mmdparser.module"],(function(e,t,a,r,n,i,o,s,A,l,u,h,d,p,m,f,c,g,v,C,y,b,B,x,M,T){"use strict";var I=function(e){function a(t){var a;return(a=e.call(this,t)||this).loader=new A.FileLoader(a.manager),a.parser=null,a.meshBuilder=new E(a.manager),a.animationBuilder=new Q,a}t.inheritsLoose(a,e);var r=a.prototype;return r.setAnimationPath=function(e){return this.animationPath=e,this},r.load=function(e,t,a,r){var n,i=this.meshBuilder.setCrossOrigin(this.crossOrigin);n=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:d.LoaderUtils.extractUrlBase(e);var o=this._extractExtension(e).toLowerCase();"pmd"===o||"pmx"===o?this["pmd"===o?"loadPMD":"loadPMX"](e,(function(e){t(i.build(e,n,a,r))}),a,r):r&&r(new Error("THREE.MMDLoader: Unknown model file extension ."+o+"."))},r.loadAnimation=function(e,t,a,r,n){var i=this.animationBuilder;this.loadVMD(e,(function(e){a(t.isCamera?i.buildCameraAnimation(e):i.build(e,t))}),r,n)},r.loadWithAnimation=function(e,t,a,r,n){var i=this;this.load(e,(function(e){i.loadAnimation(t,e,(function(t){a({mesh:e,animation:t})}),r,n)}),r,n)},r.loadPMD=function(e,t,a,r){var n=this._getParser();this.loader.setMimeType(void 0).setPath(this.path).setResponseType("arraybuffer").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(e,(function(e){t(n.parsePmd(e,!0))}),a,r)},r.loadPMX=function(e,t,a,r){var n=this._getParser();this.loader.setMimeType(void 0).setPath(this.path).setResponseType("arraybuffer").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(e,(function(e){t(n.parsePmx(e,!0))}),a,r)},r.loadVMD=function(e,t,a,r){var n=Array.isArray(e)?e:[e],i=[],o=n.length,s=this._getParser();this.loader.setMimeType(void 0).setPath(this.animationPath).setResponseType("arraybuffer").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials);for(var A=0,l=n.length;A<l;A++)this.loader.load(n[A],(function(e){i.push(s.parseVmd(e,!0)),i.length===o&&t(s.mergeVmds(i))}),a,r)},r.loadVPD=function(e,t,a,r,n){var i=this._getParser();this.loader.setMimeType(t?void 0:"text/plain; charset=shift_jis").setPath(this.animationPath).setResponseType("text").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(e,(function(e){a(i.parseVpd(e,!0))}),r,n)},r._extractExtension=function(e){var t=e.lastIndexOf(".");return t<0?"":e.slice(t+1)},r._getParser=function(){if(null===this.parser){if(void 0===T.MMDParser)throw new Error("THREE.MMDLoader: Import MMDParser https://github.com/takahirox/mmd-parser");this.parser=new T.MMDParser.Parser}return this.parser},a}(h.Loader),w=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="],R=[a.RGB_S3TC_DXT1_Format,a.RGB_PVRTC_4BPPV1_Format,a.RGB_PVRTC_2BPPV1_Format,a.RGB_ETC1_Format,a.RGB_ETC2_Format],E=function(){function e(e){this.crossOrigin="anonymous",this.geometryBuilder=new k,this.materialBuilder=new P(e)}var t=e.prototype;return t.setCrossOrigin=function(e){return this.crossOrigin=e,this},t.build=function(e,t,a,r){var i=this.geometryBuilder.build(e),o=this.materialBuilder.setCrossOrigin(this.crossOrigin).setResourcePath(t).build(e,i,a,r),s=new C.SkinnedMesh(i,o),A=new v.Skeleton(function(e){var t=e.geometry,a=[];if(t&&void 0!==t.bones){for(var r=0,i=t.bones.length;r<i;r++){var o=t.bones[r],s=new n.Bone;a.push(s),s.name=o.name,s.position.fromArray(o.pos),s.quaternion.fromArray(o.rotq),void 0!==o.scl&&s.scale.fromArray(o.scl)}for(var A=0,l=t.bones.length;A<l;A++){var u=t.bones[A];-1!==u.parent&&null!==u.parent&&void 0!==a[u.parent]?a[u.parent].add(a[A]):e.add(a[A])}}return e.updateMatrixWorld(!0),a}(s));return s.bind(A),s},e}();var k=function(){function e(){}return e.prototype.build=function(e){for(var t=[],a=[],r=[],n=[],o=[],s=[],A=[],u=[],h=[],d=[],p=[],m=[],f=[],c=[],g=0,v={},C=0;C<e.metadata.vertexCount;C++){for(var y=e.vertices[C],B=0,x=y.position.length;B<x;B++)t.push(y.position[B]);for(var M=0,T=y.normal.length;M<T;M++)r.push(y.normal[M]);for(var I=0,w=y.uv.length;I<w;I++)a.push(y.uv[I]);for(var R=0;R<4;R++)A.push(y.skinIndices.length-1>=R?y.skinIndices[R]:0);for(var E=0;E<4;E++)u.push(y.skinWeights.length-1>=E?y.skinWeights[E]:0)}for(var k=0;k<e.metadata.faceCount;k++)for(var P=e.faces[k],Q=0,L=P.indices.length;Q<L;Q++)n.push(P.indices[Q]);for(var S=0;S<e.metadata.materialCount;S++){var D=e.materials[S];o.push({offset:3*g,count:3*D.faceCount}),g+=D.faceCount}for(var U=0;U<e.metadata.rigidBodyCount;U++){var O=e.rigidBodies[U],V=v[O.boneIndex];V=void 0===V?O.type:Math.max(O.type,V),v[O.boneIndex]=V}for(var N=0;N<e.metadata.boneCount;N++){var _=e.bones[N],F={index:N,transformationClass:_.transformationClass,parent:_.parentIndex,name:_.name,pos:_.position.slice(0,3),rotq:[0,0,0,1],scl:[1,1,1],rigidBodyType:void 0!==v[N]?v[N]:-1};-1!==F.parent&&(F.pos[0]-=e.bones[F.parent].position[0],F.pos[1]-=e.bones[F.parent].position[1],F.pos[2]-=e.bones[F.parent].position[2]),s.push(F)}if("pmd"===e.metadata.format)for(var z=0;z<e.metadata.ikCount;z++){for(var Y=e.iks[z],K={target:Y.target,effector:Y.effector,iteration:Y.iteration,maxAngle:4*Y.maxAngle,links:[]},G=0,W=Y.links.length;G<W;G++){var j={};j.index=Y.links[G].index,j.enabled=!0,e.bones[j.index].name.indexOf("ひざ")>=0&&(j.limitation=new b.Vector3(1,0,0)),K.links.push(j)}p.push(K)}else for(var H=0;H<e.metadata.boneCount;H++){var J=e.bones[H].ik;if(void 0!==J){for(var X={target:H,effector:J.effector,iteration:J.iteration,maxAngle:J.maxAngle,links:[]},q=0,Z=J.links.length;q<Z;q++){var $={};if($.index=J.links[q].index,$.enabled=!0,1===J.links[q].angleLimitation){var ee=J.links[q].lowerLimitationAngle,te=J.links[q].upperLimitationAngle,ae=-te[0],re=-te[1];te[0]=-ee[0],te[1]=-ee[1],ee[0]=ae,ee[1]=re,$.rotationMin=(new b.Vector3).fromArray(ee),$.rotationMax=(new b.Vector3).fromArray(te)}X.links.push($)}p.push(X),s[H].ik=X}}if("pmx"===e.metadata.format){for(var ne={},ie=0;ie<e.metadata.boneCount;ie++){var oe=e.bones[ie],se=oe.grant;if(void 0!==se){var Ae={index:ie,parentIndex:se.parentIndex,ratio:se.ratio,isLocal:se.isLocal,affectRotation:se.affectRotation,affectPosition:se.affectPosition,transformationClass:oe.transformationClass};ne[ie]={parent:null,children:[],param:Ae,visited:!1}}}var le={parent:null,children:[],param:null,visited:!1};for(var ue in ne){var he=ne[ue],de=ne[he.parentIndex]||le;he.parent=de,de.children.push(he)}!function e(t){t.param&&(m.push(t.param),s[t.param.index].grant=t.param),t.visited=!0;for(var a=0,r=t.children.length;a<r;a++){var n=t.children[a];n.visited||e(n)}}(le)}function pe(t,a,r){for(var n=0;n<a.elementCount;n++){var i=a.elements[n],o=void 0;o="pmd"===e.metadata.format?e.morphs[0].elements[i.index].index:i.index,t.array[3*o+0]+=i.position[0]*r,t.array[3*o+1]+=i.position[1]*r,t.array[3*o+2]+=i.position[2]*r}}for(var me=0;me<e.metadata.morphCount;me++){var fe=e.morphs[me],ce={name:fe.name},ge=new l.Float32BufferAttribute(3*e.metadata.vertexCount,3);ge.name=fe.name;for(var ve=0;ve<3*e.metadata.vertexCount;ve++)ge.array[ve]=t[ve];if("pmd"===e.metadata.format)0!==me&&pe(ge,fe,1);else if(0===fe.type)for(var Ce=0;Ce<fe.elementCount;Ce++){var ye=e.morphs[fe.elements[Ce].index],be=fe.elements[Ce].ratio;1===ye.type&&pe(ge,ye,be)}else 1===fe.type?pe(ge,fe,1):2===fe.type||3===fe.type||4===fe.type||5===fe.type||6===fe.type||7===fe.type||fe.type;h.push(ce),d.push(ge)}for(var Be=0;Be<e.metadata.rigidBodyCount;Be++){var xe=e.rigidBodies[Be],Me={};for(var Te in xe)Me[Te]=xe[Te];if("pmx"===e.metadata.format&&-1!==Me.boneIndex){var Ie=e.bones[Me.boneIndex];Me.position[0]-=Ie.position[0],Me.position[1]-=Ie.position[1],Me.position[2]-=Ie.position[2]}f.push(Me)}for(var we=0;we<e.metadata.constraintCount;we++){var Re=e.constraints[we],Ee={};for(var ke in Re)Ee[ke]=Re[ke];var Pe=f[Ee.rigidBodyIndex1],Qe=f[Ee.rigidBodyIndex2];0!==Pe.type&&2===Qe.type&&-1!==Pe.boneIndex&&-1!==Qe.boneIndex&&e.bones[Qe.boneIndex].parentIndex===Pe.boneIndex&&(Qe.type=1),c.push(Ee)}var Le=new i.BufferGeometry;Le.setAttribute("position",new l.Float32BufferAttribute(t,3)),Le.setAttribute("normal",new l.Float32BufferAttribute(r,3)),Le.setAttribute("uv",new l.Float32BufferAttribute(a,2)),Le.setAttribute("skinIndex",new l.Uint16BufferAttribute(A,4)),Le.setAttribute("skinWeight",new l.Float32BufferAttribute(u,4)),Le.setIndex(n);for(var Se=0,De=o.length;Se<De;Se++)Le.addGroup(o[Se].offset,o[Se].count,Se);return Le.bones=s,Le.morphTargets=h,Le.morphAttributes.position=d,Le.morphTargetsRelative=!1,Le.userData.MMD={bones:s,iks:p,grants:m,rigidBodies:f,constraints:c,format:e.metadata.format},Le.computeBoundingSphere(),Le},e}(),P=function(){function e(e){this.manager=e,this.textureLoader=new y.TextureLoader(this.manager),this.tgaLoader=null,this.crossOrigin="anonymous",this.resourcePath=void 0}var t=e.prototype;return t.setCrossOrigin=function(e){return this.crossOrigin=e,this},t.setResourcePath=function(e){return this.resourcePath=e,this},t.build=function(e,t){var r=[],n={};this.textureLoader.setCrossOrigin(this.crossOrigin);for(var i=0;i<e.metadata.materialCount;i++){var s=e.materials[i],A={userData:{MMD:{}}};if(void 0!==s.name&&(A.name=s.name),A.diffuse=(new o.Color).fromArray(s.diffuse),A.opacity=s.diffuse[3],A.specular=(new o.Color).fromArray(s.specular),A.shininess=s.shininess,A.emissive=(new o.Color).fromArray(s.ambient),A.transparent=1!==A.opacity,A.fog=!0,A.blending=a.CustomBlending,A.blendSrc=a.SrcAlphaFactor,A.blendDst=a.OneMinusSrcAlphaFactor,A.blendSrcAlpha=a.SrcAlphaFactor,A.blendDstAlpha=a.DstAlphaFactor,"pmx"===e.metadata.format&&1==(1&s.flag)?A.side=a.DoubleSide:A.side=1===A.opacity?a.FrontSide:a.DoubleSide,"pmd"===e.metadata.format){if(s.fileName){var l=s.fileName.split("*");if(A.map=this._loadTexture(l[0],n),l.length>1){var u=l[1].slice(-4).toLowerCase();A.envMap=this._loadTexture(l[1],n),A.combine=".sph"===u?a.MultiplyOperation:a.AddOperation}}var h=-1===s.toonIndex?"toon00.bmp":e.toonTextures[s.toonIndex].fileName;A.gradientMap=this._loadTexture(h,n,{isToonTexture:!0,isDefaultToonTexture:this._isDefaultToonTexture(h)}),A.userData.outlineParameters={thickness:1===s.edgeFlag?.003:0,color:[0,0,0],alpha:1,visible:1===s.edgeFlag}}else{-1!==s.textureIndex&&(A.map=this._loadTexture(e.textures[s.textureIndex],n),A.userData.MMD.mapFileName=e.textures[s.textureIndex]),-1===s.envTextureIndex||1!==s.envFlag&&2!=s.envFlag||(A.matcap=this._loadTexture(e.textures[s.envTextureIndex],n),A.userData.MMD.matcapFileName=e.textures[s.envTextureIndex],A.matcapCombine=1===s.envFlag?a.MultiplyOperation:a.AddOperation);var d=void 0,p=void 0;-1===s.toonIndex||0!==s.toonFlag?(d="toon"+("0"+(s.toonIndex+1)).slice(-2)+".bmp",p=!0):(d=e.textures[s.toonIndex],p=!1),A.gradientMap=this._loadTexture(d,n,{isToonTexture:!0,isDefaultToonTexture:p}),A.userData.outlineParameters={thickness:s.edgeSize/300,color:s.edgeColor.slice(0,3),alpha:s.edgeColor[3],visible:0!=(16&s.flag)&&s.edgeSize>0}}void 0!==A.map&&(A.transparent||this._checkImageTransparency(A.map,t,i),A.emissive.multiplyScalar(.2)),r.push(new S(A))}if("pmx"===e.metadata.format)for(var m=function(e,t){for(var a=0,r=e.length;a<r;a++){var n=e[a];if(-1!==n.index){var i=t[n.index];i.opacity!==n.diffuse[3]&&(i.transparent=!0)}}},f=0,c=e.morphs.length;f<c;f++){var g=e.morphs[f],v=g.elements;if(0===g.type)for(var C=0,y=v.length;C<y;C++){var b=e.morphs[v[C].index];8===b.type&&m(b.elements,r)}else 8===g.type&&m(v,r)}return r},t._getTGALoader=function(){if(null===this.tgaLoader){if(void 0===M.TGALoader)throw new Error("THREE.MMDLoader: Import TGALoader");this.tgaLoader=new M.TGALoader(this.manager)}return this.tgaLoader},t._isDefaultToonTexture=function(e){return 10===e.length&&/toon(10|0[0-9])\.bmp/.test(e)},t._loadTexture=function(e,t,r,n,i){var o,s=this;if(!0===(r=r||{}).isDefaultToonTexture){var A;try{A=parseInt(e.match(/toon([0-9]{2})\.bmp$/)[1])}catch(t){console.warn("THREE.MMDLoader: "+e+" seems like a not right default texture path. Using toon00.bmp instead."),A=0}o=w[A]}else o=this.resourcePath+e;if(void 0!==t[o])return t[o];var l=this.manager.getHandler(o);null===l&&(l=".tga"===e.slice(-4).toLowerCase()?this._getTGALoader():this.textureLoader);var u=l.load(o,(function(e){!0===r.isToonTexture&&(e.image=s._getRotatedImage(e.image),e.magFilter=a.NearestFilter,e.minFilter=a.NearestFilter),e.flipY=!1,e.wrapS=a.RepeatWrapping,e.wrapT=a.RepeatWrapping;for(var t=0;t<u.readyCallbacks.length;t++)u.readyCallbacks[t](u);delete u.readyCallbacks}),n,i);return u.readyCallbacks=[],t[o]=u,u},t._getRotatedImage=function(e){var t=document.createElement("canvas"),a=t.getContext("2d"),r=e.width,n=e.height;return t.width=r,t.height=n,a.clearRect(0,0,r,n),a.translate(r/2,n/2),a.rotate(.5*Math.PI),a.translate(-r/2,-n/2),a.drawImage(e,0,0),a.getImageData(0,0,r,n)},t._checkImageTransparency=function(e,t,a){e.readyCallbacks.push((function(r){function n(e,t){var a=e.width,r=e.height,n=Math.round(t.x*a)%a,i=Math.round(t.y*r)%r;n<0&&(n+=a),i<0&&(i+=r);var o=i*a+n;return e.data[4*o+3]}if(!0!==r.isCompressedTexture){var i=void 0!==r.image.data?r.image:function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var a=t.getContext("2d");return a.drawImage(e,0,0),a.getImageData(0,0,t.width,t.height)}(r.image),o=t.groups[a];(function(e,t,a){var r=e.width,i=e.height;if(e.data.length/(r*i)!=4)return!1;for(var o=0;o<a.length;o+=3){for(var s={x:0,y:0},A=0;A<3;A++){var l=a[3*o+A],u={x:t[2*l+0],y:t[2*l+1]};if(n(e,u)<253)return!0;s.x+=u.x,s.y+=u.y}if(s.x/=3,s.y/=3,n(e,s)<253)return!0}return!1})(i,t.attributes.uv.array,t.index.array.slice(o.start,o.start+o.count))&&(e.transparent=!0)}else R.includes(r.format)?e.transparent=!1:e.transparent=!0}))},e}(),Q=function(){function e(){}var t=e.prototype;return t.build=function(e,t){for(var a=this.buildSkeletalAnimation(e,t).tracks,n=this.buildMorphAnimation(e,t).tracks,i=0,o=n.length;i<o;i++)a.push(n[i]);return new r.AnimationClip("",-1,a)},t.buildSkeletalAnimation=function(e,t){function a(e,t,a){e.push(t[a+0]/127),e.push(t[a+8]/127),e.push(t[a+4]/127),e.push(t[a+12]/127)}for(var n=[],i={},o=t.skeleton.bones,s={},A=0,l=o.length;A<l;A++)s[o[A].name]=!0;for(var u=0;u<e.metadata.motionCount;u++){var h=e.motions[u],d=h.boneName;void 0!==s[d]&&(i[d]=i[d]||[],i[d].push(h))}for(var p in i){var m=i[p];m.sort((function(e,t){return e.frameNum-t.frameNum}));for(var f=[],c=[],v=[],C=[],y=[],b=t.skeleton.getBoneByName(p).position.toArray(),x=0,M=m.length;x<M;x++){var T=m[x].frameNum/30,I=m[x].position,w=m[x].rotation,R=m[x].interpolation;f.push(T);for(var E=0;E<3;E++)c.push(b[E]+I[E]);for(var k=0;k<4;k++)v.push(w[k]);for(var P=0;P<3;P++)a(C,R,P);a(y,R,3)}var Q=".bones["+p+"]";n.push(this._createTrack(Q+".position",B.VectorKeyframeTrack,f,c,C)),n.push(this._createTrack(Q+".quaternion",g.QuaternionKeyframeTrack,f,v,y))}return new r.AnimationClip("",-1,n)},t.buildMorphAnimation=function(e,t){for(var a=[],n={},i=t.morphTargetDictionary,o=0;o<e.metadata.morphCount;o++){var s=e.morphs[o],A=s.morphName;void 0!==i[A]&&(n[A]=n[A]||[],n[A].push(s))}for(var l in n){var u=n[l];u.sort((function(e,t){return e.frameNum-t.frameNum}));for(var h=[],d=[],p=0,m=u.length;p<m;p++)h.push(u[p].frameNum/30),d.push(u[p].weight);a.push(new f.NumberKeyframeTrack(".morphTargetInfluences["+i[l]+"]",h,d))}return new r.AnimationClip("",-1,a)},t.buildCameraAnimation=function(e){function t(e,t){e.push(t.x),e.push(t.y),e.push(t.z)}function a(e,t,a){e.push(t[4*a+0]/127),e.push(t[4*a+1]/127),e.push(t[4*a+2]/127),e.push(t[4*a+3]/127)}var n=void 0===e.cameras?[]:e.cameras.slice();n.sort((function(e,t){return e.frameNum-t.frameNum}));for(var i,o,A=[],l=[],u=[],h=[],d=[],p=[],m=[],v=[],C=[],y=new c.Quaternion,x=new s.Euler,M=new b.Vector3,T=new b.Vector3,I=0,w=n.length;I<w;I++){var R=n[I],E=R.frameNum/30,k=R.position,P=R.rotation,Q=R.distance,L=R.fov,S=R.interpolation;A.push(E),M.set(0,0,-Q),T.set(k[0],k[1],k[2]),x.set(-P[0],-P[1],-P[2]),y.setFromEuler(x),M.add(T),M.applyQuaternion(y),t(l,T),(i=u).push((o=y).x),i.push(o.y),i.push(o.z),i.push(o.w),t(h,M),d.push(L);for(var D=0;D<3;D++)a(p,S,D);a(m,S,3);for(var U=0;U<3;U++)a(v,S,4);a(C,S,5)}var O=[];return O.push(this._createTrack("target.position",B.VectorKeyframeTrack,A,l,p)),O.push(this._createTrack(".quaternion",g.QuaternionKeyframeTrack,A,u,m)),O.push(this._createTrack(".position",B.VectorKeyframeTrack,A,h,v)),O.push(this._createTrack(".fov",f.NumberKeyframeTrack,A,d,C)),new r.AnimationClip("",-1,O)},t._createTrack=function(e,t,a,r,n){if(a.length>2){a=a.slice(),r=r.slice(),n=n.slice();for(var i=r.length/a.length,o=n.length/a.length,s=1,A=2,l=a.length;A<l;A++){for(var u=0;u<i;u++)if(r[s*i+u]!==r[(s-1)*i+u]||r[s*i+u]!==r[A*i+u]){s++;break}if(A>s){a[s]=a[A];for(var h=0;h<i;h++)r[s*i+h]=r[A*i+h];for(var d=0;d<o;d++)n[s*o+d]=n[A*o+d]}}a.length=s+1,r.length=(s+1)*i,n.length=(s+1)*o}var p=new t(e,a,r);return p.createInterpolant=function(e){return new L(this.times,this.values,this.getValueSize(),e,new Float32Array(n))},p},e}(),L=function(e){function a(t,a,r,n,i){var o;return(o=e.call(this,t,a,r,n)||this).interpolationParams=i,o}t.inheritsLoose(a,e);var r=a.prototype;return r.interpolate_=function(e,t,a,r){var n=this.resultBuffer,i=this.sampleValues,o=this.valueSize,s=this.interpolationParams,A=e*o,l=A-o,u=r-t<.05?0:(a-t)/(r-t);if(4===o){var h=s[4*e+0],d=s[4*e+1],p=s[4*e+2],m=s[4*e+3],f=this._calculate(h,d,p,m,u);c.Quaternion.slerpFlat(n,0,i,l,i,A,f)}else if(3===o)for(var g=0;g!==o;++g){var v=s[12*e+4*g+0],C=s[12*e+4*g+1],y=s[12*e+4*g+2],b=s[12*e+4*g+3],B=this._calculate(v,C,y,b,u);n[g]=i[l+g]*(1-B)+i[A+g]*B}else{var x=s[4*e+0],M=s[4*e+1],T=s[4*e+2],I=s[4*e+3],w=this._calculate(x,M,T,I,u);n[0]=i[l]*(1-w)+i[A]*w}return n},r._calculate=function(e,t,a,r,n){for(var i,o,s,A=.5,l=A,u=1-l,h=Math,d=0;d<15;d++){var p=(i=3*u*u*l)*e+(o=3*u*l*l)*t+(s=l*l*l)-n;if(h.abs(p)<1e-5)break;A/=2,u=1-(l+=p<0?A:-A)}return i*a+o*r+s},a}(u.Interpolant),S=function(e){function r(r){var n;(n=e.call(this)||this).isMMDToonMaterial=!0,n._matcapCombine=a.AddOperation,n.emissiveIntensity=1,n.normalMapType=a.TangentSpaceNormalMap,n.combine=a.MultiplyOperation,n.wireframeLinecap="round",n.wireframeLinejoin="round",n.flatShading=!1,n.lights=!0,n.vertexShader=x.MMDToonShader.vertexShader,n.fragmentShader=x.MMDToonShader.fragmentShader,n.defines=Object.assign({},x.MMDToonShader.defines),Object.defineProperty(t.assertThisInitialized(n),"matcapCombine",{get:function(){return this._matcapCombine},set:function(e){switch(this._matcapCombine=e,e){case a.MultiplyOperation:this.defines.MATCAP_BLENDING_MULTIPLY=!0,delete this.defines.MATCAP_BLENDING_ADD;break;default:case a.AddOperation:this.defines.MATCAP_BLENDING_ADD=!0,delete this.defines.MATCAP_BLENDING_MULTIPLY}}}),n.uniforms=p.UniformsUtils.clone(x.MMDToonShader.uniforms);for(var i=function(){var e=s[o];Object.defineProperty(t.assertThisInitialized(n),e,{get:function(){return this.uniforms[e].value},set:function(t){this.uniforms[e].value=t}})},o=0,s=["specular","opacity","diffuse","map","matcap","gradientMap","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveMap","bumpMap","bumpScale","normalMap","normalScale","displacemantBias","displacemantMap","displacemantScale","specularMap","alphaMap","envMap","reflectivity","refractionRatio"];o<s.length;o++)i();return n._shininess=30,Object.defineProperty(t.assertThisInitialized(n),"shininess",{get:function(){return this._shininess},set:function(e){this._shininess=e,this.uniforms.shininess.value=Math.max(this._shininess,1e-4)}}),Object.defineProperty(t.assertThisInitialized(n),"color",Object.getOwnPropertyDescriptor(t.assertThisInitialized(n),"diffuse")),n.setValues(r),n}return t.inheritsLoose(r,e),r.prototype.copy=function(t){return e.prototype.copy.call(this,t),this.matcapCombine=t.matcapCombine,this.emissiveIntensity=t.emissiveIntensity,this.normalMapType=t.normalMapType,this.combine=t.combine,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this},r}(m.ShaderMaterial);e.MMDLoader=I,Object.defineProperty(e,"__esModule",{value:!0})}));

/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","../animation/AnimationClip","../objects/Skeleton","../objects/Bone","./FileLoader","./Loader","../math/Quaternion","../animation/tracks/QuaternionKeyframeTrack","../math/Vector3","../animation/tracks/VectorKeyframeTrack"],(function(e,r,t,o,a,n,i,s,l,p,c){"use strict";var f=function(e){function i(r){var t;return(t=e.call(this,r)||this).animateBonePositions=!0,t.animateBoneRotations=!0,t}r.inheritsLoose(i,e);var f=i.prototype;return f.load=function(e,r,t,o){var a=this,i=new n.FileLoader(a.manager);i.setPath(a.path),i.setRequestHeader(a.requestHeader),i.setWithCredentials(a.withCredentials),i.load(e,(function(t){try{r(a.parse(t))}catch(r){o?o(r):console.error(r),a.manager.itemError(e)}}),t,o)},f.parse=function(e){function r(e,t,o){if("ENDSITE"!==o.type){var a={time:t,position:new p.Vector3,rotation:new s.Quaternion};o.frames.push(a);for(var n=new s.Quaternion,i=new p.Vector3(1,0,0),l=new p.Vector3(0,1,0),c=new p.Vector3(0,0,1),f=0;f<o.channels.length;f++)switch(o.channels[f]){case"Xposition":a.position.x=parseFloat(e.shift().trim());break;case"Yposition":a.position.y=parseFloat(e.shift().trim());break;case"Zposition":a.position.z=parseFloat(e.shift().trim());break;case"Xrotation":n.setFromAxisAngle(i,parseFloat(e.shift().trim())*Math.PI/180),a.rotation.multiply(n);break;case"Yrotation":n.setFromAxisAngle(l,parseFloat(e.shift().trim())*Math.PI/180),a.rotation.multiply(n);break;case"Zrotation":n.setFromAxisAngle(c,parseFloat(e.shift().trim())*Math.PI/180),a.rotation.multiply(n);break;default:console.warn("THREE.BVHLoader: Invalid channel type.")}for(var u=0;u<o.children.length;u++)r(e,t,o.children[u])}}function n(e,r,t){var o={name:"",type:"",frames:[]};t.push(o);var a=r.split(/[\s]+/);"END"===a[0].toUpperCase()&&"SITE"===a[1].toUpperCase()?(o.type="ENDSITE",o.name="ENDSITE"):(o.name=a[1],o.type=a[0].toUpperCase()),"{"!==i(e)&&console.error("THREE.BVHLoader: Expected opening { after type & name"),"OFFSET"!==(a=i(e).split(/[\s]+/))[0]&&console.error("THREE.BVHLoader: Expected OFFSET but got: "+a[0]),4!==a.length&&console.error("THREE.BVHLoader: Invalid number of values for OFFSET.");var s=new p.Vector3(parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]));if((isNaN(s.x)||isNaN(s.y)||isNaN(s.z))&&console.error("THREE.BVHLoader: Invalid values of OFFSET."),o.offset=s,"ENDSITE"!==o.type){"CHANNELS"!==(a=i(e).split(/[\s]+/))[0]&&console.error("THREE.BVHLoader: Expected CHANNELS definition.");var l=parseInt(a[1]);o.channels=a.splice(2,l),o.children=[]}for(;;){var c=i(e);if("}"===c)return o;o.children.push(n(e,c,t))}}function i(e){for(var r;0===(r=e.shift().trim()).length;);return r}var f=this,u=function(e){"HIERARCHY"!==i(e)&&console.error("THREE.BVHLoader: HIERARCHY expected.");var t=[],o=n(e,i(e),t);"MOTION"!==i(e)&&console.error("THREE.BVHLoader: MOTION expected.");var a=i(e).split(/[\s]+/),s=parseInt(a[1]);isNaN(s)&&console.error("THREE.BVHLoader: Failed to read number of frames."),a=i(e).split(/[\s]+/);var l=parseFloat(a[2]);isNaN(l)&&console.error("THREE.BVHLoader: Failed to read frame time.");for(var p=0;p<s;p++)r(a=i(e).split(/[\s]+/),p*l,o);return t}(e.split(/[\r\n]+/g)),h=[];!function e(r,t){var o=new a.Bone;if(t.push(o),o.position.add(r.offset),o.name=r.name,"ENDSITE"!==r.type)for(var n=0;n<r.children.length;n++)o.add(e(r.children[n],t));return o}(u[0],h);var m=function(e){for(var r=[],o=0;o<e.length;o++){var a=e[o];if("ENDSITE"!==a.type){for(var n=[],i=[],s=[],p=0;p<a.frames.length;p++){var u=a.frames[p];n.push(u.time),i.push(u.position.x+a.offset.x),i.push(u.position.y+a.offset.y),i.push(u.position.z+a.offset.z),s.push(u.rotation.x),s.push(u.rotation.y),s.push(u.rotation.z),s.push(u.rotation.w)}f.animateBonePositions&&r.push(new c.VectorKeyframeTrack(".bones["+a.name+"].position",n,i)),f.animateBoneRotations&&r.push(new l.QuaternionKeyframeTrack(".bones["+a.name+"].quaternion",n,s))}}return new t.AnimationClip("animation",-1,r)}(u);return{skeleton:new o.Skeleton(h),clip:m}},i}(i.Loader);e.BVHLoader=f,Object.defineProperty(e,"__esModule",{value:!0})}));

/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","../core/BufferGeometry","../math/Color","./FileLoader","../core/BufferAttribute","../objects/Group","./Loader","./LoaderUtils","../objects/Mesh","../materials/MeshPhongMaterial","../libs/fflate.module"],(function(e,t,a,n,r,o,i,l,s,m,d,u){"use strict";var c=function(e){function l(t){return e.call(this,t)||this}t.inheritsLoose(l,e);var c=l.prototype;return c.load=function(e,t,a,n){var o=this,i=new r.FileLoader(o.manager);i.setPath(o.path),i.setResponseType("arraybuffer"),i.setRequestHeader(o.requestHeader),i.setWithCredentials(o.withCredentials),i.load(e,(function(a){try{t(o.parse(a))}catch(t){n?n(t):console.error(t),o.manager.itemError(e)}}),a,n)},c.parse=function(e){function t(e){for(var t="AMF Material",a=e.attributes.id.textContent,o={r:1,g:1,b:1,a:1},i=null,l=0;l<e.childNodes.length;l++){var s=e.childNodes[l];"metadata"===s.nodeName&&void 0!==s.attributes.type?"name"===s.attributes.type.value&&(t=s.textContent):"color"===s.nodeName&&(o=r(s))}return i=new d.MeshPhongMaterial({flatShading:!0,color:new n.Color(o.r,o.g,o.b),name:t}),1!==o.a&&(i.transparent=!0,i.opacity=o.a),{id:a,material:i}}function r(e){for(var t={r:1,g:1,b:1,a:1},a=0;a<e.childNodes.length;a++){var n=e.childNodes[a];"r"===n.nodeName?t.r=n.textContent:"g"===n.nodeName?t.g=n.textContent:"b"===n.nodeName?t.b=n.textContent:"a"===n.nodeName&&(t.a=n.textContent)}return t}function l(e){var t={name:"",triangles:[],materialid:null},a=e.firstElementChild;for(void 0!==e.attributes.materialid&&(t.materialId=e.attributes.materialid.nodeValue);a;){if("metadata"===a.nodeName)void 0!==a.attributes.type&&"name"===a.attributes.type.value&&(t.name=a.textContent);else if("triangle"===a.nodeName){var n=a.getElementsByTagName("v1")[0].textContent,r=a.getElementsByTagName("v2")[0].textContent,o=a.getElementsByTagName("v3")[0].textContent;t.triangles.push(n,r,o)}a=a.nextElementSibling}return t}function c(e){for(var t=[],a=[],n=e.firstElementChild;n;){if("vertex"===n.nodeName)for(var r=n.firstElementChild;r;){if("coordinates"===r.nodeName){var o=r.getElementsByTagName("x")[0].textContent,i=r.getElementsByTagName("y")[0].textContent,l=r.getElementsByTagName("z")[0].textContent;t.push(o,i,l)}else if("normal"===r.nodeName){var s=r.getElementsByTagName("nx")[0].textContent,m=r.getElementsByTagName("ny")[0].textContent,d=r.getElementsByTagName("nz")[0].textContent;a.push(s,m,d)}r=r.nextElementSibling}n=n.nextElementSibling}return{vertices:t,normals:a}}function f(e){for(var t=e.attributes.id.textContent,a={name:"amfobject",meshes:[]},n=null,o=e.firstElementChild;o;){if("metadata"===o.nodeName)void 0!==o.attributes.type&&"name"===o.attributes.type.value&&(a.name=o.textContent);else if("color"===o.nodeName)n=r(o);else if("mesh"===o.nodeName){for(var i=o.firstElementChild,s={vertices:[],normals:[],volumes:[],color:n};i;){if("vertices"===i.nodeName){var m=c(i);s.normals=s.normals.concat(m.normals),s.vertices=s.vertices.concat(m.vertices)}else"volume"===i.nodeName&&s.volumes.push(l(i));i=i.nextElementSibling}a.meshes.push(s)}o=o.nextElementSibling}return{id:t,obj:a}}var v,g,h=function(e){var t=new DataView(e);if("PK"===String.fromCharCode(t.getUint8(0),t.getUint8(1))){var a=null,n=null;console.log("THREE.AMFLoader: Loading Zip");try{a=u.unzipSync(new Uint8Array(e))}catch(e){if(e instanceof ReferenceError)return console.log("THREE.AMFLoader: fflate missing and file is compressed."),null}for(n in a)if(".amf"===n.toLowerCase().slice(-4))break;console.log("THREE.AMFLoader: Trying to load file asset: "+n),t=new DataView(a[n].buffer)}var r=s.LoaderUtils.decodeText(t),o=(new DOMParser).parseFromString(r,"application/xml");return"amf"!==o.documentElement.nodeName.toLowerCase()?(console.log("THREE.AMFLoader: Error loading AMF - no AMF document found."),null):o}(e),b="",p="",E=function(e){var t=1,a="millimeter";void 0!==e.documentElement.attributes.unit&&(a=e.documentElement.attributes.unit.value.toLowerCase());var n={millimeter:1,inch:25.4,feet:304.8,meter:1e3,micron:.001};return void 0!==n[a]&&(t=n[a]),console.log("THREE.AMFLoader: Unit scale: "+t),t}(h),C={},N={},y=h.documentElement.childNodes;for(v=0;v<y.length;v++){var x=y[v];if("metadata"===x.nodeName)void 0!==x.attributes.type&&("name"===x.attributes.type.value?b=x.textContent:"author"===x.attributes.type.value&&(p=x.textContent));else if("material"===x.nodeName){var w=t(x);C[w.id]=w.material}else if("object"===x.nodeName){var M=f(x);N[M.id]=M.obj}}var L=new i.Group,T=new d.MeshPhongMaterial({color:11184895,flatShading:!0});for(var A in L.name=b,L.userData.author=p,L.userData.loader="AMF",N){var B=N[A],F=B.meshes,S=new i.Group;for(S.name=B.name||"",v=0;v<F.length;v++){var H=T,P=F[v],R=new o.Float32BufferAttribute(P.vertices,3),j=null;if(P.normals.length&&(j=new o.Float32BufferAttribute(P.normals,3)),P.color){var U=P.color;(H=T.clone()).color=new n.Color(U.r,U.g,U.b),1!==U.a&&(H.transparent=!0,H.opacity=U.a)}var D=P.volumes;for(g=0;g<D.length;g++){var G=D[g],I=new a.BufferGeometry,_=H;I.setIndex(G.triangles),I.setAttribute("position",R.clone()),j&&I.setAttribute("normal",j.clone()),void 0!==C[G.materialId]&&(_=C[G.materialId]),I.scale(E,E,E),S.add(new m.Mesh(I,_.clone()))}}L.add(S)}return L},l}(l.Loader);e.AMFLoader=c,Object.defineProperty(e,"__esModule",{value:!0})}));

/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","../textures/CompressedTexture","../textures/DataTexture","../textures/Data3DTexture","./FileLoader","../constants","./Loader","../utils/WorkerPool","../libs/ktx-parse.module"],(function(e,r,t,o,a,n,i,s,_,T){"use strict";var d,R,F,c=new WeakMap,p=0,m=function(e){function s(r){var t;return(t=e.call(this,r)||this).transcoderPath="",t.transcoderBinary=null,t.transcoderPending=null,t.workerPool=new _.WorkerPool,t.workerSourceURL="",t.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.'),t}r.inheritsLoose(s,e);var d=s.prototype;return d.setTranscoderPath=function(e){return this.transcoderPath=e,this},d.setWorkerLimit=function(e){return this.workerPool.setWorkerLimit(e),this},d.detectSupport=function(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},e.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1),this},d.init=function(){var e=this;if(!this.transcoderPending){var r=new n.FileLoader(this.manager);r.setPath(this.transcoderPath),r.setWithCredentials(this.withCredentials);var t=r.loadAsync("basis_transcoder.js"),o=new n.FileLoader(this.manager);o.setPath(this.transcoderPath),o.setResponseType("arraybuffer"),o.setWithCredentials(this.withCredentials);var a=o.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([t,a]).then((function(r){var t=r[0],o=r[1],a=s.BasisWorker.toString(),n=["/* constants */","let _EngineFormat = "+JSON.stringify(s.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(s.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(s.BasisFormat),"/* basis_transcoder.js */",t,"/* worker */",a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))].join("\n");e.workerSourceURL=URL.createObjectURL(new Blob([n])),e.transcoderBinary=o,e.workerPool.setWorkerCreator((function(){var r=new Worker(e.workerSourceURL),t=e.transcoderBinary.slice(0);return r.postMessage({type:"init",config:e.workerConfig,transcoderBinary:t},[t]),r}))})),p>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),p++}return this.transcoderPending},d.load=function(e,r,t,o){var a=this;if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");var i=new n.FileLoader(this.manager);i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials),i.load(e,(function(e){if(c.has(e))return c.get(e).promise.then(r).catch(o);a._createTexture(e).then((function(e){return r?r(e):null})).catch(o)}),t,o)},d._createTextureFrom=function(e){var r=e.mipmaps,o=e.width,a=e.height,n=e.format,s=e.type,_=e.error,T=e.dfdTransferFn,d=e.dfdFlags;if("error"===s)return Promise.reject(_);var R=new t.CompressedTexture(r,o,a,n,i.UnsignedByteType);return R.minFilter=1===r.length?i.LinearFilter:i.LinearMipmapLinearFilter,R.magFilter=i.LinearFilter,R.generateMipmaps=!1,R.needsUpdate=!0,R.encoding=2===T?i.sRGBEncoding:i.LinearEncoding,R.premultiplyAlpha=!!(1&d),R},d._createTexture=function(e,r){var t=this;void 0===r&&(r={});var n=T.read(new Uint8Array(e));if(n.vkFormat!==T.VK_FORMAT_UNDEFINED)return function(e){var r,t=e.vkFormat,n=e.pixelWidth,s=e.pixelHeight,_=e.pixelDepth;if(void 0===l[t])throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");var T=e.levels[0].levelData;r=u[t]===i.FloatType?new Float32Array(T.buffer,T.byteOffset,T.byteLength/Float32Array.BYTES_PER_ELEMENT):u[t]===i.HalfFloatType?new Uint16Array(T.buffer,T.byteOffset,T.byteLength/Uint16Array.BYTES_PER_ELEMENT):T;var d=0===_?new o.DataTexture(r,n,s):new a.Data3DTexture(r,n,s,_);return d.type=u[t],d.format=l[t],d.encoding=A[t]||i.LinearEncoding,d.needsUpdate=!0,Promise.resolve(d)}(n);var s=r,_=this.init().then((function(){return t.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:s},[e])})).then((function(e){return t._createTextureFrom(e.data)}));return c.set(e,{promise:_}),_},d.dispose=function(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),p--,this},s}(s.Loader);m.BasisFormat={ETC1S:0,UASTC_4x4:1},m.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},m.EngineFormat={RGBAFormat:i.RGBAFormat,RGBA_ASTC_4x4_Format:i.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:i.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:i.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:i.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:i.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:i.RGB_ETC1_Format,RGB_ETC2_Format:i.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:i.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:i.RGB_S3TC_DXT1_Format},m.BasisWorker=function(){var e,r,t,o=_EngineFormat,a=_TranscoderFormat,n=_BasisFormat;self.addEventListener("message",(function(i){var d,R=i.data;switch(R.type){case"init":e=R.config,d=R.transcoderBinary,r=new Promise((function(e){t={wasmBinary:d,onRuntimeInitialized:e},BASIS(t)})).then((function(){t.initializeBasis(),void 0===t.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")}));break;case"transcode":r.then((function(){try{for(var r=function(r){var i=new t.KTX2File(new Uint8Array(r));function d(){i.close(),i.delete()}if(!i.isValid())throw d(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");var R=i.isUASTC()?n.UASTC_4x4:n.ETC1S,F=i.getWidth(),c=i.getHeight(),p=i.getLevels(),m=i.getHasAlpha(),l=i.getDFDTransferFunc(),u=i.getDFDFlags(),A=function(r,t,i,d){for(var R,F,c=r===n.ETC1S?s:_,p=0;p<c.length;p++){var m=c[p];if(e[m.if]&&(m.basisFormat.includes(r)&&!(d&&m.transcoderFormat.length<2)&&(!m.needsPowerOfTwo||T(t)&&T(i))))return{transcoderFormat:R=m.transcoderFormat[d?1:0],engineFormat:F=m.engineFormat[d?1:0]}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),R=a.RGBA32,F=o.RGBAFormat,{transcoderFormat:R,engineFormat:F}}(R,F,c,m),f=A.transcoderFormat,B=A.engineFormat;if(!F||!c||!p)throw d(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!i.startTranscoding())throw d(),new Error("THREE.KTX2Loader: .startTranscoding failed");for(var h=[],C=0;C<p;C++){var g=i.getImageLevelInfo(C,0,0),S=g.origWidth,E=g.origHeight,G=new Uint8Array(i.getImageTranscodedSizeInBytes(C,0,0,f));if(!i.transcodeImage(G,C,0,0,f,0,-1,-1))throw d(),new Error("THREE.KTX2Loader: .transcodeImage failed.");h.push({data:G,width:S,height:E})}return d(),{width:F,height:c,hasAlpha:m,mipmaps:h,format:B,dfdTransferFn:l,dfdFlags:u}}(R.buffer),i=r.width,d=r.height,F=r.hasAlpha,c=r.mipmaps,p=r.format,m=r.dfdTransferFn,l=r.dfdFlags,u=[],A=0;A<c.length;++A)u.push(c[A].data.buffer);self.postMessage({type:"transcode",id:R.id,width:i,height:d,hasAlpha:F,mipmaps:c,format:p,dfdTransferFn:m,dfdFlags:l},u)}catch(e){console.error(e),self.postMessage({type:"error",id:R.id,error:e.message})}}))}}));var i=[{if:"astcSupported",basisFormat:[n.UASTC_4x4],transcoderFormat:[a.ASTC_4x4,a.ASTC_4x4],engineFormat:[o.RGBA_ASTC_4x4_Format,o.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.BC7_M5,a.BC7_M5],engineFormat:[o.RGBA_BPTC_Format,o.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.BC1,a.BC3],engineFormat:[o.RGB_S3TC_DXT1_Format,o.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.ETC1,a.ETC2],engineFormat:[o.RGB_ETC2_Format,o.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.ETC1],engineFormat:[o.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.PVRTC1_4_RGB,a.PVRTC1_4_RGBA],engineFormat:[o.RGB_PVRTC_4BPPV1_Format,o.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],s=i.sort((function(e,r){return e.priorityETC1S-r.priorityETC1S})),_=i.sort((function(e,r){return e.priorityUASTC-r.priorityUASTC}));function T(e){return e<=2||0==(e&e-1)&&0!==e}};var l=((d={})[T.VK_FORMAT_R32G32B32A32_SFLOAT]=i.RGBAFormat,d[T.VK_FORMAT_R16G16B16A16_SFLOAT]=i.RGBAFormat,d[T.VK_FORMAT_R8G8B8A8_UNORM]=i.RGBAFormat,d[T.VK_FORMAT_R8G8B8A8_SRGB]=i.RGBAFormat,d[T.VK_FORMAT_R32G32_SFLOAT]=i.RGFormat,d[T.VK_FORMAT_R16G16_SFLOAT]=i.RGFormat,d[T.VK_FORMAT_R8G8_UNORM]=i.RGFormat,d[T.VK_FORMAT_R8G8_SRGB]=i.RGFormat,d[T.VK_FORMAT_R32_SFLOAT]=i.RedFormat,d[T.VK_FORMAT_R16_SFLOAT]=i.RedFormat,d[T.VK_FORMAT_R8_SRGB]=i.RedFormat,d[T.VK_FORMAT_R8_UNORM]=i.RedFormat,d),u=((R={})[T.VK_FORMAT_R32G32B32A32_SFLOAT]=i.FloatType,R[T.VK_FORMAT_R16G16B16A16_SFLOAT]=i.HalfFloatType,R[T.VK_FORMAT_R8G8B8A8_UNORM]=i.UnsignedByteType,R[T.VK_FORMAT_R8G8B8A8_SRGB]=i.UnsignedByteType,R[T.VK_FORMAT_R32G32_SFLOAT]=i.FloatType,R[T.VK_FORMAT_R16G16_SFLOAT]=i.HalfFloatType,R[T.VK_FORMAT_R8G8_UNORM]=i.UnsignedByteType,R[T.VK_FORMAT_R8G8_SRGB]=i.UnsignedByteType,R[T.VK_FORMAT_R32_SFLOAT]=i.FloatType,R[T.VK_FORMAT_R16_SFLOAT]=i.HalfFloatType,R[T.VK_FORMAT_R8_SRGB]=i.UnsignedByteType,R[T.VK_FORMAT_R8_UNORM]=i.UnsignedByteType,R),A=((F={})[T.VK_FORMAT_R8G8B8A8_SRGB]=i.sRGBEncoding,F[T.VK_FORMAT_R8G8_SRGB]=i.sRGBEncoding,F[T.VK_FORMAT_R8_SRGB]=i.sRGBEncoding,F);e.KTX2Loader=m,Object.defineProperty(e,"__esModule",{value:!0})}));

/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","../lights/AmbientLight","../animation/AnimationClip","../objects/Bone","../core/BufferGeometry","../constants","../math/Color","../lights/DirectionalLight","../math/Euler","./FileLoader","../core/BufferAttribute","../objects/Group","../objects/Line","../materials/MeshPhongMaterial","../materials/MeshLambertMaterial","../materials/MeshBasicMaterial","../materials/LineBasicMaterial","../objects/LineSegments","./Loader","./LoaderUtils","../math/MathUtils","../math/Matrix4","../objects/Mesh","../cameras/PerspectiveCamera","../cameras/OrthographicCamera","../lights/PointLight","../math/Quaternion","../animation/tracks/QuaternionKeyframeTrack","../scenes/Scene","../objects/Skeleton","../objects/SkinnedMesh","../lights/SpotLight","./TextureLoader","../math/Vector2","../math/Vector3","../animation/tracks/VectorKeyframeTrack","./TGALoader"],(function(e,t,r,a,n,i,s,o,c,l,d,u,f,h,m,p,v,g,b,y,N,x,k,w,A,T,C,E,_,L,M,R,j,O,S,I,q,B){"use strict";var F=function(e){function y(t){return e.call(this,t)||this}t.inheritsLoose(y,e);var F=y.prototype;return F.load=function(e,t,r,a){var n=this,i=""===n.path?N.LoaderUtils.extractUrlBase(e):n.path,s=new d.FileLoader(n.manager);s.setPath(n.path),s.setRequestHeader(n.requestHeader),s.setWithCredentials(n.withCredentials),s.load(e,(function(r){try{t(n.parse(r,i))}catch(t){a?a(t):console.error(t),n.manager.itemError(e)}}),r,a)},F.parse=function(e,t){function d(e,t){for(var r=[],a=e.childNodes,n=0,i=a.length;n<i;n++){var s=a[n];s.nodeName===t&&r.push(s)}return r}function y(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),a=0,n=t.length;a<n;a++)r[a]=t[a];return r}function N(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),a=0,n=t.length;a<n;a++)r[a]=parseFloat(t[a]);return r}function F(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),a=0,n=t.length;a<n;a++)r[a]=parseInt(t[a]);return r}function U(e){return e.substring(1)}function H(e){return 0===Object.keys(e).length}function P(e){return void 0!==e&&!0===e.hasAttribute("meter")?parseFloat(e.getAttribute("meter")):1}function V(e){return void 0!==e?e.textContent:"Y_UP"}function G(e,t,r,a){var n=d(e,t)[0];if(void 0!==n)for(var i=d(n,r),s=0;s<i.length;s++)a(i[s])}function D(e,t){for(var r in e){e[r].build=t(e[r])}}function W(e,t){return void 0!==e.build||(e.build=t(e)),e.build}function z(e){for(var t={inputs:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"input"===n.nodeName){var i=U(n.getAttribute("source")),s=n.getAttribute("semantic");t.inputs[s]=i}}return t}function J(e){var t={},r=e.getAttribute("target").split("/"),a=r.shift(),n=r.shift(),i=-1!==n.indexOf("("),s=-1!==n.indexOf(".");if(s)r=n.split("."),n=r.shift(),t.member=r.shift();else if(i){var o=n.split("(");n=o.shift();for(var c=0;c<o.length;c++)o[c]=parseInt(o[c].replace(/\)/,""));t.indices=o}return t.id=a,t.sid=n,t.arraySyntax=i,t.memberSyntax=s,t.sampler=U(e.getAttribute("source")),t}function X(e){var t=[],r=e.channels,a=e.samplers,n=e.sources;for(var i in r)if(r.hasOwnProperty(i)){var s=r[i],o=a[s.sampler],c=o.inputs.INPUT,l=o.inputs.OUTPUT;ee(Q(s,n[c],n[l]),t)}return t}function K(e){return W(Rt.animations[e],X)}function Q(e,t,r){var a,n,i,s,o,c,l=Rt.nodes[e.id],d=pt(l.id),u=l.transforms[e.sid],f=l.matrix.clone().transpose(),h={};switch(u){case"matrix":for(i=0,s=t.array.length;i<s;i++)if(a=t.array[i],n=i*r.stride,void 0===h[a]&&(h[a]={}),!0===e.arraySyntax){var m=r.array[n],p=e.indices[0]+4*e.indices[1];h[a][p]=m}else for(o=0,c=r.stride;o<c;o++)h[a][o]=r.array[n+o];break;case"translate":case"rotate":case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',u)}var v=function(e,t){var r=[];for(var a in e)r.push({time:parseFloat(a),value:e[a]});r.sort(i);for(var n=0;n<16;n++)te(r,n,t.elements[n]);return r;function i(e,t){return e.time-t.time}}(h,f);return{name:d.uuid,keyframes:v}}var Z=new I.Vector3,Y=new I.Vector3,$=new E.Quaternion;function ee(e,t){for(var r=e.keyframes,a=e.name,n=[],i=[],s=[],o=[],c=0,l=r.length;c<l;c++){var d=r[c],u=d.time,f=d.value;nt.fromArray(f).transpose(),nt.decompose(Z,$,Y),n.push(u),i.push(Z.x,Z.y,Z.z),s.push($.x,$.y,$.z,$.w),o.push(Y.x,Y.y,Y.z)}return i.length>0&&t.push(new q.VectorKeyframeTrack(a+".position",n,i)),s.length>0&&t.push(new _.QuaternionKeyframeTrack(a+".quaternion",n,s)),o.length>0&&t.push(new q.VectorKeyframeTrack(a+".scale",n,o)),t}function te(e,t,r){var a,n,i,s=!0;for(n=0,i=e.length;n<i;n++)void 0===(a=e[n]).value[t]?a.value[t]=null:s=!1;if(!0===s)for(n=0,i=e.length;n<i;n++)(a=e[n]).value[t]=r;else!function(e,t){for(var r,a,n=0,i=e.length;n<i;n++){var s=e[n];if(null===s.value[t]){if(r=re(e,n,t),a=ae(e,n,t),null===r){s.value[t]=a.value[t];continue}if(null===a){s.value[t]=r.value[t];continue}ne(s,r,a,t)}}}(e,t)}function re(e,t,r){for(;t>=0;){var a=e[t];if(null!==a.value[r])return a;t--}return null}function ae(e,t,r){for(;t<e.length;){var a=e[t];if(null!==a.value[r])return a;t++}return null}function ne(e,t,r,a){r.time-t.time!=0?e.value[a]=(e.time-t.time)*(r.value[a]-t.value[a])/(r.time-t.time)+t.value[a]:e.value[a]=t.value[a]}function ie(e){for(var t=[],r=e.name,n=e.end-e.start||-1,i=e.animations,s=0,o=i.length;s<o;s++)for(var c=K(i[s]),l=0,d=c.length;l<d;l++)t.push(c[l]);return new a.AnimationClip(r,n,t)}function se(e){return W(Rt.clips[e],ie)}function oe(e){for(var t={sources:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"bind_shape_matrix":t.bindShapeMatrix=N(n.textContent);break;case"source":var i=n.getAttribute("id");t.sources[i]=Fe(n);break;case"joints":t.joints=ce(n);break;case"vertex_weights":t.vertexWeights=le(n)}}return t}function ce(e){for(var t={inputs:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"input"===n.nodeName){var i=n.getAttribute("semantic"),s=U(n.getAttribute("source"));t.inputs[i]=s}}return t}function le(e){for(var t={inputs:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=n.getAttribute("semantic"),s=U(n.getAttribute("source")),o=parseInt(n.getAttribute("offset"));t.inputs[i]={id:s,offset:o};break;case"vcount":t.vcount=F(n.textContent);break;case"v":t.v=F(n.textContent)}}return t}function de(e){var t={id:e.id},r=Rt.geometries[t.id];return void 0!==e.skin&&(t.skin=function(e){var t,r,a,n=4,i={joints:[],indices:{array:[],stride:n},weights:{array:[],stride:n}},s=e.sources,o=e.vertexWeights,c=o.vcount,l=o.v,d=o.inputs.JOINT.offset,u=o.inputs.WEIGHT.offset,f=e.sources[e.joints.inputs.JOINT],h=e.sources[e.joints.inputs.INV_BIND_MATRIX],m=s[o.inputs.WEIGHT.id].array,p=0;for(t=0,a=c.length;t<a;t++){var v=c[t],g=[];for(r=0;r<v;r++){var b=l[p+d],y=m[l[p+u]];g.push({index:b,weight:y}),p+=2}for(g.sort(A),r=0;r<n;r++){var N=g[r];void 0!==N?(i.indices.array.push(N.index),i.weights.array.push(N.weight)):(i.indices.array.push(0),i.weights.array.push(0))}}e.bindShapeMatrix?i.bindMatrix=(new k.Matrix4).fromArray(e.bindShapeMatrix).transpose():i.bindMatrix=(new k.Matrix4).identity();for(t=0,a=f.array.length;t<a;t++){var x=f.array[t],w=(new k.Matrix4).fromArray(h.array,t*h.stride).transpose();i.joints.push({name:x,boneInverse:w})}return i;function A(e,t){return t.weight-e.weight}}(e.skin),r.sources.skinIndices=t.skin.indices,r.sources.skinWeights=t.skin.weights),t}function ue(e){return void 0!==e.build?e.build:e.init_from}function fe(e){var t=Rt.images[e];return void 0!==t?W(t,ue):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",e),null)}function he(e){for(var t={surfaces:{},samplers:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"newparam":me(n,t);break;case"technique":t.technique=ge(n);break;case"extra":t.extra=we(n)}}return t}function me(e,t){for(var r=e.getAttribute("sid"),a=0,n=e.childNodes.length;a<n;a++){var i=e.childNodes[a];if(1===i.nodeType)switch(i.nodeName){case"surface":t.surfaces[r]=pe(i);break;case"sampler2D":t.samplers[r]=ve(i)}}}function pe(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"init_from"===n.nodeName)t.init_from=n.textContent}return t}function ve(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"source"===n.nodeName)t.source=n.textContent}return t}function ge(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"constant":case"lambert":case"blinn":case"phong":t.type=n.nodeName,t.parameters=be(n);break;case"extra":t.extra=we(n)}}return t}function be(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":t[n.nodeName]=ye(n);break;case"transparent":t[n.nodeName]={opaque:n.hasAttribute("opaque")?n.getAttribute("opaque"):"A_ONE",data:ye(n)}}}return t}function ye(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"color":t[n.nodeName]=N(n.textContent);break;case"float":t[n.nodeName]=parseFloat(n.textContent);break;case"texture":t[n.nodeName]={id:n.getAttribute("texture"),extra:Ne(n)}}}return t}function Ne(e){for(var t={technique:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"extra"===n.nodeName)xe(n,t)}return t}function xe(e,t){for(var r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"technique"===n.nodeName)ke(n,t)}}function ke(e,t){for(var r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":t.technique[n.nodeName]=parseFloat(n.textContent);break;case"wrapU":case"wrapV":"TRUE"===n.textContent.toUpperCase()?t.technique[n.nodeName]=1:"FALSE"===n.textContent.toUpperCase()?t.technique[n.nodeName]=0:t.technique[n.nodeName]=parseInt(n.textContent);break;case"bump":t[n.nodeName]=Te(n)}}}function we(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"technique"===n.nodeName)t.technique=Ae(n)}return t}function Ae(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"double_sided":t[n.nodeName]=parseInt(n.textContent);break;case"bump":t[n.nodeName]=Te(n)}}return t}function Te(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"texture"===n.nodeName)t[n.nodeName]={id:n.getAttribute("texture"),texcoord:n.getAttribute("texcoord"),extra:Ne(n)}}return t}function Ce(e){return e}function Ee(e){var t,r,a=(t=e.url,W(Rt.effects[t],Ce)),n=a.profile.technique;switch(n.type){case"phong":case"blinn":r=new m.MeshPhongMaterial;break;case"lambert":r=new p.MeshLambertMaterial;break;default:r=new v.MeshBasicMaterial}function i(e,t){void 0===t&&(t=null);var r=a.profile.samplers[e.id],n=null;void 0!==r?n=fe(a.profile.surfaces[r.source].init_from):(console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),n=fe(e.id));if(null!==n){var i=function(e){var t,r=e.slice(2+(e.lastIndexOf(".")-1>>>0));t="tga"===(r=r.toLowerCase())?At:Ct;return t}(n);if(void 0!==i){var o=i.load(n),c=e.extra;if(void 0!==c&&void 0!==c.technique&&!1===H(c.technique)){var l=c.technique;o.wrapS=l.wrapU?s.RepeatWrapping:s.ClampToEdgeWrapping,o.wrapT=l.wrapV?s.RepeatWrapping:s.ClampToEdgeWrapping,o.offset.set(l.offsetU||0,l.offsetV||0),o.repeat.set(l.repeatU||1,l.repeatV||1)}else o.wrapS=s.RepeatWrapping,o.wrapT=s.RepeatWrapping;return null!==t&&(o.encoding=t),o}return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",n),null}return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",e.id),null}r.name=e.name||"";var o=n.parameters;for(var c in o){var l=o[c];switch(c){case"diffuse":l.color&&r.color.fromArray(l.color),l.texture&&(r.map=i(l.texture,s.sRGBEncoding));break;case"specular":l.color&&r.specular&&r.specular.fromArray(l.color),l.texture&&(r.specularMap=i(l.texture));break;case"bump":l.texture&&(r.normalMap=i(l.texture));break;case"ambient":l.texture&&(r.lightMap=i(l.texture,s.sRGBEncoding));break;case"shininess":l.float&&r.shininess&&(r.shininess=l.float);break;case"emission":l.color&&r.emissive&&r.emissive.fromArray(l.color),l.texture&&(r.emissiveMap=i(l.texture,s.sRGBEncoding))}}r.color.convertSRGBToLinear(),r.specular&&r.specular.convertSRGBToLinear(),r.emissive&&r.emissive.convertSRGBToLinear();var d=o.transparent,u=o.transparency;if(void 0===u&&d&&(u={float:1}),void 0===d&&u&&(d={opaque:"A_ONE",data:{color:[1,1,1,1]}}),d&&u)if(d.data.texture)r.transparent=!0;else{var f=d.data.color;switch(d.opaque){case"A_ONE":r.opacity=f[3]*u.float;break;case"RGB_ZERO":r.opacity=1-f[0]*u.float;break;case"A_ZERO":r.opacity=1-f[3]*u.float;break;case"RGB_ONE":r.opacity=f[0]*u.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',d.opaque)}r.opacity<1&&(r.transparent=!0)}if(void 0!==n.extra&&void 0!==n.extra.technique){var h=n.extra.technique;for(var g in h){var b=h[g];switch(g){case"double_sided":r.side=1===b?s.DoubleSide:s.FrontSide;break;case"bump":r.normalMap=i(b.texture),r.normalScale=new S.Vector2(1,1)}}}return r}function _e(e){return W(Rt.materials[e],Ee)}function Le(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if("technique_common"===r.nodeName)return Me(r)}return{}}function Me(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];switch(a.nodeName){case"perspective":case"orthographic":t.technique=a.nodeName,t.parameters=Re(a)}}return t}function Re(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];switch(a.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":t[a.nodeName]=parseFloat(a.textContent)}}return t}function je(e){var t;switch(e.optics.technique){case"perspective":t=new A.PerspectiveCamera(e.optics.parameters.yfov,e.optics.parameters.aspect_ratio,e.optics.parameters.znear,e.optics.parameters.zfar);break;case"orthographic":var r=e.optics.parameters.ymag,a=e.optics.parameters.xmag,n=e.optics.parameters.aspect_ratio;a=void 0===a?r*n:a,r=void 0===r?a/n:r,a*=.5,r*=.5,t=new T.OrthographicCamera(-a,a,r,-r,e.optics.parameters.znear,e.optics.parameters.zfar);break;default:t=new A.PerspectiveCamera}return t.name=e.name||"",t}function Oe(e){var t=Rt.cameras[e];return void 0!==t?W(t,je):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",e),null)}function Se(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"directional":case"point":case"spot":case"ambient":t.technique=n.nodeName,t.parameters=Ie(n)}}return t}function Ie(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"color":var i=N(n.textContent);t.color=(new o.Color).fromArray(i).convertSRGBToLinear();break;case"falloff_angle":t.falloffAngle=parseFloat(n.textContent);break;case"quadratic_attenuation":var s=parseFloat(n.textContent);t.distance=s?Math.sqrt(1/s):0}}return t}function qe(e){var t;switch(e.technique){case"directional":t=new c.DirectionalLight;break;case"point":t=new C.PointLight;break;case"spot":t=new j.SpotLight;break;case"ambient":t=new r.AmbientLight}return e.parameters.color&&t.color.copy(e.parameters.color),e.parameters.distance&&(t.distance=e.parameters.distance),t}function Be(e){var t=Rt.lights[e];return void 0!==t?W(t,qe):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",e),null)}function Fe(e){for(var t={array:[],stride:3},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"float_array":t.array=N(a.textContent);break;case"Name_array":t.array=y(a.textContent);break;case"technique_common":var n=d(a,"accessor")[0];void 0!==n&&(t.stride=parseInt(n.getAttribute("stride")))}}return t}function Ue(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];1===a.nodeType&&(t[a.getAttribute("semantic")]=U(a.getAttribute("source")))}return t}function He(e){for(var t={type:e.nodeName,material:e.getAttribute("material"),count:parseInt(e.getAttribute("count")),inputs:{},stride:0,hasUV:!1},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=U(n.getAttribute("source")),s=n.getAttribute("semantic"),o=parseInt(n.getAttribute("offset")),c=parseInt(n.getAttribute("set")),l=c>0?s+c:s;t.inputs[l]={id:i,offset:o},t.stride=Math.max(t.stride,o+1),"TEXCOORD"===s&&(t.hasUV=!0);break;case"vcount":t.vcount=F(n.textContent);break;case"p":t.p=F(n.textContent)}}return t}function Pe(e){for(var t=0,r=0,a=e.length;r<a;r++){!0===e[r].hasUV&&t++}t>0&&t<e.length&&(e.uvsNeedsFix=!0)}function Ve(e){var t={},r=e.sources,a=e.vertices,n=e.primitives;if(0===n.length)return{};var i=function(e){for(var t={},r=0;r<e.length;r++){var a=e[r];void 0===t[a.type]&&(t[a.type]=[]),t[a.type].push(a)}return t}(n);for(var s in i){var o=i[s];Pe(o),t[s]=Ge(o,r,a)}return t}function Ge(e,t,r){for(var a={},n={array:[],stride:0},s={array:[],stride:0},o={array:[],stride:0},c={array:[],stride:0},l={array:[],stride:0},d=[],f=4,h=[],m=4,p=new i.BufferGeometry,v=[],g=0,b=0;b<e.length;b++){var y=e[b],N=y.inputs,x=0;switch(y.type){case"lines":case"linestrips":x=2*y.count;break;case"triangles":x=3*y.count;break;case"polylist":for(var k=0;k<y.count;k++){var w=y.vcount[k];switch(w){case 3:x+=3;break;case 4:x+=6;break;default:x+=3*(w-2)}}break;default:console.warn("THREE.ColladaLoader: Unknow primitive type:",y.type)}for(var A in p.addGroup(g,x,b),g+=x,y.material&&v.push(y.material),N){var T=N[A];switch(A){case"VERTEX":for(var C in r){var E=r[C];switch(C){case"POSITION":var _=n.array.length;if(De(y,t[E],T.offset,n.array),n.stride=t[E].stride,t.skinWeights&&t.skinIndices&&(De(y,t.skinIndices,T.offset,d),De(y,t.skinWeights,T.offset,h)),!1===y.hasUV&&!0===e.uvsNeedsFix)for(var L=(n.array.length-_)/n.stride,M=0;M<L;M++)o.array.push(0,0);break;case"NORMAL":De(y,t[E],T.offset,s.array),s.stride=t[E].stride;break;case"COLOR":De(y,t[E],T.offset,l.array),l.stride=t[E].stride;break;case"TEXCOORD":De(y,t[E],T.offset,o.array),o.stride=t[E].stride;break;case"TEXCOORD1":De(y,t[E],T.offset,c.array),o.stride=t[E].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',C)}}break;case"NORMAL":De(y,t[T.id],T.offset,s.array),s.stride=t[T.id].stride;break;case"COLOR":De(y,t[T.id],T.offset,l.array,!0),l.stride=t[T.id].stride;break;case"TEXCOORD":De(y,t[T.id],T.offset,o.array),o.stride=t[T.id].stride;break;case"TEXCOORD1":De(y,t[T.id],T.offset,c.array),c.stride=t[T.id].stride}}}return n.array.length>0&&p.setAttribute("position",new u.Float32BufferAttribute(n.array,n.stride)),s.array.length>0&&p.setAttribute("normal",new u.Float32BufferAttribute(s.array,s.stride)),l.array.length>0&&p.setAttribute("color",new u.Float32BufferAttribute(l.array,l.stride)),o.array.length>0&&p.setAttribute("uv",new u.Float32BufferAttribute(o.array,o.stride)),c.array.length>0&&p.setAttribute("uv2",new u.Float32BufferAttribute(c.array,c.stride)),d.length>0&&p.setAttribute("skinIndex",new u.Float32BufferAttribute(d,f)),h.length>0&&p.setAttribute("skinWeight",new u.Float32BufferAttribute(h,m)),a.data=p,a.type=e[0].type,a.materialKeys=v,a}function De(e,t,r,a,n){void 0===n&&(n=!1);var i=e.p,s=e.stride,o=e.vcount;function c(e){for(var t=i[e+r]*d,s=t+d;t<s;t++)a.push(l[t]);if(n){var o=a.length-d-1;Et.setRGB(a[o+0],a[o+1],a[o+2]).convertSRGBToLinear(),a[o+0]=Et.r,a[o+1]=Et.g,a[o+2]=Et.b}}var l=t.array,d=t.stride;if(void 0!==e.vcount)for(var u=0,f=0,h=o.length;f<h;f++){var m=o[f];if(4===m){var p=u+1*s,v=u+2*s,g=u+3*s;c(u+0*s),c(p),c(g),c(p),c(v),c(g)}else if(3===m){var b=u+1*s,y=u+2*s;c(u+0*s),c(b),c(y)}else if(m>4)for(var N=1,x=m-2;N<=x;N++){var k=u+s*N,w=u+s*(N+1);c(u+0*s),c(k),c(w)}u+=s*m}else for(var A=0,T=i.length;A<T;A+=s)c(A)}function We(e){return W(Rt.geometries[e],Ve)}function ze(e){return void 0!==e.build?e.build:e}function Je(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"joint":t.joints[a.getAttribute("sid")]=Xe(a);break;case"link":t.links.push(Qe(a))}}}function Xe(e){for(var t,r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"prismatic":case"revolute":t=Ke(a)}}return t}function Ke(e){for(var t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",axis:new I.Vector3,limits:{min:0,max:0},type:e.nodeName,static:!1,zeroPosition:0,middlePosition:0},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"axis":var n=N(a.textContent);t.axis.fromArray(n);break;case"limits":var i=a.getElementsByTagName("max")[0],s=a.getElementsByTagName("min")[0];t.limits.max=parseFloat(i.textContent),t.limits.min=parseFloat(s.textContent)}}return t.limits.min>=t.limits.max&&(t.static=!0),t.middlePosition=(t.limits.min+t.limits.max)/2,t}function Qe(e){for(var t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",attachments:[],transforms:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"attachment_full":t.attachments.push(Ze(a));break;case"matrix":case"translate":case"rotate":t.transforms.push(Ye(a))}}return t}function Ze(e){for(var t={joint:e.getAttribute("joint").split("/").pop(),transforms:[],links:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"link":t.links.push(Qe(a));break;case"matrix":case"translate":case"rotate":t.transforms.push(Ye(a))}}return t}function Ye(e){var t={type:e.nodeName},r=N(e.textContent);switch(t.type){case"matrix":t.obj=new k.Matrix4,t.obj.fromArray(r).transpose();break;case"translate":t.obj=new I.Vector3,t.obj.fromArray(r);break;case"rotate":t.obj=new I.Vector3,t.obj.fromArray(r),t.angle=x.degToRad(r[3])}return t}function $e(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType&&"technique_common"===a.nodeName)et(a,t)}}function et(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"inertia":t.inertia=N(a.textContent);break;case"mass":t.mass=N(a.textContent)[0]}}}function tt(e){for(var t={target:e.getAttribute("target").split("/").pop()},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType&&"axis"===a.nodeName){var n=a.getElementsByTagName("param")[0];t.axis=n.textContent;var i=t.axis.split("inst_").pop().split("axis")[0];t.jointIndex=i.substring(0,i.length-1)}}return t}function rt(e){return void 0!==e.build?e.build:e}function at(e){for(var t=[],r=yt.querySelector('[id="'+e.id+'"]'),a=0;a<r.childNodes.length;a++){var n=r.childNodes[a];if(1===n.nodeType){var i=void 0,s=void 0;switch(n.nodeName){case"matrix":i=N(n.textContent);var o=(new k.Matrix4).fromArray(i).transpose();t.push({sid:n.getAttribute("sid"),type:n.nodeName,obj:o});break;case"translate":case"scale":i=N(n.textContent),s=(new I.Vector3).fromArray(i),t.push({sid:n.getAttribute("sid"),type:n.nodeName,obj:s});break;case"rotate":i=N(n.textContent),s=(new I.Vector3).fromArray(i);var c=x.degToRad(i[3]);t.push({sid:n.getAttribute("sid"),type:n.nodeName,obj:s,angle:c})}}}return t}var nt=new k.Matrix4,it=new I.Vector3;function st(e){for(var t={name:e.getAttribute("name")||"",type:e.getAttribute("type"),id:e.getAttribute("id"),sid:e.getAttribute("sid"),matrix:new k.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType){var n=void 0;switch(a.nodeName){case"node":t.nodes.push(a.getAttribute("id")),st(a);break;case"instance_camera":t.instanceCameras.push(U(a.getAttribute("url")));break;case"instance_controller":t.instanceControllers.push(ot(a));break;case"instance_light":t.instanceLights.push(U(a.getAttribute("url")));break;case"instance_geometry":t.instanceGeometries.push(ot(a));break;case"instance_node":t.instanceNodes.push(U(a.getAttribute("url")));break;case"matrix":n=N(a.textContent),t.matrix.multiply(nt.fromArray(n).transpose()),t.transforms[a.getAttribute("sid")]=a.nodeName;break;case"translate":n=N(a.textContent),it.fromArray(n),t.matrix.multiply(nt.makeTranslation(it.x,it.y,it.z)),t.transforms[a.getAttribute("sid")]=a.nodeName;break;case"rotate":n=N(a.textContent);var i=x.degToRad(n[3]);t.matrix.multiply(nt.makeRotationAxis(it.fromArray(n),i)),t.transforms[a.getAttribute("sid")]=a.nodeName;break;case"scale":n=N(a.textContent),t.matrix.scale(it.fromArray(n)),t.transforms[a.getAttribute("sid")]=a.nodeName;break;case"extra":break;default:console.log(a)}}}return mt(t.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",t.id):Rt.nodes[t.id]=t,t}function ot(e){for(var t={id:U(e.getAttribute("url")),materials:{},skeletons:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];switch(a.nodeName){case"bind_material":for(var n=a.getElementsByTagName("instance_material"),i=0;i<n.length;i++){var s=n[i],o=s.getAttribute("symbol"),c=s.getAttribute("target");t.materials[o]=U(c)}break;case"skeleton":t.skeletons.push(U(a.textContent))}}return t}function ct(e,t){var r,a,n,i,s=[],o=[];for(r=0;r<e.length;r++){var c=e[r];if(mt(c))lt(pt(c),t,s);else if(i=c,void 0!==Rt.visualScenes[i])for(var l=Rt.visualScenes[c].children,d=0;d<l.length;d++){var u=l[d];if("JOINT"===u.type)lt(pt(u.id),t,s)}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",c)}for(r=0;r<t.length;r++)for(a=0;a<s.length;a++)if((n=s[a]).bone.name===t[r].name){o[r]=n,n.processed=!0;break}for(r=0;r<s.length;r++)!1===(n=s[r]).processed&&(o.push(n),n.processed=!0);var f=[],h=[];for(r=0;r<o.length;r++)n=o[r],f.push(n.bone),h.push(n.boneInverse);return new M.Skeleton(f,h)}function lt(e,t,r){e.traverse((function(e){if(!0===e.isBone){for(var a,n=0;n<t.length;n++){var i=t[n];if(i.name===e.name){a=i.boneInverse;break}}void 0===a&&(a=new k.Matrix4),r.push({bone:e,boneInverse:a,processed:!1})}}))}function dt(e){for(var t,r,a=[],i=e.matrix,s=e.nodes,o=e.type,c=e.instanceCameras,l=e.instanceControllers,d=e.instanceLights,u=e.instanceGeometries,h=e.instanceNodes,m=0,p=s.length;m<p;m++)a.push(pt(s[m]));for(var v=0,g=c.length;v<g;v++){var b=Oe(c[v]);null!==b&&a.push(b.clone())}for(var y=0,N=l.length;y<N;y++)for(var x=l[y],k=(t=x.id,W(Rt.controllers[t],de)),w=ht(We(k.id),x.materials),A=ct(x.skeletons,k.skin.joints),T=0,C=w.length;T<C;T++){var E=w[T];E.isSkinnedMesh&&(E.bind(A,k.skin.bindMatrix),E.normalizeSkinWeights()),a.push(E)}for(var _=0,L=d.length;_<L;_++){var M=Be(d[_]);null!==M&&a.push(M.clone())}for(var R=0,j=u.length;R<j;R++)for(var O=u[R],S=ht(We(O.id),O.materials),I=0,q=S.length;I<q;I++)a.push(S[I]);for(var B=0,F=h.length;B<F;B++)a.push(pt(h[B]).clone());if(0===s.length&&1===a.length)r=a[0];else{r="JOINT"===o?new n.Bone:new f.Group;for(var U=0;U<a.length;U++)r.add(a[U])}return r.name="JOINT"===o?e.sid:e.name,r.matrix.copy(i),r.matrix.decompose(r.position,r.quaternion,r.scale),r}var ut=new v.MeshBasicMaterial({color:16711935});function ft(e,t){for(var r=[],a=0,n=e.length;a<n;a++){var i=t[e[a]];void 0===i?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",e[a]),r.push(ut)):r.push(_e(i))}return r}function ht(e,t){var r=[];for(var a in e){var n=e[a],i=ft(n.materialKeys,t);0===i.length&&("lines"===a||"linestrips"===a?i.push(new g.LineBasicMaterial):i.push(new m.MeshPhongMaterial));var s=void 0!==n.data.attributes.skinIndex,o=1===i.length?i[0]:i,c=void 0;switch(a){case"lines":c=new b.LineSegments(n.data,o);break;case"linestrips":c=new h.Line(n.data,o);break;case"triangles":case"polylist":c=s?new R.SkinnedMesh(n.data,o):new w.Mesh(n.data,o)}r.push(c)}return r}function mt(e){return void 0!==Rt.nodes[e]}function pt(e){return W(Rt.nodes[e],dt)}function vt(e){var t=new f.Group;t.name=e.name;for(var r=e.children,a=0;a<r.length;a++){var n=r[a];t.add(pt(n.id))}return t}function gt(e){return W(Rt.visualScenes[e],vt)}if(0===e.length)return{scene:new L.Scene};var bt=(new DOMParser).parseFromString(e,"application/xml"),yt=d(bt,"COLLADA")[0],Nt=bt.getElementsByTagName("parsererror")[0];if(void 0!==Nt){var xt,kt=d(Nt,"div")[0];return xt=kt?kt.textContent:function(e){for(var t="",r=[e];r.length;){var a=r.shift();a.nodeType===Node.TEXT_NODE?t+=a.textContent:(t+="\n",r.push.apply(r,a.childNodes))}return t.trim()}(Nt),console.error("THREE.ColladaLoader: Failed to parse collada file.\n",xt),null}var wt=yt.getAttribute("version");console.log("THREE.ColladaLoader: File version",wt);var At,Tt=function(e){return{unit:P(d(e,"unit")[0]),upAxis:V(d(e,"up_axis")[0])}}(d(yt,"asset")[0]),Ct=new O.TextureLoader(this.manager);Ct.setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin),B.TGALoader&&(At=new B.TGALoader(this.manager)).setPath(this.resourcePath||t);var Et=new o.Color,_t=[],Lt={},Mt=0,Rt={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};G(yt,"library_animations","animation",(function e(t){for(var r={sources:{},samplers:{},channels:{}},a=!1,n=0,i=t.childNodes.length;n<i;n++){var s=t.childNodes[n];if(1===s.nodeType){var o=void 0;switch(s.nodeName){case"source":o=s.getAttribute("id"),r.sources[o]=Fe(s);break;case"sampler":o=s.getAttribute("id"),r.samplers[o]=z(s);break;case"channel":o=s.getAttribute("target"),r.channels[o]=J(s);break;case"animation":e(s),a=!0;break;default:console.log(s)}}}!1===a&&(Rt.animations[t.getAttribute("id")||x.generateUUID()]=r)})),G(yt,"library_animation_clips","animation_clip",(function(e){for(var t={name:e.getAttribute("id")||"default",start:parseFloat(e.getAttribute("start")||0),end:parseFloat(e.getAttribute("end")||0),animations:[]},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"instance_animation"===n.nodeName)t.animations.push(U(n.getAttribute("url")))}Rt.clips[e.getAttribute("id")]=t})),G(yt,"library_controllers","controller",(function(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"skin":t.id=U(n.getAttribute("source")),t.skin=oe(n);break;case"morph":t.id=U(n.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.")}}Rt.controllers[e.getAttribute("id")]=t})),G(yt,"library_images","image",(function(e){var t={init_from:d(e,"init_from")[0].textContent};Rt.images[e.getAttribute("id")]=t})),G(yt,"library_effects","effect",(function(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"profile_COMMON"===n.nodeName)t.profile=he(n)}Rt.effects[e.getAttribute("id")]=t})),G(yt,"library_materials","material",(function(e){for(var t={name:e.getAttribute("name")},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"instance_effect"===n.nodeName)t.url=U(n.getAttribute("url"))}Rt.materials[e.getAttribute("id")]=t})),G(yt,"library_cameras","camera",(function(e){for(var t={name:e.getAttribute("name")},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"optics"===n.nodeName)t.optics=Le(n)}Rt.cameras[e.getAttribute("id")]=t})),G(yt,"library_lights","light",(function(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType&&"technique_common"===n.nodeName)t=Se(n)}Rt.lights[e.getAttribute("id")]=t})),G(yt,"library_geometries","geometry",(function(e){var t={name:e.getAttribute("name"),sources:{},vertices:{},primitives:[]},r=d(e,"mesh")[0];if(void 0!==r){for(var a=0;a<r.childNodes.length;a++){var n=r.childNodes[a];if(1===n.nodeType){var i=n.getAttribute("id");switch(n.nodeName){case"source":t.sources[i]=Fe(n);break;case"vertices":t.vertices=Ue(n);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",n.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":t.primitives.push(He(n));break;default:console.log(n)}}}Rt.geometries[e.getAttribute("id")]=t}})),G(yt,"library_nodes","node",st),G(yt,"library_visual_scenes","visual_scene",(function(e){var t={name:e.getAttribute("name"),children:[]};!function(e){for(var t=e.getElementsByTagName("node"),r=0;r<t.length;r++){var a=t[r];!1===a.hasAttribute("id")&&a.setAttribute("id","three_default_"+Mt++)}}(e);for(var r=d(e,"node"),a=0;a<r.length;a++)t.children.push(st(r[a]));Rt.visualScenes[e.getAttribute("id")]=t})),G(yt,"library_kinematics_models","kinematics_model",(function(e){for(var t={name:e.getAttribute("name")||"",joints:{},links:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType&&"technique_common"===a.nodeName)Je(a,t)}Rt.kinematicsModels[e.getAttribute("id")]=t})),G(yt,"library_physics_models","physics_model",(function(e){for(var t={name:e.getAttribute("name")||"",rigidBodies:{}},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType&&"rigid_body"===a.nodeName)t.rigidBodies[a.getAttribute("name")]={},$e(a,t.rigidBodies[a.getAttribute("name")])}Rt.physicsModels[e.getAttribute("id")]=t})),G(yt,"scene","instance_kinematics_scene",(function(e){for(var t={bindJointAxis:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType&&"bind_joint_axis"===a.nodeName)t.bindJointAxis.push(tt(a))}Rt.kinematicsScenes[U(e.getAttribute("url"))]=t})),D(Rt.animations,X),D(Rt.clips,ie),D(Rt.controllers,de),D(Rt.images,ue),D(Rt.effects,Ce),D(Rt.materials,Ee),D(Rt.cameras,je),D(Rt.lights,qe),D(Rt.geometries,Ve),D(Rt.visualScenes,vt),function(){var e=Rt.clips;if(!0===H(e)){if(!1===H(Rt.animations)){var t=[];for(var r in Rt.animations)for(var n=K(r),i=0,s=n.length;i<s;i++)t.push(n[i]);_t.push(new a.AnimationClip("default",-1,t))}}else for(var o in e)_t.push(se(o))}(),function(){var e=Object.keys(Rt.kinematicsModels)[0],t=Object.keys(Rt.kinematicsScenes)[0],r=Object.keys(Rt.visualScenes)[0];if(void 0!==e&&void 0!==t){for(var a,n=(a=e,W(Rt.kinematicsModels[a],ze)),i=function(e){return W(Rt.kinematicsScenes[e],rt)}(t),s=gt(r),o=i.bindJointAxis,c={},l=0,d=o.length;l<d;l++){var u=o[l],f=yt.querySelector('[sid="'+u.target+'"]');if(f){var h=f.parentElement;p(u.jointIndex,h)}}var m=new k.Matrix4;Lt={joints:n&&n.joints,getJointValue:function(e){var t=c[e];if(t)return t.position;console.warn("THREE.ColladaLoader: Joint "+e+" doesn't exist.")},setJointValue:function(e,t){var r=c[e];if(r){var a=r.joint;if(t>a.limits.max||t<a.limits.min)console.warn("THREE.ColladaLoader: Joint "+e+" value "+t+" outside of limits (min: "+a.limits.min+", max: "+a.limits.max+").");else if(a.static)console.warn("THREE.ColladaLoader: Joint "+e+" is static.");else{var n=r.object,i=a.axis,s=r.transforms;nt.identity();for(var o=0;o<s.length;o++){var l=s[o];if(l.sid&&-1!==l.sid.indexOf(e))switch(a.type){case"revolute":nt.multiply(m.makeRotationAxis(i,x.degToRad(t)));break;case"prismatic":nt.multiply(m.makeTranslation(i.x*t,i.y*t,i.z*t));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+a.type)}else switch(l.type){case"matrix":nt.multiply(l.obj);break;case"translate":nt.multiply(m.makeTranslation(l.obj.x,l.obj.y,l.obj.z));break;case"scale":nt.scale(l.obj);break;case"rotate":nt.multiply(m.makeRotationAxis(l.obj,l.angle))}}n.matrix.copy(nt),n.matrix.decompose(n.position,n.quaternion,n.scale),c[e].position=t}}else console.log("THREE.ColladaLoader: "+e+" does not exist.")}}}function p(e,t){var r=t.getAttribute("name"),a=n.joints[e];s.traverse((function(n){n.name===r&&(c[e]={object:n,transforms:at(t),joint:a,position:a.zeroPosition})}))}}();var jt=function(e){return gt(U(d(e,"instance_visual_scene")[0].getAttribute("url")))}(d(yt,"scene")[0]);return jt.animations=_t,"Z_UP"===Tt.upAxis&&jt.quaternion.setFromEuler(new l.Euler(-Math.PI/2,0,0)),jt.scale.multiplyScalar(Tt.unit),{get animations(){return console.warn("THREE.ColladaLoader: Please access animations over scene.animations now."),_t},kinematics:Lt,library:Rt,scene:jt}},y}(y.Loader);e.ColladaLoader=F,Object.defineProperty(e,"__esModule",{value:!0})}));

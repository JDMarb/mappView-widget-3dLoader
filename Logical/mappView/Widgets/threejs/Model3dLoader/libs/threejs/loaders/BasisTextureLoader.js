/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","../textures/CompressedTexture","./FileLoader","../constants","./Loader"],(function(e,r,t,a,o,i){"use strict";var n=new WeakMap,s=function(e){function i(r){var t;return(t=e.call(this,r)||this).transcoderPath="",t.transcoderBinary=null,t.transcoderPending=null,t.workerLimit=4,t.workerPool=[],t.workerNextTaskID=1,t.workerSourceURL="",t.workerConfig=null,console.warn("THREE.BasisTextureLoader: This loader is deprecated, and will be removed in a future release. Instead, use Basis Universal compression in KTX2 (.ktx2) files with THREE.KTX2Loader."),t}r.inheritsLoose(i,e);var s=i.prototype;return s.setTranscoderPath=function(e){return this.transcoderPath=e,this},s.setWorkerLimit=function(e){return this.workerLimit=e,this},s.detectSupport=function(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this},s.load=function(e,r,o,i){var s=this,d=new a.FileLoader(this.manager);d.setResponseType("arraybuffer"),d.setWithCredentials(this.withCredentials);var c=new t.CompressedTexture;return d.load(e,(function(e){if(n.has(e))return n.get(e).promise.then(r).catch(i);s._createTexture([e]).then((function(e){c.copy(e),c.needsUpdate=!0,r&&r(c)})).catch(i)}),o,i),c},s.parseInternalAsync=function(e){for(var t=e.levels,a=new Set,o=0;o<t.length;o++)a.add(t[o].data.buffer);return this._createTexture(Array.from(a),r.extends({},e,{lowLevel:!0}))},s._createTexture=function(e,r){var a,i,s=this;void 0===r&&(r={});for(var d=r,c=0,h=0;h<e.length;h++)c+=e[h].byteLength;var l=this._allocateWorker(c).then((function(r){return a=r,i=s.workerNextTaskID++,new Promise((function(r,t){a._callbacks[i]={resolve:r,reject:t},a.postMessage({type:"transcode",id:i,buffers:e,taskConfig:d},e)}))})).then((function(e){var r=e.mipmaps,a=e.width,i=e.height,n=e.format,s=new t.CompressedTexture(r,a,i,n,o.UnsignedByteType);return s.minFilter=1===r.length?o.LinearFilter:o.LinearMipmapLinearFilter,s.magFilter=o.LinearFilter,s.generateMipmaps=!1,s.needsUpdate=!0,s}));return l.catch((function(){return!0})).then((function(){a&&i&&(a._taskLoad-=c,delete a._callbacks[i])})),n.set(e[0],{promise:l}),l},s._initTranscoder=function(){var e=this;if(!this.transcoderPending){var r=new a.FileLoader(this.manager);r.setPath(this.transcoderPath),r.setWithCredentials(this.withCredentials);var t=new Promise((function(e,t){r.load("basis_transcoder.js",e,void 0,t)})),o=new a.FileLoader(this.manager);o.setPath(this.transcoderPath),o.setResponseType("arraybuffer"),o.setWithCredentials(this.withCredentials);var n=new Promise((function(e,r){o.load("basis_transcoder.wasm",e,void 0,r)}));this.transcoderPending=Promise.all([t,n]).then((function(r){var t=r[0],a=r[1],o=i.BasisWorker.toString(),n=["/* constants */","let _EngineFormat = "+JSON.stringify(i.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(i.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(i.BasisFormat),"/* basis_transcoder.js */",t,"/* worker */",o.substring(o.indexOf("{")+1,o.lastIndexOf("}"))].join("\n");e.workerSourceURL=URL.createObjectURL(new Blob([n])),e.transcoderBinary=a}))}return this.transcoderPending},s._allocateWorker=function(e){var r=this;return this._initTranscoder().then((function(){if(r.workerPool.length<r.workerLimit){var t=new Worker(r.workerSourceURL);t._callbacks={},t._taskLoad=0,t.postMessage({type:"init",config:r.workerConfig,transcoderBinary:r.transcoderBinary}),t.onmessage=function(e){var r=e.data;switch(r.type){case"transcode":t._callbacks[r.id].resolve(r);break;case"error":t._callbacks[r.id].reject(r);break;default:console.error('THREE.BasisTextureLoader: Unexpected message, "'+r.type+'"')}},r.workerPool.push(t)}else r.workerPool.sort((function(e,r){return e._taskLoad>r._taskLoad?-1:1}));var a=r.workerPool[r.workerPool.length-1];return a._taskLoad+=e,a}))},s.dispose=function(){for(var e=0;e<this.workerPool.length;e++)this.workerPool[e].terminate();return this.workerPool.length=0,this},i}(i.Loader);s.BasisFormat={ETC1S:0,UASTC_4x4:1},s.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},s.EngineFormat={RGBAFormat:o.RGBAFormat,RGBA_ASTC_4x4_Format:o.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:o.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:o.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:o.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:o.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:o.RGB_ETC1_Format,RGB_ETC2_Format:o.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:o.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:o.RGB_S3TC_DXT1_Format},s.BasisWorker=function(){var e,r,t,a=_EngineFormat,o=_TranscoderFormat,i=_BasisFormat;onmessage=function(a){var o,n=a.data;switch(n.type){case"init":e=n.config,o=n.transcoderBinary,r=new Promise((function(e){t={wasmBinary:o,onRuntimeInitialized:e},BASIS(t)})).then((function(){t.initializeBasis()}));break;case"transcode":r.then((function(){try{for(var e=n.taskConfig.lowLevel?function(e){var r=e.basisFormat,a=e.width,o=e.height,n=e.hasAlpha,s=c(r,a,o,n),d=s.transcoderFormat,T=s.engineFormat,u=t.getBytesPerBlockOrPixel(d);h(t.isFormatSupported(d),"THREE.BasisTextureLoader: Unsupported format.");var f=[];if(r===i.ETC1S){var p=new t.LowLevelETC1SImageTranscoder,g=e.globalData,B=g.endpointCount,C=g.endpointsData,w=g.selectorCount,F=g.selectorsData,E=g.tablesData;try{h(p.decodePalettes(B,C,w,F),"THREE.BasisTextureLoader: decodePalettes() failed."),h(p.decodeTables(E),"THREE.BasisTextureLoader: decodeTables() failed.");for(var R=0;R<e.levels.length;R++){var S=e.levels[R],A=e.globalData.imageDescs[R],P=m(d,S.width,S.height),x=new Uint8Array(P);h(p.transcodeImage(d,x,P/u,S.data,l(d,S.width),_(d,S.height),S.width,S.height,S.index,A.rgbSliceByteOffset,A.rgbSliceByteLength,A.alphaSliceByteOffset,A.alphaSliceByteLength,A.imageFlags,n,!1,0,0),"THREE.BasisTextureLoader: transcodeImage() failed for level "+S.index+"."),f.push({data:x,width:S.width,height:S.height})}}finally{p.delete()}}else for(var v=0;v<e.levels.length;v++){var y=e.levels[v],L=m(d,y.width,y.height),G=new Uint8Array(L);h(t.transcodeUASTCImage(d,G,L/u,y.data,l(d,y.width),_(d,y.height),y.width,y.height,y.index,0,y.data.byteLength,0,n,!1,0,0,-1,-1),"THREE.BasisTextureLoader: transcodeUASTCImage() failed for level "+y.index+"."),f.push({data:G,width:y.width,height:y.height})}return{width:a,height:o,hasAlpha:n,mipmaps:f,format:T}}(n.taskConfig):function(e){var r=new t.BasisFile(new Uint8Array(e)),a=r.isUASTC()?i.UASTC_4x4:i.ETC1S,o=r.getImageWidth(0,0),n=r.getImageHeight(0,0),s=r.getNumLevels(0),d=r.getHasAlpha();function h(){r.close(),r.delete()}var l=c(a,o,n,d),_=l.transcoderFormat,m=l.engineFormat;if(!o||!n||!s)throw h(),new Error("THREE.BasisTextureLoader:\tInvalid texture");if(!r.startTranscoding())throw h(),new Error("THREE.BasisTextureLoader: .startTranscoding failed");for(var T=[],u=0;u<s;u++){var f=r.getImageWidth(0,u),p=r.getImageHeight(0,u),g=new Uint8Array(r.getImageTranscodedSizeInBytes(0,u,_));if(!r.transcodeImage(g,0,u,_,0,d))throw h(),new Error("THREE.BasisTextureLoader: .transcodeImage failed.");T.push({data:g,width:f,height:p})}return h(),{width:o,height:n,hasAlpha:d,mipmaps:T,format:m}}(n.buffers[0]),r=e.width,a=e.height,o=e.hasAlpha,s=e.mipmaps,d=e.format,T=[],u=0;u<s.length;++u)T.push(s[u].data.buffer);self.postMessage({type:"transcode",id:n.id,width:r,height:a,hasAlpha:o,mipmaps:s,format:d},T)}catch(e){console.error(e),self.postMessage({type:"error",id:n.id,error:e.message})}}))}};var n=[{if:"astcSupported",basisFormat:[i.UASTC_4x4],transcoderFormat:[o.ASTC_4x4,o.ASTC_4x4],engineFormat:[a.RGBA_ASTC_4x4_Format,a.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[i.ETC1S,i.UASTC_4x4],transcoderFormat:[o.BC7_M5,o.BC7_M5],engineFormat:[a.RGBA_BPTC_Format,a.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[i.ETC1S,i.UASTC_4x4],transcoderFormat:[o.BC1,o.BC3],engineFormat:[a.RGB_S3TC_DXT1_Format,a.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[i.ETC1S,i.UASTC_4x4],transcoderFormat:[o.ETC1,o.ETC2],engineFormat:[a.RGB_ETC2_Format,a.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[i.ETC1S,i.UASTC_4x4],transcoderFormat:[o.ETC1,o.ETC1],engineFormat:[a.RGB_ETC1_Format,a.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[i.ETC1S,i.UASTC_4x4],transcoderFormat:[o.PVRTC1_4_RGB,o.PVRTC1_4_RGBA],engineFormat:[a.RGB_PVRTC_4BPPV1_Format,a.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],s=n.sort((function(e,r){return e.priorityETC1S-r.priorityETC1S})),d=n.sort((function(e,r){return e.priorityUASTC-r.priorityUASTC}));function c(r,t,n,c){for(var h=r===i.ETC1S?s:d,l=0;l<h.length;l++){var _=h[l];if(e[_.if]&&(_.basisFormat.includes(r)&&(!_.needsPowerOfTwo||T(t)&&T(n))))return{transcoderFormat:_.transcoderFormat[c?1:0],engineFormat:_.engineFormat[c?1:0]}}return console.warn("THREE.BasisTextureLoader: No suitable compressed texture format found. Decoding to RGBA32."),{transcoderFormat:o.RGBA32,engineFormat:a.RGBAFormat}}function h(e,r){if(!e)throw new Error(r)}function l(e,r){return Math.ceil(r/t.getFormatBlockWidth(e))}function _(e,r){return Math.ceil(r/t.getFormatBlockHeight(e))}function m(e,r,a){var i=t.getBytesPerBlockOrPixel(e);if(t.formatIsUncompressed(e))return r*a*i;if(e===o.PVRTC1_4_RGB||e===o.PVRTC1_4_RGBA){var n=r+3&-4,s=a+3&-4;return(Math.max(8,n)*Math.max(8,s)*4+7)/8}return l(e,r)*_(e,a)*i}function T(e){return e<=2||0==(e&e-1)&&0!==e}},e.BasisTextureLoader=s,Object.defineProperty(e,"__esModule",{value:!0})}));

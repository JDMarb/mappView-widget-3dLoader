/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","../core/BufferAttribute","../core/BufferGeometry","../math/Color","./FileLoader","../objects/Group","../materials/LineBasicMaterial","../objects/LineSegments","./Loader","../math/Matrix4","../objects/Mesh","../materials/MeshStandardMaterial","../materials/ShaderMaterial","../renderers/shaders/UniformsLib","../renderers/shaders/UniformsUtils","../math/Vector3","../math/Ray"],(function(e,t,r,n,a,i,o,s,l,c,u,d,h,p,f,g,m,v){"use strict";var b="16",C="24",w=new m.Vector3,M=new m.Vector3,y=function(e){function r(r){var n;return n=e.call(this,{uniforms:g.UniformsUtils.merge([f.UniformsLib.fog,{diffuse:{value:new a.Color},opacity:{value:1}}]),vertexShader:"\n\t\t\t\tattribute vec3 control0;\n\t\t\t\tattribute vec3 control1;\n\t\t\t\tattribute vec3 direction;\n\t\t\t\tvarying float discardFlag;\n\n\t\t\t\t#include <common>\n\t\t\t\t#include <color_pars_vertex>\n\t\t\t\t#include <fog_pars_vertex>\n\t\t\t\t#include <logdepthbuf_pars_vertex>\n\t\t\t\t#include <clipping_planes_pars_vertex>\n\t\t\t\tvoid main() {\n\t\t\t\t\t#include <color_vertex>\n\n\t\t\t\t\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t\tgl_Position = projectionMatrix * mvPosition;\n\n\t\t\t\t\t// Transform the line segment ends and control points into camera clip space\n\t\t\t\t\tvec4 c0 = projectionMatrix * modelViewMatrix * vec4( control0, 1.0 );\n\t\t\t\t\tvec4 c1 = projectionMatrix * modelViewMatrix * vec4( control1, 1.0 );\n\t\t\t\t\tvec4 p0 = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t\tvec4 p1 = projectionMatrix * modelViewMatrix * vec4( position + direction, 1.0 );\n\n\t\t\t\t\tc0.xy /= c0.w;\n\t\t\t\t\tc1.xy /= c1.w;\n\t\t\t\t\tp0.xy /= p0.w;\n\t\t\t\t\tp1.xy /= p1.w;\n\n\t\t\t\t\t// Get the direction of the segment and an orthogonal vector\n\t\t\t\t\tvec2 dir = p1.xy - p0.xy;\n\t\t\t\t\tvec2 norm = vec2( -dir.y, dir.x );\n\n\t\t\t\t\t// Get control point directions from the line\n\t\t\t\t\tvec2 c0dir = c0.xy - p1.xy;\n\t\t\t\t\tvec2 c1dir = c1.xy - p1.xy;\n\n\t\t\t\t\t// If the vectors to the controls points are pointed in different directions away\n\t\t\t\t\t// from the line segment then the line should not be drawn.\n\t\t\t\t\tfloat d0 = dot( normalize( norm ), normalize( c0dir ) );\n\t\t\t\t\tfloat d1 = dot( normalize( norm ), normalize( c1dir ) );\n\t\t\t\t\tdiscardFlag = float( sign( d0 ) != sign( d1 ) );\n\n\t\t\t\t\t#include <logdepthbuf_vertex>\n\t\t\t\t\t#include <clipping_planes_vertex>\n\t\t\t\t\t#include <fog_vertex>\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\t\t\tuniform vec3 diffuse;\n\t\t\tuniform float opacity;\n\t\t\tvarying float discardFlag;\n\n\t\t\t#include <common>\n\t\t\t#include <color_pars_fragment>\n\t\t\t#include <fog_pars_fragment>\n\t\t\t#include <logdepthbuf_pars_fragment>\n\t\t\t#include <clipping_planes_pars_fragment>\n\t\t\tvoid main() {\n\n\t\t\t\tif ( discardFlag > 0.5 ) discard;\n\n\t\t\t\t#include <clipping_planes_fragment>\n\t\t\t\tvec3 outgoingLight = vec3( 0.0 );\n\t\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t\t\t\t#include <logdepthbuf_fragment>\n\t\t\t\t#include <color_fragment>\n\t\t\t\toutgoingLight = diffuseColor.rgb; // simple shader\n\t\t\t\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t\t\t\t#include <tonemapping_fragment>\n\t\t\t\t#include <encodings_fragment>\n\t\t\t\t#include <fog_fragment>\n\t\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t}\n\t\t\t"})||this,Object.defineProperties(t.assertThisInitialized(n),{opacity:{get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},color:{get:function(){return this.uniforms.diffuse.value}}}),n.setValues(r),n.isLDrawConditionalLineMaterial=!0,n}return t.inheritsLoose(r,e),r}(p.ShaderMaterial),L=function(e){function r(t,r){var n;return(n=e.call(this,t,r)||this).isConditionalLine=!0,n}return t.inheritsLoose(r,e),r}(l.LineSegments);function k(e){for(var t=0,r=e.length;t<r;t++){var n=e[t],a=n.vertices,i=a[0],o=a[1],s=a[2];w.subVectors(o,i),M.subVectors(s,o),n.faceNormal=(new m.Vector3).crossVectors(w,M).normalize()}}var x=new v.Ray;function S(e,t,r){void 0===r&&(r=!1);var n=100*(1+1e-10);function a(e){return~~(e.x*n)+","+~~(e.y*n)+","+~~(e.z*n)}function i(e,t){return a(e)+"_"+a(t)}function o(e,t,r){r.direction.subVectors(t,e).normalize();var n=e.dot(r.direction);return r.origin.copy(e).addScaledVector(r.direction,-n),r}function s(e){return i(e.origin,e.direction)}for(var l=new Set,c=new Map,u={},d=[],h=0,p=t.length;h<p;h++){var f=t[h].vertices,g=f[0],b=f[1];if(l.add(i(g,b)),l.add(i(b,g)),r){var C=o(g,b,new v.Ray),w=s(C);if(!c.has(w)){o(b,g,C);var M=s(C),y={ray:C,distances:[]};c.set(w,y),c.set(M,y)}var L=c.get(w),k=L.ray.direction.dot(g),S=L.ray.direction.dot(b);if(k>S){var T=[S,k];k=T[0],S=T[1]}L.distances.push(k,S)}}for(var D=0,E=e.length;D<E;D++)for(var _=e[D],N=_.vertices,R=N.length,V=0;V<R;V++){var F=V,A=(V+1)%R,I=N[F],P=N[A],G=i(I,P);if(!l.has(G)){if(r){o(I,P,x);var z=s(x);if(c.has(z)){var O=c.get(z),U=O.ray,W=O.distances,B=U.direction.dot(I),j=U.direction.dot(P);if(B>j){var H=[j,B];B=H[0],j=H[1]}for(var q=!1,Y=0,K=W.length;Y<K;Y+=2)if(B>=W[Y]&&j<=W[Y+1]){q=!0;break}if(q)continue}}var X={index:F,tri:_};u[G]=X}}for(;;){var J=null;for(var Q in u){J=u[Q];break}if(null===J)break;for(var Z=[J];Z.length>0;)for(var $=Z.pop().tri,ee=$.vertices,te=$.normals,re=$.faceNormal,ne=ee.length,ae=0;ae<ne;ae++){var ie=ae,oe=(ae+1)%ne,se=ee[ie],le=ee[oe];delete u[i(se,le)];var ce=i(le,se),ue=u[ce];if(ue){var de=ue.tri,he=ue.index,pe=de.normals,fe=pe.length,ge=de.faceNormal;if(Math.abs(de.faceNormal.dot($.faceNormal))<.25)continue;ce in u&&(Z.push(ue),delete u[ce]);var me=(he+1)%fe;te[ie]&&pe[me]&&te[ie]!==pe[me]&&(pe[me].norm.add(te[ie].norm),te[ie].norm=pe[me].norm);var ve=te[ie]||pe[me];null===ve&&(ve={norm:new m.Vector3},d.push(ve.norm)),null===te[ie]&&(te[ie]=ve,ve.norm.add(re)),null===pe[me]&&(pe[me]=ve,ve.norm.add(ge)),te[oe]&&pe[he]&&te[oe]!==pe[he]&&(pe[he].norm.add(te[oe].norm),te[oe].norm=pe[he].norm);var be=te[oe]||pe[he];null===be&&(be={norm:new m.Vector3},d.push(be.norm)),null===te[oe]&&(te[oe]=be,be.norm.add(re)),null===pe[he]&&(pe[he]=be,be.norm.add(ge))}}}for(var Ce=0,we=d.length;Ce<we;Ce++)d[Ce].normalize()}function T(e){return"Part"===e||"Unofficial_Part"===e}var D=function(){function e(e,t){this.line=e,this.lineLength=e.length,this.currentCharIndex=0,this.currentChar=" ",this.lineNumber=t}var t=e.prototype;return t.seekNonSpace=function(){for(;this.currentCharIndex<this.lineLength;){if(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"\t"!==this.currentChar)return;this.currentCharIndex++}},t.getToken=function(){for(var e=this.currentCharIndex++;this.currentCharIndex<this.lineLength&&(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"\t"!==this.currentChar);)this.currentCharIndex++;var t=this.currentCharIndex;return this.seekNonSpace(),this.line.substring(e,t)},t.getVector=function(){return new m.Vector3(parseFloat(this.getToken()),parseFloat(this.getToken()),parseFloat(this.getToken()))},t.getRemainingString=function(){return this.line.substring(this.currentCharIndex,this.lineLength)},t.isAtTheEnd=function(){return this.currentCharIndex>=this.lineLength},t.setToEnd=function(){this.currentCharIndex=this.lineLength},t.getLineNumberString=function(){return this.lineNumber>=0?" at line "+this.lineNumber:""},e}(),E=function(){function e(e){this.loader=e,this._cache={}}var r=e.prototype;return r.cloneResult=function(e){var t={};return t.faces=e.faces.map((function(e){return{colorCode:e.colorCode,material:e.material,vertices:e.vertices.map((function(e){return e.clone()})),normals:e.normals.map((function(){return null})),faceNormal:null}})),t.conditionalSegments=e.conditionalSegments.map((function(e){return{colorCode:e.colorCode,material:e.material,vertices:e.vertices.map((function(e){return e.clone()})),controlPoints:e.controlPoints.map((function(e){return e.clone()}))}})),t.lineSegments=e.lineSegments.map((function(e){return{colorCode:e.colorCode,material:e.material,vertices:e.vertices.map((function(e){return e.clone()}))}})),t.type=e.type,t.category=e.category,t.keywords=e.keywords,t.subobjects=e.subobjects,t.totalFaces=e.totalFaces,t.startingConstructionStep=e.startingConstructionStep,t.materials=e.materials,t.group=null,t},r.fetchData=function(){var e=t.asyncToGenerator(t.regeneratorRuntime().mark((function e(r){var n,a,o,s,l,c;return t.regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!1,a=0;case 2:if(6===a){e.next=40;break}o=r,e.t0=a,e.next=0===e.t0?7:1===e.t0?9:2===e.t0?12:3===e.t0?15:4===e.t0?18:5===e.t0?21:23;break;case 7:return a+=1,e.abrupt("break",23);case 9:return o="parts/"+o,a+=1,e.abrupt("break",23);case 12:return o="p/"+o,a+=1,e.abrupt("break",23);case 15:return o="models/"+o,a+=1,e.abrupt("break",23);case 18:return o=r.substring(0,r.lastIndexOf("/")+1)+o,a+=1,e.abrupt("break",23);case 21:return n?a=6:(r=r.toLowerCase(),o=r,n=!0,a=0),e.abrupt("break",23);case 23:return s=this.loader,(l=new i.FileLoader(s.manager)).setPath(s.partsLibraryPath),l.setRequestHeader(s.requestHeader),l.setWithCredentials(s.withCredentials),e.prev=28,e.next=31,l.loadAsync(o);case 31:return c=e.sent,e.abrupt("return",c);case 35:return e.prev=35,e.t1=e.catch(28),e.abrupt("continue",2);case 38:e.next=2;break;case 40:throw new Error('LDrawLoader: Subobject "'+r+'" could not be loaded.');case 41:case"end":return e.stop()}}),e,this,[[28,35]])})));return function(t){return e.apply(this,arguments)}}(),r.parse=function(e,t){void 0===t&&(t=null);var r=this.loader,n=[],a=[],i=[],o=[],s={},l=function(e){return s[e]||null},c="Model",d=null,h=null,p=0;-1!==e.indexOf("\r\n")&&(e=e.replace(/\r\n/g,"\n"));for(var f=e.split("\n"),g=f.length,m=!1,v=null,b=null,C=!1,w=!0,M=!1,y=!0,L=!1,k=0;k<g;k++){var x=f[k];if(0!==x.length)if(m)x.startsWith("0 FILE ")?(this.setData(v,b),v=x.substring(7),b=""):b+=x+"\n";else{var S=new D(x,k+1);if(S.seekNonSpace(),!S.isAtTheEnd()){var T=S.getToken(),E=void 0,_=void 0,N=void 0,R=void 0,V=void 0,F=void 0,A=void 0,I=void 0;switch(T){case"0":var P=S.getToken();if(P)switch(P){case"!LDRAW_ORG":c=S.getToken();break;case"!COLOUR":(E=r.parseColorMetaDirective(S))?s[E.userData.code]=E:console.warn("LDrawLoader: Error parsing material"+S.getLineNumberString());break;case"!CATEGORY":d=S.getToken();break;case"!KEYWORDS":var G=S.getRemainingString().split(",");G.length>0&&(h||(h=[]),G.forEach((function(e){h.push(e.trim())})));break;case"FILE":k>0&&(m=!0,v=S.getRemainingString(),b="",C=!1,w=!0);break;case"BFC":for(;!S.isAtTheEnd();){var z=S.getToken();switch(z){case"CERTIFY":case"NOCERTIFY":C="CERTIFY"===z,w=!0;break;case"CW":case"CCW":w="CCW"===z;break;case"INVERTNEXT":M=!0;break;case"CLIP":case"NOCLIP":y="CLIP"===z;break;default:console.warn('THREE.LDrawLoader: BFC directive "'+z+'" is unknown.')}}break;case"STEP":L=!0}break;case"1":E=l(_=S.getToken());var O=parseFloat(S.getToken()),U=parseFloat(S.getToken()),W=parseFloat(S.getToken()),B=parseFloat(S.getToken()),j=parseFloat(S.getToken()),H=parseFloat(S.getToken()),q=parseFloat(S.getToken()),Y=parseFloat(S.getToken()),K=parseFloat(S.getToken()),X=parseFloat(S.getToken()),J=parseFloat(S.getToken()),Q=parseFloat(S.getToken()),Z=(new u.Matrix4).set(B,j,H,O,q,Y,K,U,X,J,Q,W,0,0,0,1),$=S.getRemainingString().trim().replace(/\\/g,"/");r.fileMap[$]?$=r.fileMap[$]:$.startsWith("s/")?$="parts/"+$:$.startsWith("48/")&&($="p/"+$),o.push({material:E,colorCode:_,matrix:Z,fileName:$,inverted:M,startingConstructionStep:L}),M=!1;break;case"2":N={material:E=l(_=S.getToken()),colorCode:_,vertices:[V=S.getVector(),F=S.getVector()]},a.push(N);break;case"5":N={material:E=l(_=S.getToken()),colorCode:_,vertices:[V=S.getVector(),F=S.getVector()],controlPoints:[S.getVector(),S.getVector()]},i.push(N);break;case"3":E=l(_=S.getToken()),R=!C||!y,!0===w?(V=S.getVector(),F=S.getVector(),A=S.getVector()):(A=S.getVector(),F=S.getVector(),V=S.getVector()),n.push({material:E,colorCode:_,faceNormal:null,vertices:[V,F,A],normals:[null,null,null]}),p++,!0===R&&(n.push({material:E,colorCode:_,faceNormal:null,vertices:[A,F,V],normals:[null,null,null]}),p++);break;case"4":E=l(_=S.getToken()),R=!C||!y,!0===w?(V=S.getVector(),F=S.getVector(),A=S.getVector(),I=S.getVector()):(I=S.getVector(),A=S.getVector(),F=S.getVector(),V=S.getVector()),n.push({material:E,colorCode:_,faceNormal:null,vertices:[V,F,A,I],normals:[null,null,null,null]}),p+=2,!0===R&&(n.push({material:E,colorCode:_,faceNormal:null,vertices:[I,A,F,V],normals:[null,null,null,null]}),p+=2);break;default:throw new Error('LDrawLoader: Unknown line type "'+T+'"'+S.getLineNumberString()+".")}}}}return m&&this.setData(v,b),{faces:n,conditionalSegments:i,lineSegments:a,type:c,category:d,keywords:h,subobjects:o,totalFaces:p,startingConstructionStep:L,materials:s,fileName:t,group:null}},r.getData=function(e,t){void 0===t&&(t=!0);var r=e.toLowerCase(),n=this._cache[r];return null===n||n instanceof Promise?null:t?this.cloneResult(n):n},r.ensureDataLoaded=function(){var e=t.asyncToGenerator(t.regeneratorRuntime().mark((function e(r){var n,a=this;return t.regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=r.toLowerCase())in this._cache||(this._cache[n]=this.fetchData(r).then((function(e){var t=a.parse(e,r);return a._cache[n]=t,t}))),e.next=4,this._cache[n];case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),r.setData=function(e,t){var r=e.toLowerCase();this._cache[r]=this.parse(t,e)},e}();function _(e,t,r,n){return(!n&&e===b||n&&e===C)&&(e=t),r[e]||null}var N=function(){function e(e){this.loader=e,this.parseCache=new E(e),this._cache={}}var r=e.prototype;return r.processIntoMesh=function(){var e=t.asyncToGenerator(t.regeneratorRuntime().mark((function e(r){var n,a,i,s,l,c,u,d,h=this;return t.regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(n=this.loader,a=this.parseCache,i=new Set,s=function(){var e=t.asyncToGenerator(t.regeneratorRuntime().mark((function e(r,l){var c,u,d,p,f,g,m,v,w,M,y,L,k,x,S,T,D,E,N,R,V,F,A,I,P,G,z,O,U,W,B,j,H,q,Y,K,X,J;return t.regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(void 0===l&&(l=null),c=r.subobjects,u=[],d=function(e,t){var r=c[e],n=a.ensureDataLoaded(r.fileName).then((function(){var e,t=a.getData(r.fileName,!1);return e=t.type,/primitive/i.test(e)||"Subpart"===e?s(a.getData(r.fileName),r):h.loadModel(r.fileName).catch((function(e){return console.warn(e),null}))}));u.push(n)},p=0,f=c.length;p<f;p++)d(p);return(g=new o.Group).userData.category=r.category,g.userData.keywords=r.keywords,r.group=g,e.next=11,Promise.all(u);case 11:m=e.sent,v=0,w=m.length;case 13:if(!(v<w)){e.next=45;break}if(M=r.subobjects[v],null!==(y=m[v])){e.next=18;break}return e.abrupt("continue",42);case 18:if(!y.isGroup){e.next=26;break}return L=y,M.matrix.decompose(L.position,L.quaternion,L.scale),L.userData.startingConstructionStep=M.startingConstructionStep,L.name=M.fileName,n.applyMaterialsToMesh(L,M.colorCode,r.materials),g.add(L),e.abrupt("continue",42);case 26:for(y.group.children.length&&g.add(y.group),k=r.lineSegments,x=r.conditionalSegments,S=r.faces,T=y.lineSegments,D=y.conditionalSegments,E=y.faces,N=M.matrix,R=M.inverted,V=N.determinant()<0,F=M.colorCode,A=F===b?C:F,I=0,P=T.length;I<P;I++)G=T[I],(z=G.vertices)[0].applyMatrix4(N),z[1].applyMatrix4(N),G.colorCode=G.colorCode===C?A:G.colorCode,G.material=G.material||_(G.colorCode,G.colorCode,r.materials,!0),k.push(G);for(O=0,U=D.length;O<U;O++)W=D[O],B=W.vertices,j=W.controlPoints,B[0].applyMatrix4(N),B[1].applyMatrix4(N),j[0].applyMatrix4(N),j[1].applyMatrix4(N),W.colorCode=W.colorCode===C?A:W.colorCode,W.material=W.material||_(W.colorCode,W.colorCode,r.materials,!0),x.push(W);for(H=0,q=E.length;H<q;H++){for(Y=E[H],K=Y.vertices,X=0,J=K.length;X<J;X++)K[X].applyMatrix4(N);Y.colorCode=Y.colorCode===b?F:Y.colorCode,Y.material=Y.material||_(Y.colorCode,F,r.materials,!1),i.add(Y.colorCode),V!==R&&K.reverse(),S.push(Y)}r.totalFaces+=y.totalFaces;case 42:v++,e.next=13;break;case 45:return l&&n.applyMaterialsToMesh(g,l.colorCode,r.materials),e.abrupt("return",r);case 47:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),l=0,c=r.faces;l<c;l++)i.add(r.faces[l].colorCode);return e.next=7,s(r);case 7:return n.smoothNormals&&(u=i.size>1,k(r.faces),S(r.faces,r.lineSegments,u)),d=r.group,r.faces.length>0&&d.add(V(r.faces,3,!1,r.totalFaces)),r.lineSegments.length>0&&d.add(V(r.lineSegments,2)),r.conditionalSegments.length>0&&d.add(V(r.conditionalSegments,2,!0)),e.abrupt("return",d);case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),r.hasCachedModel=function(e){return null!==e&&e.toLowerCase()in this._cache},r.getCachedModel=function(){var e=t.asyncToGenerator(t.regeneratorRuntime().mark((function e(r){var n,a;return t.regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===r||!this.hasCachedModel(r)){e.next=8;break}return n=r.toLowerCase(),e.next=4,this._cache[n];case 4:return a=e.sent,e.abrupt("return",a.clone());case 8:return e.abrupt("return",null);case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),r.loadModel=function(){var e=t.asyncToGenerator(t.regeneratorRuntime().mark((function e(r){var n,a,i,o,s;return t.regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.parseCache,a=r.toLowerCase(),!this.hasCachedModel(r)){e.next=6;break}return e.abrupt("return",this.getCachedModel(r));case 6:return e.next=8,n.ensureDataLoaded(r);case 8:if(i=n.getData(r),o=this.processIntoMesh(i),!this.hasCachedModel(r)){e.next=12;break}return e.abrupt("return",this.getCachedModel(r));case 12:return T(i.type)&&(this._cache[a]=o),e.next=15,o;case 15:return s=e.sent,e.abrupt("return",s.clone());case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),r.parseModel=function(){var e=t.asyncToGenerator(t.regeneratorRuntime().mark((function e(r){var n,a;return t.regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.parseCache,!T((a=n.parse(r)).type)||!this.hasCachedModel(a.fileName)){e.next=4;break}return e.abrupt("return",this.getCachedModel(a.fileName));case 4:return e.abrupt("return",this.processIntoMesh(a));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),e}();function R(e,t){return e.colorCode===t.colorCode?0:e.colorCode<t.colorCode?-1:1}function V(e,t,a,i){void 0===a&&(a=!1),void 0===i&&(i=null),e.sort(R),null===i&&(i=e.length);for(var o=new Float32Array(t*i*3),s=3===t?new Float32Array(t*i*3):null,c=[],u=new Array(6),h=new n.BufferGeometry,p=null,f=0,g=0,v=0,b=0,C=e.length;b<C;b++){var y=e[b],k=y.vertices;4===k.length&&(u[0]=k[0],u[1]=k[1],u[2]=k[2],u[3]=k[0],u[4]=k[2],u[5]=k[3],k=u);for(var x=0,S=k.length;x<S;x++){var T=k[x],D=v+3*x;o[D+0]=T.x,o[D+1]=T.y,o[D+2]=T.z}if(3===t){if(!y.faceNormal){var E=k[0],_=k[1],N=k[2];w.subVectors(_,E),M.subVectors(N,_),y.faceNormal=(new m.Vector3).crossVectors(w,M).normalize()}var V=y.normals;4===V.length&&(u[0]=V[0],u[1]=V[1],u[2]=V[2],u[3]=V[0],u[4]=V[2],u[5]=V[3],V=u);for(var F=0,A=V.length;F<A;F++){var I=y.faceNormal;V[F]&&(I=V[F].norm);var P=v+3*F;s[P+0]=I.x,s[P+1]=I.y,s[P+2]=I.z}}if(p!==y.colorCode){null!==p&&h.addGroup(f,g,c.length-1);var G=y.material;null!==G?3===t?c.push(G):2===t&&(a?c.push(G.userData.edgeMaterial.userData.conditionalEdgeMaterial):c.push(G.userData.edgeMaterial)):c.push(y.colorCode),p=y.colorCode,f=v/3,g=k.length}else g+=k.length;v+=3*k.length}g>0&&h.addGroup(f,1/0,c.length-1),h.setAttribute("position",new r.BufferAttribute(o,3)),null!==s&&h.setAttribute("normal",new r.BufferAttribute(s,3));var z=null;if(2===t?z=a?new L(h,1===c.length?c[0]:c):new l.LineSegments(h,1===c.length?c[0]:c):3===t&&(z=new d.Mesh(h,1===c.length?c[0]:c)),a){z.isConditionalLine=!0;for(var O=new Float32Array(3*e.length*2),U=new Float32Array(3*e.length*2),W=new Float32Array(3*e.length*2),B=0,j=e.length;B<j;B++){var H=e[B],q=H.vertices,Y=H.controlPoints,K=Y[0],X=Y[1],J=q[0],Q=q[1],Z=3*B*2;O[Z+0]=K.x,O[Z+1]=K.y,O[Z+2]=K.z,O[Z+3]=K.x,O[Z+4]=K.y,O[Z+5]=K.z,U[Z+0]=X.x,U[Z+1]=X.y,U[Z+2]=X.z,U[Z+3]=X.x,U[Z+4]=X.y,U[Z+5]=X.z,W[Z+0]=Q.x-J.x,W[Z+1]=Q.y-J.y,W[Z+2]=Q.z-J.z,W[Z+3]=Q.x-J.x,W[Z+4]=Q.y-J.y,W[Z+5]=Q.z-J.z}h.setAttribute("control0",new r.BufferAttribute(O,3,!1)),h.setAttribute("control1",new r.BufferAttribute(U,3,!1)),h.setAttribute("direction",new r.BufferAttribute(W,3,!1))}return z}var F=function(e){function r(r){var n;return(n=e.call(this,r)||this).materials=[],n.materialLibrary={},n.partsCache=new N(t.assertThisInitialized(n)),n.fileMap={},n.setMaterials([]),n.smoothNormals=!0,n.partsLibraryPath="",n}t.inheritsLoose(r,e);var n=r.prototype;return n.setPartsLibraryPath=function(e){return this.partsLibraryPath=e,this},n.preloadMaterials=function(){var e=t.asyncToGenerator(t.regeneratorRuntime().mark((function e(r){var n,a,o,s,l,c,u,d,h,p;return t.regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=new i.FileLoader(this.manager)).setPath(this.path),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials),e.next=6,n.loadAsync(r);case 6:for(a=e.sent,o=/^0 !COLOUR/,s=a.split(/[\n\r]/g),l=[],c=0,u=s.length;c<u;c++)d=s[c],o.test(d)&&(h=d.replace(o,""),p=this.parseColorMetaDirective(new D(h)),l.push(p));this.setMaterials(l);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.load=function(e,t,r,n){var a=this,o=new i.FileLoader(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(e){a.partsCache.parseModel(e,a.materialLibrary).then((function(e){a.applyMaterialsToMesh(e,b,a.materialLibrary,!0),a.computeConstructionSteps(e),t(e)})).catch(n)}),r,n)},n.parse=function(e,t){var r=this;this.partsCache.parseModel(e,this.materialLibrary).then((function(e){r.computeConstructionSteps(e),t(e)}))},n.setMaterials=function(e){this.materialLibrary={},this.materials=[];for(var t=0,r=e.length;t<r;t++)this.addMaterial(e[t]);return this.addMaterial(this.parseColorMetaDirective(new D("Main_Colour CODE 16 VALUE #FF8080 EDGE #333333"))),this.addMaterial(this.parseColorMetaDirective(new D("Edge_Colour CODE 24 VALUE #A0A0A0 EDGE #333333"))),this},n.setFileMap=function(e){return this.fileMap=e,this},n.addMaterial=function(e){var t=this.materialLibrary;return t[e.userData.code]||(this.materials.push(e),t[e.userData.code]=e),this},n.getMaterial=function(e){if(e.startsWith("0x2")){var t=e.substring(3);return this.parseColorMetaDirective(new D("Direct_Color_"+t+" CODE -1 VALUE #"+t+" EDGE #"+t))}return this.materialLibrary[e]||null},n.applyMaterialsToMesh=function(e,t,r,n){void 0===n&&(n=!1);var a=this,i=t===b;function o(e,o){if(i&&!(o in r)&&!n)return o;var s=e.isLineSegments||e.isConditionalLine;(!s&&o===b||s&&o===C)&&(o=t);var l=null;if(o in r)l=r[o];else{if(!n)return o;if(null===(l=a.getMaterial(o)))throw new Error("LDrawLoader: Material properties for code "+o+" not available.")}return e.isLineSegments&&(l=l.userData.edgeMaterial,e.isConditionalLine&&(l=l.userData.conditionalEdgeMaterial)),l}e.traverse((function(e){if(e.isMesh||e.isLineSegments)if(Array.isArray(e.material))for(var t=0,r=e.material.length;t<r;t++)e.material[t].isMaterial||(e.material[t]=o(e,e.material[t]));else e.material.isMaterial||(e.material=o(e,e.material))}))},n.getMainMaterial=function(){return this.getMaterial(b)},n.getMainEdgeMaterial=function(){var e=this.getMainMaterial();return e&&e.userData?e.userData.edgeMaterial:null},n.parseColorMetaDirective=function(e){var t=null,r=16711935,n=16711935,a=1,i=!1,o=0,l=0,c=null,u=e.getToken();if(!u)throw new Error('LDrawLoader: Material name was expected after "!COLOUR tag'+e.getLineNumberString()+".");for(var d=null;d=e.getToken();)switch(d.toUpperCase()){case"CODE":t=e.getToken();break;case"VALUE":if((r=e.getToken()).startsWith("0x"))r="#"+r.substring(2);else if(!r.startsWith("#"))throw new Error("LDrawLoader: Invalid color while parsing material"+e.getLineNumberString()+".");break;case"EDGE":if((n=e.getToken()).startsWith("0x"))n="#"+n.substring(2);else if(!n.startsWith("#")){if(!(c=this.getMaterial(n)))throw new Error("LDrawLoader: Invalid edge color while parsing material"+e.getLineNumberString()+".");c=c.userData.edgeMaterial}break;case"ALPHA":if(a=parseInt(e.getToken()),isNaN(a))throw new Error("LDrawLoader: Invalid alpha value in material definition"+e.getLineNumberString()+".");(a=Math.max(0,Math.min(1,a/255)))<1&&(i=!0);break;case"LUMINANCE":if(o=parseInt(e.getToken()),isNaN(o))throw new Error("LDrawLoader: Invalid luminance value in material definition"+D.getLineNumberString()+".");o=Math.max(0,Math.min(1,o/255));break;case"CHROME":l=1;break;case"PEARLESCENT":l=2;break;case"RUBBER":l=3;break;case"MATTE_METALLIC":l=4;break;case"METAL":l=5;break;case"MATERIAL":e.setToEnd();break;default:throw new Error('LDrawLoader: Unknown token "'+d+'" while parsing material'+e.getLineNumberString()+".")}var p=null;switch(l){case 0:p=new h.MeshStandardMaterial({color:r,roughness:.3,metalness:0});break;case 2:p=new h.MeshStandardMaterial({color:r,roughness:.3,metalness:.25});break;case 1:p=new h.MeshStandardMaterial({color:r,roughness:0,metalness:1});break;case 3:p=new h.MeshStandardMaterial({color:r,roughness:.9,metalness:0});break;case 4:p=new h.MeshStandardMaterial({color:r,roughness:.8,metalness:.4});break;case 5:p=new h.MeshStandardMaterial({color:r,roughness:.2,metalness:.85})}return p.transparent=i,p.premultipliedAlpha=!0,p.opacity=a,p.depthWrite=!i,p.color.convertSRGBToLinear(),p.polygonOffset=!0,p.polygonOffsetFactor=1,0!==o&&p.emissive.set(p.color).multiplyScalar(o),c||((c=new s.LineBasicMaterial({color:n,transparent:i,opacity:a,depthWrite:!i})).userData.code=t,c.name=u+" - Edge",c.color.convertSRGBToLinear(),c.userData.conditionalEdgeMaterial=new y({fog:!0,transparent:i,depthWrite:!i,color:n,opacity:a}),c.userData.conditionalEdgeMaterial.color.convertSRGBToLinear()),p.userData.code=t,p.name=u,p.userData.edgeMaterial=c,this.addMaterial(p),p},n.computeConstructionSteps=function(e){var t=0;e.traverse((function(e){e.isGroup&&(e.userData.startingConstructionStep&&t++,e.userData.constructionStep=t)})),e.userData.numConstructionSteps=t+1},r}(c.Loader);e.LDrawLoader=F,Object.defineProperty(e,"__esModule",{value:!0})}));

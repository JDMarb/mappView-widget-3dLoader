/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","../animation/AnimationClip","../objects/Bone","../math/Box3","../core/BufferAttribute","../core/BufferGeometry","../constants","../math/Color","../lights/DirectionalLight","./FileLoader","../objects/Group","./ImageBitmapLoader","../core/InterleavedBuffer","../core/InterleavedBufferAttribute","../math/Interpolant","../objects/Line","../materials/LineBasicMaterial","../objects/LineLoop","../objects/LineSegments","./Loader","./LoaderUtils","../materials/Material","../math/MathUtils","../math/Matrix4","../objects/Mesh","../materials/MeshBasicMaterial","../materials/MeshPhysicalMaterial","../materials/MeshStandardMaterial","../animation/tracks/NumberKeyframeTrack","../core/Object3D","../cameras/PerspectiveCamera","../cameras/OrthographicCamera","../lights/PointLight","../objects/Points","../materials/PointsMaterial","../animation/PropertyBinding","../math/Quaternion","../animation/tracks/QuaternionKeyframeTrack","../objects/Skeleton","../objects/SkinnedMesh","../math/Sphere","../lights/SpotLight","../textures/Texture","./TextureLoader","../math/Vector3","../math/Vector2","../animation/tracks/VectorKeyframeTrack"],(function(e,t,r,n,s,a,i,o,u,l,c,h,p,d,f,m,v,g,T,x,M,R,y,S,_,A,L,E,w,b,I,P,C,O,H,N,F,U,k,D,B,G,j,K,V,X,q,z){"use strict";var W=function(e){function r(t){var r;return(r=e.call(this,t)||this).dracoLoader=null,r.ktx2Loader=null,r.meshoptDecoder=null,r.pluginCallbacks=[],r.register((function(e){return new ee(e)})),r.register((function(e){return new oe(e)})),r.register((function(e){return new ue(e)})),r.register((function(e){return new re(e)})),r.register((function(e){return new ne(e)})),r.register((function(e){return new se(e)})),r.register((function(e){return new ae(e)})),r.register((function(e){return new $(e)})),r.register((function(e){return new ie(e)})),r.register((function(e){return new te(e)})),r.register((function(e){return new J(e)})),r.register((function(e){return new le(e)})),r}t.inheritsLoose(r,e);var n=r.prototype;return n.load=function(e,t,r,n){var s,a=this;s=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:R.LoaderUtils.extractUrlBase(e),this.manager.itemStart(e);var i=function(t){n?n(t):console.error(t),a.manager.itemError(e),a.manager.itemEnd(e)},o=new c.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(r){try{a.parse(r,s,(function(r){t(r),a.manager.itemEnd(e)}),i)}catch(e){i(e)}}),r,i)},n.setDRACOLoader=function(e){return this.dracoLoader=e,this},n.setDDSLoader=function(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')},n.setKTX2Loader=function(e){return this.ktx2Loader=e,this},n.setMeshoptDecoder=function(e){return this.meshoptDecoder=e,this},n.register=function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},n.unregister=function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},n.parse=function(e,t,r,n){var s,a={},i={};if("string"==typeof e)s=e;else if(R.LoaderUtils.decodeText(new Uint8Array(e,0,4))===ce){try{a[Y.KHR_BINARY_GLTF]=new de(e)}catch(e){return void(n&&n(e))}s=a[Y.KHR_BINARY_GLTF].content}else s=R.LoaderUtils.decodeText(new Uint8Array(e));var o=JSON.parse(s);if(void 0===o.asset||o.asset.version[0]<2)n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{var u=new Ve(o,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});u.fileLoader.setRequestHeader(this.requestHeader);for(var l=0;l<this.pluginCallbacks.length;l++){var c=this.pluginCallbacks[l](u);i[c.name]=c,a[c.name]=!0}if(o.extensionsUsed)for(var h=0;h<o.extensionsUsed.length;++h){var p=o.extensionsUsed[h],d=o.extensionsRequired||[];switch(p){case Y.KHR_MATERIALS_UNLIT:a[p]=new Z;break;case Y.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:a[p]=new ge;break;case Y.KHR_DRACO_MESH_COMPRESSION:a[p]=new fe(o,this.dracoLoader);break;case Y.KHR_TEXTURE_TRANSFORM:a[p]=new me;break;case Y.KHR_MESH_QUANTIZATION:a[p]=new Te;break;default:d.indexOf(p)>=0&&void 0===i[p]&&console.warn('THREE.GLTFLoader: Unknown extension "'+p+'".')}}u.setExtensions(a),u.setPlugins(i),u.parse(r,n)}},n.parseAsync=function(e,t){var r=this;return new Promise((function(n,s){r.parse(e,t,n,s)}))},r}(M.Loader);function Q(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}var Y={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"},J=function(){function e(e){this.parser=e,this.name=Y.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}var t=e.prototype;return t._markDefs=function(){for(var e=this.parser,t=this.parser.json.nodes||[],r=0,n=t.length;r<n;r++){var s=t[r];s.extensions&&s.extensions[this.name]&&void 0!==s.extensions[this.name].light&&e._addNodeRef(this.cache,s.extensions[this.name].light)}},t._loadLight=function(e){var t=this.parser,r="light:"+e,n=t.cache.get(r);if(n)return n;var s,a=t.json,i=((a.extensions&&a.extensions[this.name]||{}).lights||[])[e],o=new u.Color(16777215);void 0!==i.color&&o.fromArray(i.color);var c=void 0!==i.range?i.range:0;switch(i.type){case"directional":(s=new l.DirectionalLight(o)).target.position.set(0,0,-1),s.add(s.target);break;case"point":(s=new O.PointLight(o)).distance=c;break;case"spot":(s=new j.SpotLight(o)).distance=c,i.spot=i.spot||{},i.spot.innerConeAngle=void 0!==i.spot.innerConeAngle?i.spot.innerConeAngle:0,i.spot.outerConeAngle=void 0!==i.spot.outerConeAngle?i.spot.outerConeAngle:Math.PI/4,s.angle=i.spot.outerConeAngle,s.penumbra=1-i.spot.innerConeAngle/i.spot.outerConeAngle,s.target.position.set(0,0,-1),s.add(s.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+i.type)}return s.position.set(0,0,0),s.decay=2,void 0!==i.intensity&&(s.intensity=i.intensity),s.name=t.createUniqueName(i.name||"light_"+e),n=Promise.resolve(s),t.cache.add(r,n),n},t.createNodeAttachment=function(e){var t=this,r=this.parser,n=r.json.nodes[e],s=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===s?null:this._loadLight(s).then((function(e){return r._getNodeRef(t.cache,s,e)}))},e}(),Z=function(){function e(){this.name=Y.KHR_MATERIALS_UNLIT}var t=e.prototype;return t.getMaterialType=function(){return L.MeshBasicMaterial},t.extendParams=function(e,t,r){var n=[];e.color=new u.Color(1,1,1),e.opacity=1;var s=t.pbrMetallicRoughness;if(s){if(Array.isArray(s.baseColorFactor)){var a=s.baseColorFactor;e.color.fromArray(a),e.opacity=a[3]}void 0!==s.baseColorTexture&&n.push(r.assignTexture(e,"map",s.baseColorTexture,o.sRGBEncoding))}return Promise.all(n)},e}(),$=function(){function e(e){this.parser=e,this.name=Y.KHR_MATERIALS_EMISSIVE_STRENGTH}return e.prototype.extendMaterialParams=function(e,t){var r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();var n=r.extensions[this.name].emissiveStrength;return void 0!==n&&(t.emissiveIntensity=n),Promise.resolve()},e}(),ee=function(){function e(e){this.parser=e,this.name=Y.KHR_MATERIALS_CLEARCOAT}var t=e.prototype;return t.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?E.MeshPhysicalMaterial:null},t.extendMaterialParams=function(e,t){var r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var s=[],a=n.extensions[this.name];if(void 0!==a.clearcoatFactor&&(t.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&s.push(r.assignTexture(t,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(t.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&s.push(r.assignTexture(t,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(s.push(r.assignTexture(t,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){var i=a.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new q.Vector2(i,i)}return Promise.all(s)},e}(),te=function(){function e(e){this.parser=e,this.name=Y.KHR_MATERIALS_IRIDESCENCE}var t=e.prototype;return t.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?E.MeshPhysicalMaterial:null},t.extendMaterialParams=function(e,t){var r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var s=[],a=n.extensions[this.name];return void 0!==a.iridescenceFactor&&(t.iridescence=a.iridescenceFactor),void 0!==a.iridescenceTexture&&s.push(r.assignTexture(t,"iridescenceMap",a.iridescenceTexture)),void 0!==a.iridescenceIor&&(t.iridescenceIOR=a.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==a.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=a.iridescenceThicknessMinimum),void 0!==a.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=a.iridescenceThicknessMaximum),void 0!==a.iridescenceThicknessTexture&&s.push(r.assignTexture(t,"iridescenceThicknessMap",a.iridescenceThicknessTexture)),Promise.all(s)},e}(),re=function(){function e(e){this.parser=e,this.name=Y.KHR_MATERIALS_SHEEN}var t=e.prototype;return t.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?E.MeshPhysicalMaterial:null},t.extendMaterialParams=function(e,t){var r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var s=[];t.sheenColor=new u.Color(0,0,0),t.sheenRoughness=0,t.sheen=1;var a=n.extensions[this.name];return void 0!==a.sheenColorFactor&&t.sheenColor.fromArray(a.sheenColorFactor),void 0!==a.sheenRoughnessFactor&&(t.sheenRoughness=a.sheenRoughnessFactor),void 0!==a.sheenColorTexture&&s.push(r.assignTexture(t,"sheenColorMap",a.sheenColorTexture,o.sRGBEncoding)),void 0!==a.sheenRoughnessTexture&&s.push(r.assignTexture(t,"sheenRoughnessMap",a.sheenRoughnessTexture)),Promise.all(s)},e}(),ne=function(){function e(e){this.parser=e,this.name=Y.KHR_MATERIALS_TRANSMISSION}var t=e.prototype;return t.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?E.MeshPhysicalMaterial:null},t.extendMaterialParams=function(e,t){var r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var s=[],a=n.extensions[this.name];return void 0!==a.transmissionFactor&&(t.transmission=a.transmissionFactor),void 0!==a.transmissionTexture&&s.push(r.assignTexture(t,"transmissionMap",a.transmissionTexture)),Promise.all(s)},e}(),se=function(){function e(e){this.parser=e,this.name=Y.KHR_MATERIALS_VOLUME}var t=e.prototype;return t.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?E.MeshPhysicalMaterial:null},t.extendMaterialParams=function(e,t){var r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var s=[],a=n.extensions[this.name];t.thickness=void 0!==a.thicknessFactor?a.thicknessFactor:0,void 0!==a.thicknessTexture&&s.push(r.assignTexture(t,"thicknessMap",a.thicknessTexture)),t.attenuationDistance=a.attenuationDistance||0;var i=a.attenuationColor||[1,1,1];return t.attenuationColor=new u.Color(i[0],i[1],i[2]),Promise.all(s)},e}(),ae=function(){function e(e){this.parser=e,this.name=Y.KHR_MATERIALS_IOR}var t=e.prototype;return t.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?E.MeshPhysicalMaterial:null},t.extendMaterialParams=function(e,t){var r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();var n=r.extensions[this.name];return t.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()},e}(),ie=function(){function e(e){this.parser=e,this.name=Y.KHR_MATERIALS_SPECULAR}var t=e.prototype;return t.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?E.MeshPhysicalMaterial:null},t.extendMaterialParams=function(e,t){var r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var s=[],a=n.extensions[this.name];t.specularIntensity=void 0!==a.specularFactor?a.specularFactor:1,void 0!==a.specularTexture&&s.push(r.assignTexture(t,"specularIntensityMap",a.specularTexture));var i=a.specularColorFactor||[1,1,1];return t.specularColor=new u.Color(i[0],i[1],i[2]),void 0!==a.specularColorTexture&&s.push(r.assignTexture(t,"specularColorMap",a.specularColorTexture,o.sRGBEncoding)),Promise.all(s)},e}(),oe=function(){function e(e){this.parser=e,this.name=Y.KHR_TEXTURE_BASISU}return e.prototype.loadTexture=function(e){var t=this.parser,r=t.json,n=r.textures[e];if(!n.extensions||!n.extensions[this.name])return null;var s=n.extensions[this.name],a=t.options.ktx2Loader;if(!a){if(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,s.source,a)},e}(),ue=function(){function e(e){this.parser=e,this.name=Y.EXT_TEXTURE_WEBP,this.isSupported=null}var t=e.prototype;return t.loadTexture=function(e){var t=this.name,r=this.parser,n=r.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;var a=s.extensions[t],i=n.images[a.source],o=r.textureLoader;if(i.uri){var u=r.options.manager.getHandler(i.uri);null!==u&&(o=u)}return this.detectSupport().then((function(s){if(s)return r.loadTextureImage(e,a.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return r.loadTexture(e)}))},t.detectSupport=function(){return this.isSupported||(this.isSupported=new Promise((function(e){var t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported},e}(),le=function(){function e(e){this.name=Y.EXT_MESHOPT_COMPRESSION,this.parser=e}return e.prototype.loadBufferView=function(e){var t=this.parser.json,r=t.bufferViews[e];if(r.extensions&&r.extensions[this.name]){var n=r.extensions[this.name],s=this.parser.getDependency("buffer",n.buffer),a=this.parser.options.meshoptDecoder;if(!a||!a.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([s,a.ready]).then((function(e){var t=n.byteOffset||0,r=n.byteLength||0,s=n.count,i=n.byteStride,o=new ArrayBuffer(s*i),u=new Uint8Array(e[0],t,r);return a.decodeGltfBuffer(new Uint8Array(o),s,i,u,n.mode,n.filter),o}))}return null},e}(),ce="glTF",he=1313821514,pe=5130562,de=function(e){this.name=Y.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,12);if(this.header={magic:R.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ce)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var r=this.header.length-12,n=new DataView(e,12),s=0;s<r;){var a=n.getUint32(s,!0);s+=4;var i=n.getUint32(s,!0);if(s+=4,i===he){var o=new Uint8Array(e,12+s,a);this.content=R.LoaderUtils.decodeText(o)}else if(i===pe){var u=12+s;this.body=e.slice(u,u+a)}s+=a}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")},fe=function(){function e(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Y.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}return e.prototype.decodePrimitive=function(e,t){var r=this.json,n=this.dracoLoader,s=e.extensions[this.name].bufferView,a=e.extensions[this.name].attributes,i={},o={},u={};for(var l in a){var c=Oe[l]||l.toLowerCase();i[c]=a[l]}for(var h in e.attributes){var p=Oe[h]||h.toLowerCase();if(void 0!==a[h]){var d=r.accessors[e.attributes[h]],f=be[d.componentType];u[p]=f,o[p]=!0===d.normalized}}return t.getDependency("bufferView",s).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(var r in e.attributes){var n=e.attributes[r],s=o[r];void 0!==s&&(n.normalized=s)}t(e)}),i,u)}))}))},e}(),me=function(){function e(){this.name=Y.KHR_TEXTURE_TRANSFORM}return e.prototype.extendTexture=function(e,t){return void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e},e}(),ve=function(e){function r(r){var n;(n=e.call(this)||this).isGLTFSpecularGlossinessMaterial=!0;var s=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),a=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),i=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),o=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),l=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),c={specular:{value:(new u.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};return n._extraUniforms=c,n.onBeforeCompile=function(e){for(var t in c)e.uniforms[t]=c[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",s).replace("#include <metalnessmap_pars_fragment>",a).replace("#include <roughnessmap_fragment>",i).replace("#include <metalnessmap_fragment>",o).replace("#include <lights_physical_fragment>",l)},Object.defineProperties(t.assertThisInitialized(n),{specular:{get:function(){return c.specular.value},set:function(e){c.specular.value=e}},specularMap:{get:function(){return c.specularMap.value},set:function(e){c.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return c.glossiness.value},set:function(e){c.glossiness.value=e}},glossinessMap:{get:function(){return c.glossinessMap.value},set:function(e){c.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete n.metalness,delete n.roughness,delete n.metalnessMap,delete n.roughnessMap,n.setValues(r),n}return t.inheritsLoose(r,e),r.prototype.copy=function(t){return e.prototype.copy.call(this,t),this.specularMap=t.specularMap,this.specular.copy(t.specular),this.glossinessMap=t.glossinessMap,this.glossiness=t.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},r}(w.MeshStandardMaterial),ge=function(){function e(){this.name=Y.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity"]}var t=e.prototype;return t.getMaterialType=function(){return ve},t.extendParams=function(e,t,r){var n=t.extensions[this.name];e.color=new u.Color(1,1,1),e.opacity=1;var s=[];if(Array.isArray(n.diffuseFactor)){var a=n.diffuseFactor;e.color.fromArray(a),e.opacity=a[3]}if(void 0!==n.diffuseTexture&&s.push(r.assignTexture(e,"map",n.diffuseTexture,o.sRGBEncoding)),e.emissive=new u.Color(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new u.Color(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var i=n.specularGlossinessTexture;s.push(r.assignTexture(e,"glossinessMap",i)),s.push(r.assignTexture(e,"specularMap",i,o.sRGBEncoding))}return Promise.all(s)},t.createMaterial=function(e){var t=new ve(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=void 0===e.emissiveIntensity?1:e.emissiveIntensity,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=o.TangentSpaceNormalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t},e}(),Te=function(){this.name=Y.KHR_MESH_QUANTIZATION},xe=function(e){function r(t,r,n,s){return e.call(this,t,r,n,s)||this}t.inheritsLoose(r,e);var n=r.prototype;return n.copySampleValue_=function(e){for(var t=this.resultBuffer,r=this.sampleValues,n=this.valueSize,s=e*n*3+n,a=0;a!==n;a++)t[a]=r[s+a];return t},n.interpolate_=function(e,t,r,n){for(var s=this.resultBuffer,a=this.sampleValues,i=this.valueSize,o=2*i,u=3*i,l=n-t,c=(r-t)/l,h=c*c,p=h*c,d=e*u,f=d-u,m=-2*p+3*h,v=p-h,g=1-m,T=v-h+c,x=0;x!==i;x++){var M=a[f+x+i],R=a[f+x+o]*l,y=a[d+x+i],S=a[d+x]*l;s[x]=g*M+T*R+m*y+v*S}return s},r}(m.Interpolant),Me=new U.Quaternion,Re=function(e){function r(){return e.apply(this,arguments)||this}return t.inheritsLoose(r,e),r.prototype.interpolate_=function(t,r,n,s){var a=e.prototype.interpolate_.call(this,t,r,n,s);return Me.fromArray(a).normalize().toArray(a),a},r}(xe),ye=0,Se=1,_e=2,Ae=3,Le=4,Ee=5,we=6,be={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ie={9728:o.NearestFilter,9729:o.LinearFilter,9984:o.NearestMipmapNearestFilter,9985:o.LinearMipmapNearestFilter,9986:o.NearestMipmapLinearFilter,9987:o.LinearMipmapLinearFilter},Pe={33071:o.ClampToEdgeWrapping,33648:o.MirroredRepeatWrapping,10497:o.RepeatWrapping},Ce={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Oe={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},He={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Ne={CUBICSPLINE:void 0,LINEAR:o.InterpolateLinear,STEP:o.InterpolateDiscrete},Fe="OPAQUE",Ue="MASK",ke="BLEND";function De(e,t,r){for(var n in r.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=r.extensions[n])}function Be(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Ge(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var r=0,n=t.weights.length;r<n;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){var s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(var a=0,i=s.length;a<i;a++)e.morphTargetDictionary[s[a]]=a}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function je(e){for(var t="",r=Object.keys(e).sort(),n=0,s=r.length;n<s;n++)t+=r[n]+":"+e[r[n]]+";";return t}function Ke(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}var Ve=function(){function e(e,t){void 0===e&&(e={}),void 0===t&&(t={}),this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Q,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};var r=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n=navigator.userAgent.indexOf("Firefox")>-1,s=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1;"undefined"==typeof createImageBitmap||r||n&&s<98?this.textureLoader=new V.TextureLoader(this.options.manager):this.textureLoader=new p.ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new c.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}var s=e.prototype;return s.setExtensions=function(e){this.extensions=e},s.setPlugins=function(e){this.plugins=e},s.parse=function(e,t){var r=this,n=this.json,s=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([r.getDependencies("scene"),r.getDependencies("animation"),r.getDependencies("camera")])})).then((function(t){var a={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:r,userData:{}};De(s,a,n),Be(a,n),Promise.all(r._invokeAll((function(e){return e.afterRoot&&e.afterRoot(a)}))).then((function(){e(a)}))})).catch(t)},s._markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],n=0,s=t.length;n<s;n++)for(var a=t[n].joints,i=0,o=a.length;i<o;i++)e[a[i]].isBone=!0;for(var u=0,l=e.length;u<l;u++){var c=e[u];void 0!==c.mesh&&(this._addNodeRef(this.meshCache,c.mesh),void 0!==c.skin&&(r[c.mesh].isSkinnedMesh=!0)),void 0!==c.camera&&this._addNodeRef(this.cameraCache,c.camera)}},s._addNodeRef=function(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)},s._getNodeRef=function(e,r,n){var s=this;if(e.refs[r]<=1)return n;var a=n.clone();return function e(r,n){var a=s.associations.get(r);null!=a&&s.associations.set(n,a);for(var i,o=t.createForOfIteratorHelperLoose(r.children.entries());!(i=o()).done;){var u=i.value,l=u[0];e(u[1],n.children[l])}}(n,a),a.name+="_instance_"+e.uses[r]++,a},s._invokeOne=function(e){var t=Object.values(this.plugins);t.push(this);for(var r=0;r<t.length;r++){var n=e(t[r]);if(n)return n}return null},s._invokeAll=function(e){var t=Object.values(this.plugins);t.unshift(this);for(var r=[],n=0;n<t.length;n++){var s=e(t[n]);s&&r.push(s)}return r},s.getDependency=function(e,t){var r=e+":"+t,n=this.cache.get(r);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":n=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(r,n)}return n},s.getDependencies=function(e){var t=this.cache.get(e);if(!t){var r=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return r.getDependency(e,n)}))),this.cache.add(e,t)}return t},s.loadBuffer=function(e){var t=this.json.buffers[e],r=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[Y.KHR_BINARY_GLTF].body);var n=this.options;return new Promise((function(e,s){r.load(R.LoaderUtils.resolveURL(t.uri,n.path),e,void 0,(function(){s(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))},s.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){var r=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+r)}))},s.loadAccessor=function(e){var t=this,r=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var s=[];return void 0!==n.bufferView?s.push(this.getDependency("bufferView",n.bufferView)):s.push(null),void 0!==n.sparse&&(s.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(s).then((function(e){var s,i,o=e[0],u=Ce[n.type],l=be[n.componentType],c=l.BYTES_PER_ELEMENT,h=c*u,p=n.byteOffset||0,m=void 0!==n.bufferView?r.bufferViews[n.bufferView].byteStride:void 0,v=!0===n.normalized;if(m&&m!==h){var g=Math.floor(p/m),T="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+g+":"+n.count,x=t.cache.get(T);x||(s=new l(o,g*m,n.count*m/c),x=new d.InterleavedBuffer(s,m/c),t.cache.add(T,x)),i=new f.InterleavedBufferAttribute(x,u,p%m/c,v)}else s=null===o?new l(n.count*u):new l(o,p,n.count*u),i=new a.BufferAttribute(s,u,v);if(void 0!==n.sparse){var M=Ce.SCALAR,R=be[n.sparse.indices.componentType],y=n.sparse.indices.byteOffset||0,S=n.sparse.values.byteOffset||0,_=new R(e[1],y,n.sparse.count*M),A=new l(e[2],S,n.sparse.count*u);null!==o&&(i=new a.BufferAttribute(i.array.slice(),i.itemSize,i.normalized));for(var L=0,E=_.length;L<E;L++){var w=_[L];if(i.setX(w,A[L*u]),u>=2&&i.setY(w,A[L*u+1]),u>=3&&i.setZ(w,A[L*u+2]),u>=4&&i.setW(w,A[L*u+3]),u>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return i}))},s.loadTexture=function(e){var t=this.json,r=this.options,n=t.textures[e].source,s=t.images[n],a=this.textureLoader;if(s.uri){var i=r.manager.getHandler(s.uri);null!==i&&(a=i)}return this.loadTextureImage(e,n,a)},s.loadTextureImage=function(e,t,r){var n=this,s=this.json,a=s.textures[e],i=s.images[t],u=(i.uri||i.bufferView)+":"+a.sampler;if(this.textureCache[u])return this.textureCache[u];var l=this.loadImageSource(t,r).then((function(t){t.flipY=!1,a.name&&(t.name=a.name);var r=(s.samplers||{})[a.sampler]||{};return t.magFilter=Ie[r.magFilter]||o.LinearFilter,t.minFilter=Ie[r.minFilter]||o.LinearMipmapLinearFilter,t.wrapS=Pe[r.wrapS]||o.RepeatWrapping,t.wrapT=Pe[r.wrapT]||o.RepeatWrapping,n.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[u]=l,l},s.loadImageSource=function(e,t){var r=this.json,n=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((function(e){return e.clone()}));var s=r.images[e],a=self.URL||self.webkitURL,i=s.uri||"",o=!1;if(void 0!==s.bufferView)i=this.getDependency("bufferView",s.bufferView).then((function(e){o=!0;var t=new Blob([e],{type:s.mimeType});return i=a.createObjectURL(t)}));else if(void 0===s.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");var u=Promise.resolve(i).then((function(e){return new Promise((function(r,s){var a=r;!0===t.isImageBitmapLoader&&(a=function(e){var t=new K.Texture(e);t.needsUpdate=!0,r(t)}),t.load(R.LoaderUtils.resolveURL(e,n.path),a,void 0,s)}))})).then((function(e){var t;return!0===o&&a.revokeObjectURL(i),e.userData.mimeType=s.mimeType||((t=s.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",i),e}));return this.sourceCache[e]=u,u},s.assignTexture=function(e,t,r,n){var s=this;return this.getDependency("texture",r.index).then((function(a){if(void 0===r.texCoord||0==r.texCoord||"aoMap"===t&&1==r.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+r.texCoord+" for texture "+t+" not yet supported."),s.extensions[Y.KHR_TEXTURE_TRANSFORM]){var i=void 0!==r.extensions?r.extensions[Y.KHR_TEXTURE_TRANSFORM]:void 0;if(i){var o=s.associations.get(a);a=s.extensions[Y.KHR_TEXTURE_TRANSFORM].extendTexture(a,i),s.associations.set(a,o)}}return void 0!==n&&(a.encoding=n),e[t]=a,a}))},s.assignFinalMaterial=function(e){var t=e.geometry,r=e.material,n=void 0===t.attributes.tangent,s=void 0!==t.attributes.color,a=void 0===t.attributes.normal;if(e.isPoints){var i="PointsMaterial:"+r.uuid,o=this.cache.get(i);o||(o=new N.PointsMaterial,y.Material.prototype.copy.call(o,r),o.color.copy(r.color),o.map=r.map,o.sizeAttenuation=!1,this.cache.add(i,o)),r=o}else if(e.isLine){var u="LineBasicMaterial:"+r.uuid,l=this.cache.get(u);l||(l=new g.LineBasicMaterial,y.Material.prototype.copy.call(l,r),l.color.copy(r.color),this.cache.add(u,l)),r=l}if(n||s||a){var c="ClonedMaterial:"+r.uuid+":";r.isGLTFSpecularGlossinessMaterial&&(c+="specular-glossiness:"),n&&(c+="derivative-tangents:"),s&&(c+="vertex-colors:"),a&&(c+="flat-shading:");var h=this.cache.get(c);h||(h=r.clone(),s&&(h.vertexColors=!0),a&&(h.flatShading=!0),n&&(h.normalScale&&(h.normalScale.y*=-1),h.clearcoatNormalScale&&(h.clearcoatNormalScale.y*=-1)),this.cache.add(c,h),this.associations.set(h,this.associations.get(r))),r=h}r.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=r},s.getMaterialType=function(){return w.MeshStandardMaterial},s.loadMaterial=function(e){var t,r=this,n=this.json,s=this.extensions,a=n.materials[e],i={},l=a.extensions||{},c=[];if(l[Y.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var h=s[Y.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=h.getMaterialType(),c.push(h.extendParams(i,a,r))}else if(l[Y.KHR_MATERIALS_UNLIT]){var p=s[Y.KHR_MATERIALS_UNLIT];t=p.getMaterialType(),c.push(p.extendParams(i,a,r))}else{var d=a.pbrMetallicRoughness||{};if(i.color=new u.Color(1,1,1),i.opacity=1,Array.isArray(d.baseColorFactor)){var f=d.baseColorFactor;i.color.fromArray(f),i.opacity=f[3]}void 0!==d.baseColorTexture&&c.push(r.assignTexture(i,"map",d.baseColorTexture,o.sRGBEncoding)),i.metalness=void 0!==d.metallicFactor?d.metallicFactor:1,i.roughness=void 0!==d.roughnessFactor?d.roughnessFactor:1,void 0!==d.metallicRoughnessTexture&&(c.push(r.assignTexture(i,"metalnessMap",d.metallicRoughnessTexture)),c.push(r.assignTexture(i,"roughnessMap",d.metallicRoughnessTexture))),t=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),c.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,i)}))))}!0===a.doubleSided&&(i.side=o.DoubleSide);var m=a.alphaMode||Fe;if(m===ke?(i.transparent=!0,i.depthWrite=!1):(i.transparent=!1,m===Ue&&(i.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)),void 0!==a.normalTexture&&t!==L.MeshBasicMaterial&&(c.push(r.assignTexture(i,"normalMap",a.normalTexture)),i.normalScale=new q.Vector2(1,1),void 0!==a.normalTexture.scale)){var v=a.normalTexture.scale;i.normalScale.set(v,v)}return void 0!==a.occlusionTexture&&t!==L.MeshBasicMaterial&&(c.push(r.assignTexture(i,"aoMap",a.occlusionTexture)),void 0!==a.occlusionTexture.strength&&(i.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&t!==L.MeshBasicMaterial&&(i.emissive=(new u.Color).fromArray(a.emissiveFactor)),void 0!==a.emissiveTexture&&t!==L.MeshBasicMaterial&&c.push(r.assignTexture(i,"emissiveMap",a.emissiveTexture,o.sRGBEncoding)),Promise.all(c).then((function(){var n;return n=t===ve?s[Y.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(i):new t(i),a.name&&(n.name=a.name),Be(n,a),r.associations.set(n,{materials:e}),a.extensions&&De(s,n,a),n}))},s.createUniqueName=function(e){for(var t=F.PropertyBinding.sanitizeNodeName(e||""),r=t,n=1;this.nodeNamesUsed[r];++n)r=t+"_"+n;return this.nodeNamesUsed[r]=!0,r},s.loadGeometries=function(e){var t=this,r=this.extensions,n=this.primitiveCache;function s(e){return r[Y.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(r){return qe(r,e,t)}))}for(var a,o,u=[],l=0,c=e.length;l<c;l++){var h=e[l],p=(o=void 0,(o=(a=h).extensions&&a.extensions[Y.KHR_DRACO_MESH_COMPRESSION])?"draco:"+o.bufferView+":"+o.indices+":"+je(o.attributes):a.indices+":"+je(a.attributes)+":"+a.mode),d=n[p];if(d)u.push(d.promise);else{var f=void 0;f=h.extensions&&h.extensions[Y.KHR_DRACO_MESH_COMPRESSION]?s(h):qe(new i.BufferGeometry,h,t),n[p]={primitive:h,promise:f},u.push(f)}}return Promise.all(u)},s.loadMesh=function(e){for(var t,r=this,n=this.json,s=this.extensions,a=n.meshes[e],i=a.primitives,u=[],l=0,c=i.length;l<c;l++){var p=void 0===i[l].material?(void 0===(t=this.cache).DefaultMaterial&&(t.DefaultMaterial=new w.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:o.FrontSide})),t.DefaultMaterial):this.getDependency("material",i[l].material);u.push(p)}return u.push(r.loadGeometries(i)),Promise.all(u).then((function(t){for(var n=t.slice(0,t.length-1),u=t[t.length-1],l=[],c=0,p=u.length;c<p;c++){var d=u[c],f=i[c],m=void 0,g=n[c];if(f.mode===Le||f.mode===Ee||f.mode===we||void 0===f.mode)!0!==(m=!0===a.isSkinnedMesh?new B.SkinnedMesh(d,g):new A.Mesh(d,g)).isSkinnedMesh||m.geometry.attributes.skinWeight.normalized||m.normalizeSkinWeights(),f.mode===Ee?m.geometry=ze(m.geometry,o.TriangleStripDrawMode):f.mode===we&&(m.geometry=ze(m.geometry,o.TriangleFanDrawMode));else if(f.mode===Se)m=new x.LineSegments(d,g);else if(f.mode===Ae)m=new v.Line(d,g);else if(f.mode===_e)m=new T.LineLoop(d,g);else{if(f.mode!==ye)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+f.mode);m=new H.Points(d,g)}Object.keys(m.geometry.morphAttributes).length>0&&Ge(m,a),m.name=r.createUniqueName(a.name||"mesh_"+e),Be(m,a),f.extensions&&De(s,m,f),r.assignFinalMaterial(m),l.push(m)}for(var M=0,R=l.length;M<R;M++)r.associations.set(l[M],{meshes:e,primitives:M});if(1===l.length)return l[0];var y=new h.Group;r.associations.set(y,{meshes:e});for(var S=0,_=l.length;S<_;S++)y.add(l[S]);return y}))},s.loadCamera=function(e){var t,r=this.json.cameras[e],n=r[r.type];if(n)return"perspective"===r.type?t=new P.PerspectiveCamera(S.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===r.type&&(t=new C.OrthographicCamera(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),r.name&&(t.name=this.createUniqueName(r.name)),Be(t,r),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")},s.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return r.inverseBindMatrices=e,r}))},s.loadAnimation=function(e){for(var t=this.json.animations[e],n=[],s=[],a=[],i=[],u=[],l=0,c=t.channels.length;l<c;l++){var h=t.channels[l],p=t.samplers[h.sampler],d=h.target,f=void 0!==d.node?d.node:d.id,m=void 0!==t.parameters?t.parameters[p.input]:p.input,v=void 0!==t.parameters?t.parameters[p.output]:p.output;n.push(this.getDependency("node",f)),s.push(this.getDependency("accessor",m)),a.push(this.getDependency("accessor",v)),i.push(p),u.push(d)}return Promise.all([Promise.all(n),Promise.all(s),Promise.all(a),Promise.all(i),Promise.all(u)]).then((function(n){for(var s=n[0],a=n[1],i=n[2],u=n[3],l=n[4],c=[],h=function(e,t){var r=s[e],n=a[e],h=i[e],p=u[e],d=l[e];if(void 0===r)return"continue";r.updateMatrix(),r.matrixAutoUpdate=!0;var f=void 0;switch(He[d.path]){case He.weights:f=b.NumberKeyframeTrack;break;case He.rotation:f=k.QuaternionKeyframeTrack;break;default:f=z.VectorKeyframeTrack}var m=r.name?r.name:r.uuid,v=void 0!==p.interpolation?Ne[p.interpolation]:o.InterpolateLinear,g=[];He[d.path]===He.weights?r.traverse((function(e){e.morphTargetInfluences&&g.push(e.name?e.name:e.uuid)})):g.push(m);var T=h.array;if(h.normalized){for(var x=Ke(T.constructor),M=new Float32Array(T.length),R=0,y=T.length;R<y;R++)M[R]=T[R]*x;T=M}for(var S=0,_=g.length;S<_;S++){var A=new f(g[S]+"."+He[d.path],n.array,T,v);"CUBICSPLINE"===p.interpolation&&(A.createInterpolant=function(e){return new(this instanceof k.QuaternionKeyframeTrack?Re:xe)(this.times,this.values,this.getValueSize()/3,e)},A.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),c.push(A)}},p=0,d=s.length;p<d;p++)h(p);var f=t.name?t.name:"animation_"+e;return new r.AnimationClip(f,void 0,c)}))},s.createNodeMesh=function(e){var t=this.json,r=this,n=t.nodes[e];return void 0===n.mesh?null:r.getDependency("mesh",n.mesh).then((function(e){var t=r._getNodeRef(r.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse((function(e){if(e.isMesh)for(var t=0,r=n.weights.length;t<r;t++)e.morphTargetInfluences[t]=n.weights[t]})),t}))},s.loadNode=function(e){var t,r,s=this.json,a=this.extensions,i=this,o=s.nodes[e],u=o.name?i.createUniqueName(o.name):"";return(t=[],r=i._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)})),r&&t.push(r),void 0!==o.camera&&t.push(i.getDependency("camera",o.camera).then((function(e){return i._getNodeRef(i.cameraCache,o.camera,e)}))),i._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)).then((function(t){var r;if((r=!0===o.isBone?new n.Bone:t.length>1?new h.Group:1===t.length?t[0]:new I.Object3D)!==t[0])for(var s=0,l=t.length;s<l;s++)r.add(t[s]);if(o.name&&(r.userData.name=o.name,r.name=u),Be(r,o),o.extensions&&De(a,r,o),void 0!==o.matrix){var c=new _.Matrix4;c.fromArray(o.matrix),r.applyMatrix4(c)}else void 0!==o.translation&&r.position.fromArray(o.translation),void 0!==o.rotation&&r.quaternion.fromArray(o.rotation),void 0!==o.scale&&r.scale.fromArray(o.scale);return i.associations.has(r)||i.associations.set(r,{}),i.associations.get(r).nodes=e,r}))},s.loadScene=function(e){var r=this.json,n=this.extensions,s=this.json.scenes[e],a=this,i=new h.Group;s.name&&(i.name=a.createUniqueName(s.name)),Be(i,s),s.extensions&&De(n,i,s);for(var o=s.nodes||[],u=[],l=0,c=o.length;l<c;l++)u.push(Xe(o[l],i,r,a));return Promise.all(u).then((function(){return a.associations=function(e){for(var r,n=new Map,s=t.createForOfIteratorHelperLoose(a.associations);!(r=s()).done;){var i=r.value,o=i[0],u=i[1];(o instanceof y.Material||o instanceof K.Texture)&&n.set(o,u)}return e.traverse((function(e){var t=a.associations.get(e);null!=t&&n.set(e,t)})),n}(i),i}))},e}();function Xe(e,t,r,n){var s=r.nodes[e];return n.getDependency("node",e).then((function(e){return void 0===s.skin?e:n.getDependency("skin",s.skin).then((function(e){for(var r=[],s=0,a=(t=e).joints.length;s<a;s++)r.push(n.getDependency("node",t.joints[s]));return Promise.all(r)})).then((function(r){return e.traverse((function(e){if(e.isMesh){for(var n=[],s=[],a=0,i=r.length;a<i;a++){var o=r[a];if(o){n.push(o);var u=new _.Matrix4;void 0!==t.inverseBindMatrices&&u.fromArray(t.inverseBindMatrices.array,16*a),s.push(u)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[a])}e.bind(new D.Skeleton(n,s),e.matrixWorld)}})),e}));var t})).then((function(e){t.add(e);var a=[];if(s.children)for(var i=s.children,o=0,u=i.length;o<u;o++){var l=i[o];a.push(Xe(l,e,r,n))}return Promise.all(a)}))}function qe(e,t,r){var n=t.attributes,a=[];function i(t,n){return r.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(var o in n){var u=Oe[o]||o.toLowerCase();u in e.attributes||a.push(i(n[o],u))}if(void 0!==t.indices&&!e.index){var l=r.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));a.push(l)}return Be(e,t),function(e,t,r){var n=t.attributes,a=new s.Box3;if(void 0!==n.POSITION){var i=r.json.accessors[n.POSITION],o=i.min,u=i.max;if(void 0!==o&&void 0!==u){if(a.set(new X.Vector3(o[0],o[1],o[2]),new X.Vector3(u[0],u[1],u[2])),i.normalized){var l=Ke(be[i.componentType]);a.min.multiplyScalar(l),a.max.multiplyScalar(l)}var c=t.targets;if(void 0!==c){for(var h=new X.Vector3,p=new X.Vector3,d=0,f=c.length;d<f;d++){var m=c[d];if(void 0!==m.POSITION){var v=r.json.accessors[m.POSITION],g=v.min,T=v.max;if(void 0!==g&&void 0!==T){if(p.setX(Math.max(Math.abs(g[0]),Math.abs(T[0]))),p.setY(Math.max(Math.abs(g[1]),Math.abs(T[1]))),p.setZ(Math.max(Math.abs(g[2]),Math.abs(T[2]))),v.normalized){var x=Ke(be[v.componentType]);p.multiplyScalar(x)}h.max(p)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}a.expandByVector(h)}e.boundingBox=a;var M=new G.Sphere;a.getCenter(M.center),M.radius=a.min.distanceTo(a.max)/2,e.boundingSphere=M}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}(e,t,r),Promise.all(a).then((function(){return void 0!==t.targets?function(e,t,r){for(var n=!1,s=!1,a=!1,i=0,o=t.length;i<o;i++){var u=t[i];if(void 0!==u.POSITION&&(n=!0),void 0!==u.NORMAL&&(s=!0),void 0!==u.COLOR_0&&(a=!0),n&&s&&a)break}if(!n&&!s&&!a)return Promise.resolve(e);for(var l=[],c=[],h=[],p=0,d=t.length;p<d;p++){var f=t[p];if(n){var m=void 0!==f.POSITION?r.getDependency("accessor",f.POSITION):e.attributes.position;l.push(m)}if(s){var v=void 0!==f.NORMAL?r.getDependency("accessor",f.NORMAL):e.attributes.normal;c.push(v)}if(a){var g=void 0!==f.COLOR_0?r.getDependency("accessor",f.COLOR_0):e.attributes.color;h.push(g)}}return Promise.all([Promise.all(l),Promise.all(c),Promise.all(h)]).then((function(t){var r=t[0],i=t[1],o=t[2];return n&&(e.morphAttributes.position=r),s&&(e.morphAttributes.normal=i),a&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e}))}(e,t.targets,r):e}))}function ze(e,t){var r=e.getIndex();if(null===r){var n=[],s=e.getAttribute("position");if(void 0===s)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var a=0;a<s.count;a++)n.push(a);e.setIndex(n),r=e.getIndex()}var i=r.count-2,u=[];if(t===o.TriangleFanDrawMode)for(var l=1;l<=i;l++)u.push(r.getX(0)),u.push(r.getX(l)),u.push(r.getX(l+1));else for(var c=0;c<i;c++)c%2==0?(u.push(r.getX(c)),u.push(r.getX(c+1)),u.push(r.getX(c+2))):(u.push(r.getX(c+2)),u.push(r.getX(c+1)),u.push(r.getX(c)));u.length/3!==i&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var h=e.clone();return h.setIndex(u),h}e.GLTFLoader=W,Object.defineProperty(e,"__esModule",{value:!0})}));

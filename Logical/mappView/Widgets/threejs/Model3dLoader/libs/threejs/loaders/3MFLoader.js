/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","../core/BufferAttribute","../core/BufferGeometry","../constants","../math/Color","./FileLoader","../objects/Group","./Loader","./LoaderUtils","../math/Matrix4","../objects/Mesh","../materials/MeshStandardMaterial","../materials/MeshPhongMaterial","./TextureLoader","../libs/fflate.module"],(function(e,t,r,a,i,n,o,s,u,l,p,c,d,v,h,f){"use strict";var g=function(e){function u(t){var r;return(r=e.call(this,t)||this).availableExtensions=[],r}t.inheritsLoose(u,e);var g=u.prototype;return g.load=function(e,t,r,a){var i=this,n=new o.FileLoader(i.manager);n.setPath(i.path),n.setResponseType("arraybuffer"),n.setRequestHeader(i.requestHeader),n.setWithCredentials(i.withCredentials),n.load(e,(function(r){try{t(i.parse(r))}catch(t){a?a(t):console.error(t),i.manager.itemError(e)}}),r,a)},g.parse=function(e){var t=this,o=new h.TextureLoader(this.manager);function u(e){for(var t=[],r=(new DOMParser).parseFromString(e,"application/xml").querySelectorAll("Relationship"),a=0;a<r.length;a++){var i=r[a],n={target:i.getAttribute("Target"),id:i.getAttribute("Id"),type:i.getAttribute("Type")};t.push(n)}return t}function g(e){for(var t={id:e.getAttribute("id"),basematerials:[]},r=e.querySelectorAll("base"),a=0;a<r.length;a++){var i=y(r[a]);i.index=a,t.basematerials.push(i)}return t}function b(e){for(var t={id:e.getAttribute("id"),texid:e.getAttribute("texid"),displaypropertiesid:e.getAttribute("displaypropertiesid")},r=e.querySelectorAll("tex2coord"),a=[],i=0;i<r.length;i++){var n=r[i],o=n.getAttribute("u"),s=n.getAttribute("v");a.push(parseFloat(o),parseFloat(s))}return t.uvs=new Float32Array(a),t}function m(e){for(var t={id:e.getAttribute("id"),displaypropertiesid:e.getAttribute("displaypropertiesid")},r=e.querySelectorAll("color"),a=[],i=new n.Color,o=0;o<r.length;o++){var s=r[o].getAttribute("color");i.setStyle(s.substring(0,7)),i.convertSRGBToLinear(),a.push(i.r,i.g,i.b)}return t.colors=new Float32Array(a),t}function A(e){for(var t={id:e.getAttribute("id")},r=e.querySelectorAll("pbmetallic"),a=[],i=0;i<r.length;i++){var n=r[i];a.push({name:n.getAttribute("name"),metallicness:parseFloat(n.getAttribute("metallicness")),roughness:parseFloat(n.getAttribute("roughness"))})}return t.data=a,t}function y(e){var t={};return t.name=e.getAttribute("name"),t.displaycolor=e.getAttribute("displaycolor"),t.displaypropertiesid=e.getAttribute("displaypropertiesid"),t}function x(e){var t={};t.objectId=e.getAttribute("objectid");var r=e.getAttribute("transform");return r&&(t.transform=w(r)),t}function w(e){var t=[];e.split(" ").forEach((function(e){t.push(parseFloat(e))}));var r=new p.Matrix4;return r.set(t[0],t[3],t[6],t[9],t[1],t[4],t[7],t[10],t[2],t[5],t[8],t[11],0,0,0,1),r}function F(e){var t={type:e.getAttribute("type")},r=e.getAttribute("id");r&&(t.id=r);var a=e.getAttribute("pid");a&&(t.pid=a);var i=e.getAttribute("pindex");i&&(t.pindex=i);var n=e.getAttribute("thumbnail");n&&(t.thumbnail=n);var o=e.getAttribute("partnumber");o&&(t.partnumber=o);var s=e.getAttribute("name");s&&(t.name=s);var u=e.querySelector("mesh");u&&(t.mesh=function(e){for(var t={},r=[],a=e.querySelectorAll("vertices vertex"),i=0;i<a.length;i++){var n=a[i],o=n.getAttribute("x"),s=n.getAttribute("y"),u=n.getAttribute("z");r.push(parseFloat(o),parseFloat(s),parseFloat(u))}t.vertices=new Float32Array(r);for(var l=[],p=[],c=e.querySelectorAll("triangles triangle"),d=0;d<c.length;d++){var v=c[d],h=v.getAttribute("v1"),f=v.getAttribute("v2"),g=v.getAttribute("v3"),b=v.getAttribute("p1"),m=v.getAttribute("p2"),A=v.getAttribute("p3"),y=v.getAttribute("pid"),x={};x.v1=parseInt(h,10),x.v2=parseInt(f,10),x.v3=parseInt(g,10),p.push(x.v1,x.v2,x.v3),b&&(x.p1=parseInt(b,10)),m&&(x.p2=parseInt(m,10)),A&&(x.p3=parseInt(A,10)),y&&(x.pid=y),0<Object.keys(x).length&&l.push(x)}return t.triangleProperties=l,t.triangles=new Uint32Array(p),t}(u));var l=e.querySelector("components");return l&&(t.components=function(e){for(var t=[],r=e.querySelectorAll("component"),a=0;a<r.length;a++){var i=x(r[a]);t.push(i)}return t}(l)),t}function S(e){var t={unit:e.getAttribute("unit")||"millimeter"},r=e.querySelectorAll("metadata");r&&(t.metadata=function(e){for(var t={},r=0;r<e.length;r++){var a=e[r],i=a.getAttribute("name");0<=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate"].indexOf(i)&&(t[i]=a.textContent)}return t}(r));var a=e.querySelector("resources");a&&(t.resources=function(e){for(var t={basematerials:{}},r=e.querySelectorAll("basematerials"),a=0;a<r.length;a++){var i=g(r[a]);t.basematerials[i.id]=i}t.texture2d={};for(var n,o=e.querySelectorAll("texture2d"),s=0;s<o.length;s++){var u={id:(n=o[s]).getAttribute("id"),path:n.getAttribute("path"),contenttype:n.getAttribute("contenttype"),tilestyleu:n.getAttribute("tilestyleu"),tilestylev:n.getAttribute("tilestylev"),filter:n.getAttribute("filter")};t.texture2d[u.id]=u}t.colorgroup={};for(var l=e.querySelectorAll("colorgroup"),p=0;p<l.length;p++){var c=m(l[p]);t.colorgroup[c.id]=c}t.pbmetallicdisplayproperties={};for(var d=e.querySelectorAll("pbmetallicdisplayproperties"),v=0;v<d.length;v++){var h=A(d[v]);t.pbmetallicdisplayproperties[h.id]=h}t.texture2dgroup={};for(var f=e.querySelectorAll("texture2dgroup"),y=0;y<f.length;y++){var x=b(f[y]);t.texture2dgroup[x.id]=x}t.object={};for(var w=e.querySelectorAll("object"),S=0;S<w.length;S++){var M=F(w[S]);t.object[M.id]=M}return t}(a));var i=e.querySelector("build");return i&&(t.build=function(e){for(var t=[],r=e.querySelectorAll("item"),a=0;a<r.length;a++){var i=r[a],n={objectId:i.getAttribute("objectid")},o=i.getAttribute("transform");o&&(n.transform=w(o)),t.push(n)}return t}(i)),t}function M(e,t,r,a){var n=e.texid,s=r.resources.texture2d[n];if(s){var u=a[s.path],l=s.contenttype,p=new Blob([u],{type:l}),c=URL.createObjectURL(p),d=o.load(c,(function(){URL.revokeObjectURL(c)}));switch(d.encoding=i.sRGBEncoding,s.tilestyleu){case"wrap":default:d.wrapS=i.RepeatWrapping;break;case"mirror":d.wrapS=i.MirroredRepeatWrapping;break;case"none":case"clamp":d.wrapS=i.ClampToEdgeWrapping}switch(s.tilestylev){case"wrap":default:d.wrapT=i.RepeatWrapping;break;case"mirror":d.wrapT=i.MirroredRepeatWrapping;break;case"none":case"clamp":d.wrapT=i.ClampToEdgeWrapping}switch(s.filter){case"auto":default:d.magFilter=i.LinearFilter,d.minFilter=i.LinearMipmapLinearFilter;break;case"linear":d.magFilter=i.LinearFilter,d.minFilter=i.LinearFilter;break;case"nearest":d.magFilter=i.NearestFilter,d.minFilter=i.NearestFilter}return d}return null}function L(e,t,i,n,o,s,u){for(var l=u.pindex,p={},d=0,v=t.length;d<v;d++){var h=t[d],f=void 0!==h.p1?h.p1:l;void 0===p[f]&&(p[f]=[]),p[f].push(h)}for(var g=Object.keys(p),b=[],m=0,A=g.length;m<A;m++){for(var y=g[m],x=p[y],w=k(e.basematerials[y],n,o,s,u,B),F=new a.BufferGeometry,S=[],M=i.vertices,L=0,j=x.length;L<j;L++){var q=x[L];S.push(M[3*q.v1+0]),S.push(M[3*q.v1+1]),S.push(M[3*q.v1+2]),S.push(M[3*q.v2+0]),S.push(M[3*q.v2+1]),S.push(M[3*q.v2+2]),S.push(M[3*q.v3+0]),S.push(M[3*q.v3+1]),S.push(M[3*q.v3+2])}F.setAttribute("position",new r.Float32BufferAttribute(S,3));var T=new c.Mesh(F,w);b.push(T)}return b}function j(e,t,i,n,o,s,u){for(var l=new a.BufferGeometry,p=[],d=[],h=i.vertices,f=e.uvs,g=0,b=t.length;g<b;g++){var m=t[g];p.push(h[3*m.v1+0]),p.push(h[3*m.v1+1]),p.push(h[3*m.v1+2]),p.push(h[3*m.v2+0]),p.push(h[3*m.v2+1]),p.push(h[3*m.v2+2]),p.push(h[3*m.v3+0]),p.push(h[3*m.v3+1]),p.push(h[3*m.v3+2]),d.push(f[2*m.p1+0]),d.push(f[2*m.p1+1]),d.push(f[2*m.p2+0]),d.push(f[2*m.p2+1]),d.push(f[2*m.p3+0]),d.push(f[2*m.p3+1])}l.setAttribute("position",new r.Float32BufferAttribute(p,3)),l.setAttribute("uv",new r.Float32BufferAttribute(d,2));var A=k(e,n,o,s,u,M),y=new v.MeshPhongMaterial({map:A,flatShading:!0});return new c.Mesh(l,y)}function q(e,t,i,n){for(var o=new a.BufferGeometry,s=[],u=[],l=i.vertices,p=e.colors,d=0,h=t.length;d<h;d++){var f=t[d],g=f.v1,b=f.v2,m=f.v3;s.push(l[3*g+0]),s.push(l[3*g+1]),s.push(l[3*g+2]),s.push(l[3*b+0]),s.push(l[3*b+1]),s.push(l[3*b+2]),s.push(l[3*m+0]),s.push(l[3*m+1]),s.push(l[3*m+2]);var A=void 0!==f.p1?f.p1:n.pindex,y=void 0!==f.p2?f.p2:A,x=void 0!==f.p3?f.p3:A;u.push(p[3*A+0]),u.push(p[3*A+1]),u.push(p[3*A+2]),u.push(p[3*y+0]),u.push(p[3*y+1]),u.push(p[3*y+2]),u.push(p[3*x+0]),u.push(p[3*x+1]),u.push(p[3*x+2])}o.setAttribute("position",new r.Float32BufferAttribute(s,3)),o.setAttribute("color",new r.Float32BufferAttribute(u,3));var w=new v.MeshPhongMaterial({vertexColors:!0,flatShading:!0});return new c.Mesh(o,w)}function T(e){var t=new a.BufferGeometry;t.setIndex(new r.BufferAttribute(e.triangles,1)),t.setAttribute("position",new r.BufferAttribute(e.vertices,3));var i=new v.MeshPhongMaterial({color:16777215,flatShading:!0});return new c.Mesh(t,i)}function R(e,t){return void 0!==t.resources.texture2dgroup[e]?"texture":void 0!==t.resources.basematerials[e]?"material":void 0!==t.resources.colorgroup[e]?"vertexColors":"default"===e?"default":void 0}function E(e,t,r,a,i){for(var n=new s.Group,o=function(e,t){for(var r={},a=e.triangleProperties,i=t.pid,n=0,o=a.length;n<o;n++){var s=a[n],u=void 0!==s.pid?s.pid:i;void 0===u&&(u="default"),void 0===r[u]&&(r[u]=[]),r[u].push(s)}return r}(e,i),u=function(e,t,r,a,i,n){for(var o=Object.keys(e),s=[],u=0,l=o.length;u<l;u++){var p=o[u],c=e[p];switch(R(p,a)){case"material":for(var d=L(a.resources.basematerials[p],c,t,r,a,i,n),v=0,h=d.length;v<h;v++)s.push(d[v]);break;case"texture":var f=a.resources.texture2dgroup[p];s.push(j(f,c,t,r,a,i,n));break;case"vertexColors":var g=a.resources.colorgroup[p];s.push(q(g,c,t,n));break;case"default":s.push(T(t));break;default:console.error("THREE.3MFLoader: Unsupported resource type.")}}if(n.name)for(var b=0;b<s.length;b++)s[b].name=n.name;return s}(o,e,t,r,a,i),l=0,p=u.length;l<p;l++)n.add(u[l]);return n}function k(e,t,r,a,i,n){return void 0!==e.build||(e.build=n(e,t,r,a,i)),e.build}function B(e,t,r){var a,i=e.displaypropertiesid,n=r.resources.pbmetallicdisplayproperties;if(null!==i&&void 0!==n[i]){var o=n[i].data[e.index];a=new d.MeshStandardMaterial({flatShading:!0,roughness:o.roughness,metalness:o.metallicness})}else a=new v.MeshPhongMaterial({flatShading:!0});a.name=e.name;var s=e.displaycolor,u=s.substring(0,7);return a.color.setStyle(u),a.color.convertSRGBToLinear(),9===s.length&&(a.opacity=parseInt(s.charAt(7)+s.charAt(8),16)/255),a}function I(e,t,r,a){for(var i=new s.Group,n=0;n<e.length;n++){var o=e[n],u=t[o.objectId];void 0===u&&(C(o.objectId,t,r,a),u=t[o.objectId]);var l=u.clone(),p=o.transform;p&&l.applyMatrix4(p),i.add(l)}return i}function C(e,r,a,i){var n=a.resources.object[e];if(n.mesh){var o=n.mesh;!function(e,r,a){if(e){for(var i=[],n=Object.keys(e),o=0;o<n.length;o++)for(var s=n[o],u=0;u<t.availableExtensions.length;u++){var l=t.availableExtensions[u];l.ns===s&&i.push(l)}for(var p=0;p<i.length;p++){var c=i[p];c.apply(a,e[c.ns],r)}}}(a.extensions,o,a.xml),r[n.id]=k(o,r,a,i,n,E)}else{var s=n.components;r[n.id]=k(s,r,a,i,n,I)}n.name&&(r[n.id].name=n.name)}var O=function(e){var t,r,a,i=null,n=null,o=[],s=[],p={},c={};try{i=f.unzipSync(new Uint8Array(e))}catch(e){if(e instanceof ReferenceError)return console.error("THREE.3MFLoader: fflate missing and file is compressed."),null}for(n in i)n.match(/\_rels\/.rels$/)?t=n:n.match(/3D\/_rels\/.*\.model\.rels$/)?r=n:n.match(/^3D\/.*\.model$/)?o.push(n):n.match(/^3D\/Textures?\/.*/)&&s.push(n);var d=i[t],v=u(l.LoaderUtils.decodeText(d));if(r){var h=i[r];a=u(l.LoaderUtils.decodeText(h))}for(var g=0;g<o.length;g++){var b=o[g],m=i[b],A=l.LoaderUtils.decodeText(m),y=(new DOMParser).parseFromString(A,"application/xml");"model"!==y.documentElement.nodeName.toLowerCase()&&console.error("THREE.3MFLoader: Error loading 3MF - no 3MF document found: ",b);for(var x=y.querySelector("model"),w={},F=0;F<x.attributes.length;F++){var M=x.attributes[F];M.name.match(/^xmlns:(.+)$/)&&(w[M.value]=RegExp.$1)}var L=S(x);L.xml=x,0<Object.keys(w).length&&(L.extensions=w),p[b]=L}for(var j=0;j<s.length;j++){var q=s[j];c[q]=i[q].buffer}return{rels:v,modelRels:a,model:p,printTicket:{},texture:c}}(e),G=function(e){var t=e.model,r=e.modelRels,a={},i=Object.keys(t),n={};if(r)for(var o=0,s=r.length;o<s;o++){var u=r[o],l=u.target.substring(1);e.texture[l]&&(n[u.target]=e.texture[l])}for(var p=0;p<i.length;p++)for(var c=t[i[p]],d=Object.keys(c.resources.object),v=0;v<d.length;v++){C(d[v],a,c,n)}return a}(O);return function(e,t){for(var r=new s.Group,a=function(e){for(var t=0;t<e.length;t++){var r=e[t];if("model"===r.target.split(".").pop().toLowerCase())return r}}(t.rels),i=t.model[a.target.substring(1)].build,n=0;n<i.length;n++){var o=i[n],u=e[o.objectId].clone(),l=o.transform;l&&u.applyMatrix4(l),r.add(u)}return r}(G,O)},g.addExtension=function(e){this.availableExtensions.push(e)},u}(u.Loader);e.ThreeMFLoader=g,Object.defineProperty(e,"__esModule",{value:!0})}));

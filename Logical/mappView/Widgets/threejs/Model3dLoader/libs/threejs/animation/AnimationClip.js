/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","./AnimationUtils","./KeyframeTrack","./tracks/BooleanKeyframeTrack","./tracks/ColorKeyframeTrack","./tracks/NumberKeyframeTrack","./tracks/QuaternionKeyframeTrack","./tracks/StringKeyframeTrack","./tracks/VectorKeyframeTrack","../math/MathUtils","../constants"],(function(r,e,t,a,n,o,i,s,c,u,h){"use strict";var m=function(){function r(r,e,t,a){void 0===e&&(e=-1),void 0===a&&(a=h.NormalAnimationBlendMode),this.name=r,this.tracks=t,this.duration=e,this.blendMode=a,this.uuid=u.generateUUID(),this.duration<0&&this.resetDuration()}r.parse=function(r){for(var e=[],t=r.tracks,a=1/(r.fps||1),n=0,o=t.length;n!==o;++n)e.push(f(t[n]).scale(a));var i=new this(r.name,r.duration,e,r.blendMode);return i.uuid=r.uuid,i},r.toJSON=function(r){for(var e=[],a=r.tracks,n={name:r.name,duration:r.duration,tracks:e,uuid:r.uuid,blendMode:r.blendMode},o=0,i=a.length;o!==i;++o)e.push(t.KeyframeTrack.toJSON(a[o]));return n},r.CreateFromMorphTargetSequence=function(r,t,a,n){for(var i=t.length,s=[],c=0;c<i;c++){var u=[],h=[];u.push((c+i-1)%i,c,(c+1)%i),h.push(0,1,0);var m=e.AnimationUtils.getKeyframeOrder(u);u=e.AnimationUtils.sortedArray(u,1,m),h=e.AnimationUtils.sortedArray(h,1,m),n||0!==u[0]||(u.push(i),h.push(h[0])),s.push(new o.NumberKeyframeTrack(".morphTargetInfluences["+t[c].name+"]",u,h).scale(1/a))}return new this(r,-1,s)},r.findByName=function(r,e){var t=r;if(!Array.isArray(r)){var a=r;t=a.geometry&&a.geometry.animations||a.animations}for(var n=0;n<t.length;n++)if(t[n].name===e)return t[n];return null},r.CreateClipsFromMorphTargetSequences=function(r,e,t){for(var a={},n=/^([\w-]*?)([\d]+)$/,o=0,i=r.length;o<i;o++){var s=r[o],c=s.name.match(n);if(c&&c.length>1){var u=c[1],h=a[u];h||(a[u]=h=[]),h.push(s)}}var m=[];for(var f in a)m.push(this.CreateFromMorphTargetSequence(f,a[f],e,t));return m},r.parseAnimation=function(r,t){if(!r)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;for(var a=function(r,t,a,n,o){if(0!==a.length){var i=[],s=[];e.AnimationUtils.flattenJSON(a,i,s,n),0!==i.length&&o.push(new r(t,i,s))}},n=[],s=r.name||"default",u=r.fps||30,h=r.blendMode,m=r.length||-1,f=r.hierarchy||[],l=0;l<f.length;l++){var d=f[l].keys;if(d&&0!==d.length)if(d[0].morphTargets){var p={},v=void 0;for(v=0;v<d.length;v++)if(d[v].morphTargets)for(var k=0;k<d[v].morphTargets.length;k++)p[d[v].morphTargets[k]]=-1;for(var g in p){for(var y=[],T=[],K=0;K!==d[v].morphTargets.length;++K){var b=d[v];y.push(b.time),T.push(b.morphTarget===g?1:0)}n.push(new o.NumberKeyframeTrack(".morphTargetInfluence["+g+"]",y,T))}m=p.length*u}else{var w=".bones["+t[l].name+"]";a(c.VectorKeyframeTrack,w+".position",d,"pos",n),a(i.QuaternionKeyframeTrack,w+".quaternion",d,"rot",n),a(c.VectorKeyframeTrack,w+".scale",d,"scl",n)}}return 0===n.length?null:new this(s,m,n,h)};var a=r.prototype;return a.resetDuration=function(){for(var r=0,e=0,t=this.tracks.length;e!==t;++e){var a=this.tracks[e];r=Math.max(r,a.times[a.times.length-1])}return this.duration=r,this},a.trim=function(){for(var r=0;r<this.tracks.length;r++)this.tracks[r].trim(0,this.duration);return this},a.validate=function(){for(var r=!0,e=0;e<this.tracks.length;e++)r=r&&this.tracks[e].validate();return r},a.optimize=function(){for(var r=0;r<this.tracks.length;r++)this.tracks[r].optimize();return this},a.clone=function(){for(var r=[],e=0;e<this.tracks.length;e++)r.push(this.tracks[e].clone());return new this.constructor(this.name,this.duration,r,this.blendMode)},a.toJSON=function(){return this.constructor.toJSON(this)},r}();function f(r){if(void 0===r.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");var t=function(r){switch(r.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return o.NumberKeyframeTrack;case"vector":case"vector2":case"vector3":case"vector4":return c.VectorKeyframeTrack;case"color":return n.ColorKeyframeTrack;case"quaternion":return i.QuaternionKeyframeTrack;case"bool":case"boolean":return a.BooleanKeyframeTrack;case"string":return s.StringKeyframeTrack}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+r)}(r.type);if(void 0===r.times){var u=[],h=[];e.AnimationUtils.flattenJSON(r.keys,u,h,"value"),r.times=u,r.values=h}return void 0!==t.parse?t.parse(r):new t(r.name,r.times,r.values,r.interpolation)}r.AnimationClip=m,Object.defineProperty(r,"__esModule",{value:!0})}));

/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../_virtual/_rollupPluginBabelHelpers","./AnimationAction","../core/EventDispatcher","../math/interpolants/LinearInterpolant","./PropertyBinding","./PropertyMixer","./AnimationClip","../constants"],(function(n,t,i,e,o,c,a,r,s){"use strict";var _=new Float32Array(1),d=function(n){function e(t){var i;return(i=n.call(this)||this)._root=t,i._initMemoryManager(),i._accuIndex=0,i.time=0,i.timeScale=1,i}t.inheritsLoose(e,n);var d=e.prototype;return d._bindAction=function(n,t){var i=n._localRoot||this._root,e=n._clip.tracks,o=e.length,r=n._propertyBindings,s=n._interpolants,_=i.uuid,d=this._bindingsByRootAndName,h=d[_];void 0===h&&(h={},d[_]=h);for(var l=0;l!==o;++l){var u=e[l],v=u.name,p=h[v];if(void 0!==p)++p.referenceCount,r[l]=p;else{if(void 0!==(p=r[l])){null===p._cacheIndex&&(++p.referenceCount,this._addInactiveBinding(p,_,v));continue}var A=t&&t._propertyBindings[l].binding.parsedPath;++(p=new a.PropertyMixer(c.PropertyBinding.create(i,v,A),u.ValueTypeName,u.getValueSize())).referenceCount,this._addInactiveBinding(p,_,v),r[l]=p}s[l].resultBuffer=p.buffer}},d._activateAction=function(n){if(!this._isActiveAction(n)){if(null===n._cacheIndex){var t=(n._localRoot||this._root).uuid,i=n._clip.uuid,e=this._actionsByClip[i];this._bindAction(n,e&&e.knownActions[0]),this._addInactiveAction(n,i,t)}for(var o=n._propertyBindings,c=0,a=o.length;c!==a;++c){var r=o[c];0==r.useCount++&&(this._lendBinding(r),r.saveOriginalState())}this._lendAction(n)}},d._deactivateAction=function(n){if(this._isActiveAction(n)){for(var t=n._propertyBindings,i=0,e=t.length;i!==e;++i){var o=t[i];0==--o.useCount&&(o.restoreOriginalState(),this._takeBackBinding(o))}this._takeBackAction(n)}},d._initMemoryManager=function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var n=this;this.stats={actions:{get total(){return n._actions.length},get inUse(){return n._nActiveActions}},bindings:{get total(){return n._bindings.length},get inUse(){return n._nActiveBindings}},controlInterpolants:{get total(){return n._controlInterpolants.length},get inUse(){return n._nActiveControlInterpolants}}}},d._isActiveAction=function(n){var t=n._cacheIndex;return null!==t&&t<this._nActiveActions},d._addInactiveAction=function(n,t,i){var e=this._actions,o=this._actionsByClip,c=o[t];if(void 0===c)c={knownActions:[n],actionByRoot:{}},n._byClipCacheIndex=0,o[t]=c;else{var a=c.knownActions;n._byClipCacheIndex=a.length,a.push(n)}n._cacheIndex=e.length,e.push(n),c.actionByRoot[i]=n},d._removeInactiveAction=function(n){var t=this._actions,i=t[t.length-1],e=n._cacheIndex;i._cacheIndex=e,t[e]=i,t.pop(),n._cacheIndex=null;var o=n._clip.uuid,c=this._actionsByClip,a=c[o],r=a.knownActions,s=r[r.length-1],_=n._byClipCacheIndex;s._byClipCacheIndex=_,r[_]=s,r.pop(),n._byClipCacheIndex=null,delete a.actionByRoot[(n._localRoot||this._root).uuid],0===r.length&&delete c[o],this._removeInactiveBindingsForAction(n)},d._removeInactiveBindingsForAction=function(n){for(var t=n._propertyBindings,i=0,e=t.length;i!==e;++i){var o=t[i];0==--o.referenceCount&&this._removeInactiveBinding(o)}},d._lendAction=function(n){var t=this._actions,i=n._cacheIndex,e=this._nActiveActions++,o=t[e];n._cacheIndex=e,t[e]=n,o._cacheIndex=i,t[i]=o},d._takeBackAction=function(n){var t=this._actions,i=n._cacheIndex,e=--this._nActiveActions,o=t[e];n._cacheIndex=e,t[e]=n,o._cacheIndex=i,t[i]=o},d._addInactiveBinding=function(n,t,i){var e=this._bindingsByRootAndName,o=this._bindings,c=e[t];void 0===c&&(c={},e[t]=c),c[i]=n,n._cacheIndex=o.length,o.push(n)},d._removeInactiveBinding=function(n){var t=this._bindings,i=n.binding,e=i.rootNode.uuid,o=i.path,c=this._bindingsByRootAndName,a=c[e],r=t[t.length-1],s=n._cacheIndex;r._cacheIndex=s,t[s]=r,t.pop(),delete a[o],0===Object.keys(a).length&&delete c[e]},d._lendBinding=function(n){var t=this._bindings,i=n._cacheIndex,e=this._nActiveBindings++,o=t[e];n._cacheIndex=e,t[e]=n,o._cacheIndex=i,t[i]=o},d._takeBackBinding=function(n){var t=this._bindings,i=n._cacheIndex,e=--this._nActiveBindings,o=t[e];n._cacheIndex=e,t[e]=n,o._cacheIndex=i,t[i]=o},d._lendControlInterpolant=function(){var n=this._controlInterpolants,t=this._nActiveControlInterpolants++,i=n[t];return void 0===i&&((i=new o.LinearInterpolant(new Float32Array(2),new Float32Array(2),1,_)).__cacheIndex=t,n[t]=i),i},d._takeBackControlInterpolant=function(n){var t=this._controlInterpolants,i=n.__cacheIndex,e=--this._nActiveControlInterpolants,o=t[e];n.__cacheIndex=e,t[e]=n,o.__cacheIndex=i,t[i]=o},d.clipAction=function(n,t,e){var o=t||this._root,c=o.uuid,a="string"==typeof n?r.AnimationClip.findByName(o,n):n,_=null!==a?a.uuid:n,d=this._actionsByClip[_],h=null;if(void 0===e&&(e=null!==a?a.blendMode:s.NormalAnimationBlendMode),void 0!==d){var l=d.actionByRoot[c];if(void 0!==l&&l.blendMode===e)return l;h=d.knownActions[0],null===a&&(a=h._clip)}if(null===a)return null;var u=new i.AnimationAction(this,a,t,e);return this._bindAction(u,h),this._addInactiveAction(u,_,c),u},d.existingAction=function(n,t){var i=t||this._root,e=i.uuid,o="string"==typeof n?r.AnimationClip.findByName(i,n):n,c=o?o.uuid:n,a=this._actionsByClip[c];return void 0!==a&&a.actionByRoot[e]||null},d.stopAllAction=function(){for(var n=this._actions,t=this._nActiveActions-1;t>=0;--t)n[t].stop();return this},d.update=function(n){n*=this.timeScale;for(var t=this._actions,i=this._nActiveActions,e=this.time+=n,o=Math.sign(n),c=this._accuIndex^=1,a=0;a!==i;++a){t[a]._update(e,n,o,c)}for(var r=this._bindings,s=this._nActiveBindings,_=0;_!==s;++_)r[_].apply(c);return this},d.setTime=function(n){this.time=0;for(var t=0;t<this._actions.length;t++)this._actions[t].time=0;return this.update(n)},d.getRoot=function(){return this._root},d.uncacheClip=function(n){var t=this._actions,i=n.uuid,e=this._actionsByClip,o=e[i];if(void 0!==o){for(var c=o.knownActions,a=0,r=c.length;a!==r;++a){var s=c[a];this._deactivateAction(s);var _=s._cacheIndex,d=t[t.length-1];s._cacheIndex=null,s._byClipCacheIndex=null,d._cacheIndex=_,t[_]=d,t.pop(),this._removeInactiveBindingsForAction(s)}delete e[i]}},d.uncacheRoot=function(n){var t=n.uuid,i=this._actionsByClip;for(var e in i){var o=i[e].actionByRoot[t];void 0!==o&&(this._deactivateAction(o),this._removeInactiveAction(o))}var c=this._bindingsByRootAndName[t];if(void 0!==c)for(var a in c){var r=c[a];r.restoreOriginalState(),this._removeInactiveBinding(r)}},d.uncacheAction=function(n,t){var i=this.existingAction(n,t);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))},e}(e.EventDispatcher);n.AnimationMixer=d,Object.defineProperty(n,"__esModule",{value:!0})}));

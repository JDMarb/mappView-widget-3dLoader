/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../../_virtual/_rollupPluginBabelHelpers","../../cameras/ArrayCamera","../../core/EventDispatcher","../../cameras/PerspectiveCamera","../../math/Vector3","../../math/Vector4","../webgl/WebGLAnimation","../WebGLRenderTarget","./WebXRController","../../textures/DepthTexture","../../constants"],(function(e,t,r,n,a,i,o,s,l,c,u,d){"use strict";var p=function(e){function n(n,p){var v;v=e.call(this)||this;var f=t.assertThisInitialized(v),m=null,g=1,h=null,x="local-floor",y=null,b=null,w=null,R=null,W=null,L=null,E=p.getContextAttributes(),T=null,F=null,S=[],C=new Map,M=new a.PerspectiveCamera;M.layers.enable(1),M.viewport=new o.Vector4;var P=new a.PerspectiveCamera;P.layers.enable(2),P.viewport=new o.Vector4;var G=[M,P],V=new r.ArrayCamera;V.layers.enable(1),V.layers.enable(2);var q=null,A=null;function X(e){var t=C.get(e.inputSource);void 0!==t&&t.dispatchEvent({type:e.type,data:e.inputSource})}function j(){m.removeEventListener("select",X),m.removeEventListener("selectstart",X),m.removeEventListener("selectend",X),m.removeEventListener("squeeze",X),m.removeEventListener("squeezestart",X),m.removeEventListener("squeezeend",X),m.removeEventListener("end",j),m.removeEventListener("inputsourceschange",B),C.forEach((function(e,t){void 0!==e&&e.disconnect(t)})),C.clear(),q=null,A=null,n.setRenderTarget(T),W=null,R=null,w=null,m=null,F=null,_.stop(),f.isPresenting=!1,f.dispatchEvent({type:"sessionend"})}function B(e){for(var t=m.inputSources,r=0;r<t.length;r++){var n="right"===t[r].handedness?1:0;C.set(t[r],S[n])}for(var a=0;a<e.removed.length;a++){var i=e.removed[a],o=C.get(i);o&&(o.dispatchEvent({type:"disconnected",data:i}),C.delete(i))}for(var s=0;s<e.added.length;s++){var l=e.added[s],c=C.get(l);c&&c.dispatchEvent({type:"connected",data:l})}}v.cameraAutoUpdate=!0,v.enabled=!1,v.isPresenting=!1,v.getController=function(e){var t=S[e];return void 0===t&&(t=new c.WebXRController,S[e]=t),t.getTargetRaySpace()},v.getControllerGrip=function(e){var t=S[e];return void 0===t&&(t=new c.WebXRController,S[e]=t),t.getGripSpace()},v.getHand=function(e){var t=S[e];return void 0===t&&(t=new c.WebXRController,S[e]=t),t.getHandSpace()},v.setFramebufferScaleFactor=function(e){g=e,!0===f.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},v.setReferenceSpaceType=function(e){x=e,!0===f.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},v.getReferenceSpace=function(){return y||h},v.setReferenceSpace=function(e){y=e},v.getBaseLayer=function(){return null!==R?R:W},v.getBinding=function(){return w},v.getFrame=function(){return L},v.getSession=function(){return m},v.setSession=function(){var e=t.asyncToGenerator(t.regeneratorRuntime().mark((function e(r){var a,i,o,s,c;return t.regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===(m=r)){e.next=25;break}if(T=n.getRenderTarget(),m.addEventListener("select",X),m.addEventListener("selectstart",X),m.addEventListener("selectend",X),m.addEventListener("squeeze",X),m.addEventListener("squeezestart",X),m.addEventListener("squeezeend",X),m.addEventListener("end",j),m.addEventListener("inputsourceschange",B),!0===E.xrCompatible){e.next=14;break}return e.next=14,p.makeXRCompatible();case 14:return void 0===m.renderState.layers||!1===n.capabilities.isWebGL2?(a={antialias:void 0!==m.renderState.layers||E.antialias,alpha:E.alpha,depth:E.depth,stencil:E.stencil,framebufferScaleFactor:g},W=new XRWebGLLayer(m,p,a),m.updateRenderState({baseLayer:W}),F=new l.WebGLRenderTarget(W.framebufferWidth,W.framebufferHeight,{format:d.RGBAFormat,type:d.UnsignedByteType,encoding:n.outputEncoding})):(i=null,o=null,s=null,E.depth&&(s=E.stencil?35056:33190,i=E.stencil?d.DepthStencilFormat:d.DepthFormat,o=E.stencil?d.UnsignedInt248Type:d.UnsignedIntType),c={colorFormat:32856,depthFormat:s,scaleFactor:g},w=new XRWebGLBinding(m,p),R=w.createProjectionLayer(c),m.updateRenderState({layers:[R]}),F=new l.WebGLRenderTarget(R.textureWidth,R.textureHeight,{format:d.RGBAFormat,type:d.UnsignedByteType,depthTexture:new u.DepthTexture(R.textureWidth,R.textureHeight,o,void 0,void 0,void 0,void 0,void 0,void 0,i),stencilBuffer:E.stencil,encoding:n.outputEncoding,samples:E.antialias?4:0}),n.properties.get(F).__ignoreDepthValues=R.ignoreDepthValues),F.isXRRenderTarget=!0,this.setFoveation(1),y=null,e.next=20,m.requestReferenceSpace(x);case 20:h=e.sent,_.setContext(m),_.start(),f.isPresenting=!0,f.dispatchEvent({type:"sessionstart"});case 25:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}();var D=new i.Vector3,H=new i.Vector3;function z(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}v.updateCamera=function(e){if(null!==m){V.near=P.near=M.near=e.near,V.far=P.far=M.far=e.far,q===V.near&&A===V.far||(m.updateRenderState({depthNear:V.near,depthFar:V.far}),q=V.near,A=V.far);var t=e.parent,r=V.cameras;z(V,t);for(var n=0;n<r.length;n++)z(r[n],t);V.matrixWorld.decompose(V.position,V.quaternion,V.scale),e.position.copy(V.position),e.quaternion.copy(V.quaternion),e.scale.copy(V.scale),e.matrix.copy(V.matrix),e.matrixWorld.copy(V.matrixWorld);for(var a=e.children,i=0,o=a.length;i<o;i++)a[i].updateMatrixWorld(!0);2===r.length?function(e,t,r){D.setFromMatrixPosition(t.matrixWorld),H.setFromMatrixPosition(r.matrixWorld);var n=D.distanceTo(H),a=t.projectionMatrix.elements,i=r.projectionMatrix.elements,o=a[14]/(a[10]-1),s=a[14]/(a[10]+1),l=(a[9]+1)/a[5],c=(a[9]-1)/a[5],u=(a[8]-1)/a[0],d=(i[8]+1)/i[0],p=o*u,v=o*d,f=n/(-u+d),m=f*-u;t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(m),e.translateZ(f),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert();var g=o+f,h=s+f,x=p-m,y=v+(n-m),b=l*s/h*g,w=c*s/h*g;e.projectionMatrix.makePerspective(x,y,b,w,g,h)}(V,M,P):V.projectionMatrix.copy(M.projectionMatrix)}},v.getCamera=function(){return V},v.getFoveation=function(){return null!==R?R.fixedFoveation:null!==W?W.fixedFoveation:void 0},v.setFoveation=function(e){null!==R&&(R.fixedFoveation=e),null!==W&&void 0!==W.fixedFoveation&&(W.fixedFoveation=e)};var I=null;var _=new s.WebGLAnimation;return _.setAnimationLoop((function(e,t){if(b=t.getViewerPose(y||h),L=t,null!==b){var r=b.views;null!==W&&(n.setRenderTargetFramebuffer(F,W.framebuffer),n.setRenderTarget(F));var i=!1;r.length!==V.cameras.length&&(V.cameras.length=0,i=!0);for(var s=0;s<r.length;s++){var l=r[s],c=null;if(null!==W)c=W.getViewport(l);else{var u=w.getViewSubImage(R,l);c=u.viewport,0===s&&(n.setRenderTargetTextures(F,u.colorTexture,R.ignoreDepthValues?void 0:u.depthStencilTexture),n.setRenderTarget(F))}var d=G[s];void 0===d&&((d=new a.PerspectiveCamera).layers.enable(s),d.viewport=new o.Vector4,G[s]=d),d.matrix.fromArray(l.transform.matrix),d.projectionMatrix.fromArray(l.projectionMatrix),d.viewport.set(c.x,c.y,c.width,c.height),0===s&&V.matrix.copy(d.matrix),!0===i&&V.cameras.push(d)}}for(var p=m.inputSources,v=0;v<S.length;v++){var f=p[v],g=C.get(f);void 0!==g&&g.update(f,t,y||h)}I&&I(e,t),L=null})),v.setAnimationLoop=function(e){I=e},v.dispose=function(){},v}return t.inheritsLoose(n,e),n}(n.EventDispatcher);e.WebXRManager=p,Object.defineProperty(e,"__esModule",{value:!0})}));

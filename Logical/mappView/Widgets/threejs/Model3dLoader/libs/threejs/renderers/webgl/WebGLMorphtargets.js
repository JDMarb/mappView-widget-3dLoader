/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../../constants","../../textures/DataArrayTexture","../../math/Vector4","../../math/Vector2"],(function(t,e,r,o,a){"use strict";function i(t,e){return t[0]-e[0]}function n(t,e){return Math.abs(e[1])-Math.abs(t[1])}function s(t,e){var r=1,o=e.isInterleavedBufferAttribute?e.data.array:e.array;o instanceof Int8Array?r=127:o instanceof Int16Array?r=32767:o instanceof Int32Array?r=2147483647:console.error("THREE.WebGLMorphtargets: Unsupported morph attribute data type: ",o),t.divideScalar(r)}t.WebGLMorphtargets=function(t,u,m){for(var p={},f=new Float32Array(8),l=new WeakMap,h=new o.Vector4,v=[],d=0;d<8;d++)v[d]=[d,0];return{update:function(o,d,A,b){var c=o.morphTargetInfluences;if(!0===u.isWebGL2){var g=d.morphAttributes.position||d.morphAttributes.normal||d.morphAttributes.color,T=void 0!==g?g.length:0,x=l.get(d);if(void 0===x||x.count!==T){void 0!==x&&x.texture.dispose();var y=void 0!==d.morphAttributes.position,z=void 0!==d.morphAttributes.normal,I=void 0!==d.morphAttributes.color,E=d.morphAttributes.position||[],V=d.morphAttributes.normal||[],M=d.morphAttributes.color||[],N=0;!0===y&&(N=1),!0===z&&(N=2),!0===I&&(N=3);var S=d.attributes.position.count*N,U=1;S>u.maxTextureSize&&(U=Math.ceil(S/u.maxTextureSize),S=u.maxTextureSize);var w=new Float32Array(S*U*4*T),B=new r.DataArrayTexture(w,S,U,T);B.type=e.FloatType,B.needsUpdate=!0;for(var _=4*N,F=0;F<T;F++)for(var G=E[F],L=V[F],R=M[F],W=S*U*4*F,D=0;D<G.count;D++){var X=D*_;!0===y&&(h.fromBufferAttribute(G,D),!0===G.normalized&&s(h,G),w[W+X+0]=h.x,w[W+X+1]=h.y,w[W+X+2]=h.z,w[W+X+3]=0),!0===z&&(h.fromBufferAttribute(L,D),!0===L.normalized&&s(h,L),w[W+X+4]=h.x,w[W+X+5]=h.y,w[W+X+6]=h.z,w[W+X+7]=0),!0===I&&(h.fromBufferAttribute(R,D),!0===R.normalized&&s(h,R),w[W+X+8]=h.x,w[W+X+9]=h.y,w[W+X+10]=h.z,w[W+X+11]=4===R.itemSize?h.w:1)}x={count:T,texture:B,size:new a.Vector2(S,U)},l.set(d,x),d.addEventListener("dispose",(function t(){B.dispose(),l.delete(d),d.removeEventListener("dispose",t)}))}for(var j=0,k=0;k<c.length;k++)j+=c[k];var H=d.morphTargetsRelative?1:1-j;b.getUniforms().setValue(t,"morphTargetBaseInfluence",H),b.getUniforms().setValue(t,"morphTargetInfluences",c),b.getUniforms().setValue(t,"morphTargetsTexture",x.texture,m),b.getUniforms().setValue(t,"morphTargetsTextureSize",x.size)}else{var O=void 0===c?0:c.length,P=p[d.id];if(void 0===P||P.length!==O){P=[];for(var q=0;q<O;q++)P[q]=[q,0];p[d.id]=P}for(var C=0;C<O;C++){var J=P[C];J[0]=C,J[1]=c[C]}P.sort(n);for(var K=0;K<8;K++)K<O&&P[K][1]?(v[K][0]=P[K][0],v[K][1]=P[K][1]):(v[K][0]=Number.MAX_SAFE_INTEGER,v[K][1]=0);v.sort(i);for(var Q=d.morphAttributes.position,Y=d.morphAttributes.normal,Z=0,$=0;$<8;$++){var tt=v[$],et=tt[0],rt=tt[1];et!==Number.MAX_SAFE_INTEGER&&rt?(Q&&d.getAttribute("morphTarget"+$)!==Q[et]&&d.setAttribute("morphTarget"+$,Q[et]),Y&&d.getAttribute("morphNormal"+$)!==Y[et]&&d.setAttribute("morphNormal"+$,Y[et]),f[$]=rt,Z+=rt):(Q&&!0===d.hasAttribute("morphTarget"+$)&&d.deleteAttribute("morphTarget"+$),Y&&!0===d.hasAttribute("morphNormal"+$)&&d.deleteAttribute("morphNormal"+$),f[$]=0)}var ot=d.morphTargetsRelative?1:1-Z;b.getUniforms().setValue(t,"morphTargetBaseInfluence",ot),b.getUniforms().setValue(t,"morphTargetInfluences",f)}}}},Object.defineProperty(t,"__esModule",{value:!0})}));

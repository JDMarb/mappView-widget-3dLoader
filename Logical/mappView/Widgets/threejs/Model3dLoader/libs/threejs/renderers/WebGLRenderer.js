/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","../constants","../math/MathUtils","../math/Frustum","../math/Matrix4","../math/Vector2","../math/Vector3","../math/Vector4","./webgl/WebGLAnimation","./webgl/WebGLAttributes","./webgl/WebGLBackground","./webgl/WebGLBindingStates","./webgl/WebGLBufferRenderer","./webgl/WebGLCapabilities","./webgl/WebGLClipping","./webgl/WebGLCubeMaps","./webgl/WebGLCubeUVMaps","./webgl/WebGLExtensions","./webgl/WebGLGeometries","./webgl/WebGLIndexedBufferRenderer","./webgl/WebGLInfo","./webgl/WebGLMorphtargets","./webgl/WebGLObjects","./webgl/WebGLPrograms","./webgl/WebGLProperties","./webgl/WebGLRenderLists","./webgl/WebGLRenderStates","./WebGLRenderTarget","./webgl/WebGLShadowMap","./webgl/WebGLState","./webgl/WebGLTextures","./webgl/WebGLUniforms","./webgl/WebGLUtils","./webxr/WebXRManager","./webgl/WebGLMaterials","../utils"],(function(e,t,r,i,a,n,s,o,l,u,d,p,h,g,c,f,m,b,v,x,w,M,L,T,S,W,y,G,R,E,C,_,P,A,D,V){"use strict";function B(){var e=V.createElementNS("canvas");return e.style.display="block",e}e.WebGLRenderer=function(e){void 0===e&&(e={}),this.isWebGLRenderer=!0;var V,U=void 0!==e.canvas?e.canvas:B(),F=void 0!==e.context?e.context:null,I=void 0===e.depth||e.depth,O=void 0===e.stencil||e.stencil,k=void 0!==e.antialias&&e.antialias,H=void 0===e.premultipliedAlpha||e.premultipliedAlpha,z=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,j=void 0!==e.powerPreference?e.powerPreference:"default",N=void 0!==e.failIfMajorPerformanceCaveat&&e.failIfMajorPerformanceCaveat;V=null!==F?F.getContextAttributes().alpha:void 0!==e.alpha&&e.alpha;var q=null,X=null,Y=[],K=[];this.domElement=U,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.outputEncoding=t.LinearEncoding,this.physicallyCorrectLights=!1,this.toneMapping=t.NoToneMapping,this.toneMappingExposure=1,Object.defineProperties(this,{gammaFactor:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaFactor has been removed."),2},set:function(){console.warn("THREE.WebGLRenderer: .gammaFactor has been removed.")}}});var J=this,Q=!1,Z=0,$=0,ee=null,te=-1,re=null,ie=new o.Vector4,ae=new o.Vector4,ne=null,se=U.width,oe=U.height,le=1,ue=null,de=null,pe=new o.Vector4(0,0,se,oe),he=new o.Vector4(0,0,se,oe),ge=!1,ce=new i.Frustum,fe=!1,me=!1,be=null,ve=new a.Matrix4,xe=new n.Vector2,we=new s.Vector3,Me={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function Le(){return null===ee?le:1}var Te,Se,We,ye,Ge,Re,Ee,Ce,_e,Pe,Ae,De,Ve,Be,Ue,Fe,Ie,Oe,ke,He,ze,je,Ne,qe=F;function Xe(e,t){for(var r=0;r<e.length;r++){var i=e[r],a=U.getContext(i,t);if(null!==a)return a}return null}try{var Ye={alpha:!0,depth:I,stencil:O,antialias:k,premultipliedAlpha:H,preserveDrawingBuffer:z,powerPreference:j,failIfMajorPerformanceCaveat:N};if("setAttribute"in U&&U.setAttribute("data-engine","three.js r"+t.REVISION),U.addEventListener("webglcontextlost",Ze,!1),U.addEventListener("webglcontextrestored",$e,!1),U.addEventListener("webglcontextcreationerror",et,!1),null===qe){var Ke=["webgl2","webgl","experimental-webgl"];if(!0===J.isWebGL1Renderer&&Ke.shift(),null===(qe=Xe(Ke,Ye)))throw Xe(Ke)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}void 0===qe.getShaderPrecisionFormat&&(qe.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(e){throw console.error("THREE.WebGLRenderer: "+e.message),e}function Je(){Te=new b.WebGLExtensions(qe),Se=new g.WebGLCapabilities(qe,Te,e),Te.init(Se),je=new P.WebGLUtils(qe,Te,Se),We=new E.WebGLState(qe,Te,Se),ye=new w.WebGLInfo,Ge=new S.WebGLProperties,Re=new C.WebGLTextures(qe,Te,We,Ge,Se,je,ye),Ee=new f.WebGLCubeMaps(J),Ce=new m.WebGLCubeUVMaps(J),_e=new u.WebGLAttributes(qe,Se),Ne=new p.WebGLBindingStates(qe,Te,_e,Se),Pe=new v.WebGLGeometries(qe,_e,ye,Ne),Ae=new L.WebGLObjects(qe,Pe,_e,ye),ke=new M.WebGLMorphtargets(qe,Se,Re),Fe=new c.WebGLClipping(Ge),De=new T.WebGLPrograms(J,Ee,Ce,Te,Se,Ne,Fe),Ve=new D.WebGLMaterials(J,Ge),Be=new W.WebGLRenderLists,Ue=new y.WebGLRenderStates(Te,Se),Oe=new d.WebGLBackground(J,Ee,We,Ae,V,H),Ie=new R.WebGLShadowMap(J,Ae,Se),He=new h.WebGLBufferRenderer(qe,Te,ye,Se),ze=new x.WebGLIndexedBufferRenderer(qe,Te,ye,Se),ye.programs=De.programs,J.capabilities=Se,J.extensions=Te,J.properties=Ge,J.renderLists=Be,J.shadowMap=Ie,J.state=We,J.info=ye}Je();var Qe=new A.WebXRManager(J,qe);function Ze(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),Q=!0}function $e(){console.log("THREE.WebGLRenderer: Context Restored."),Q=!1;var e=ye.autoReset,t=Ie.enabled,r=Ie.autoUpdate,i=Ie.needsUpdate,a=Ie.type;Je(),ye.autoReset=e,Ie.enabled=t,Ie.autoUpdate=r,Ie.needsUpdate=i,Ie.type=a}function et(e){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function tt(e){var t=e.target;t.removeEventListener("dispose",tt),function(e){(function(e){var t=Ge.get(e).programs;void 0!==t&&(t.forEach((function(e){De.releaseProgram(e)})),e.isShaderMaterial&&De.releaseShaderCache(e))})(e),Ge.remove(e)}(t)}this.xr=Qe,this.getContext=function(){return qe},this.getContextAttributes=function(){return qe.getContextAttributes()},this.forceContextLoss=function(){var e=Te.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){var e=Te.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return le},this.setPixelRatio=function(e){void 0!==e&&(le=e,this.setSize(se,oe,!1))},this.getSize=function(e){return e.set(se,oe)},this.setSize=function(e,t,r){Qe.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(se=e,oe=t,U.width=Math.floor(e*le),U.height=Math.floor(t*le),!1!==r&&(U.style.width=e+"px",U.style.height=t+"px"),this.setViewport(0,0,e,t))},this.getDrawingBufferSize=function(e){return e.set(se*le,oe*le).floor()},this.setDrawingBufferSize=function(e,t,r){se=e,oe=t,le=r,U.width=Math.floor(e*r),U.height=Math.floor(t*r),this.setViewport(0,0,e,t)},this.getCurrentViewport=function(e){return e.copy(ie)},this.getViewport=function(e){return e.copy(pe)},this.setViewport=function(e,t,r,i){e.isVector4?pe.set(e.x,e.y,e.z,e.w):pe.set(e,t,r,i),We.viewport(ie.copy(pe).multiplyScalar(le).floor())},this.getScissor=function(e){return e.copy(he)},this.setScissor=function(e,t,r,i){e.isVector4?he.set(e.x,e.y,e.z,e.w):he.set(e,t,r,i),We.scissor(ae.copy(he).multiplyScalar(le).floor())},this.getScissorTest=function(){return ge},this.setScissorTest=function(e){We.setScissorTest(ge=e)},this.setOpaqueSort=function(e){ue=e},this.setTransparentSort=function(e){de=e},this.getClearColor=function(e){return e.copy(Oe.getClearColor())},this.setClearColor=function(){Oe.setClearColor.apply(Oe,arguments)},this.getClearAlpha=function(){return Oe.getClearAlpha()},this.setClearAlpha=function(){Oe.setClearAlpha.apply(Oe,arguments)},this.clear=function(e,t,r){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===r&&(r=!0);var i=0;e&&(i|=16384),t&&(i|=256),r&&(i|=1024),qe.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){U.removeEventListener("webglcontextlost",Ze,!1),U.removeEventListener("webglcontextrestored",$e,!1),U.removeEventListener("webglcontextcreationerror",et,!1),Be.dispose(),Ue.dispose(),Ge.dispose(),Ee.dispose(),Ce.dispose(),Ae.dispose(),Ne.dispose(),De.dispose(),Qe.dispose(),Qe.removeEventListener("sessionstart",it),Qe.removeEventListener("sessionend",at),be&&(be.dispose(),be=null),nt.stop()},this.renderBufferDirect=function(e,r,i,a,n,s){null===r&&(r=Me);var o=n.isMesh&&n.matrixWorld.determinant()<0,l=function(e,r,i,a,n){!0!==r.isScene&&(r=Me);Re.resetTextureUnits();var s=r.fog,o=a.isMeshStandardMaterial?r.environment:null,l=null===ee?J.outputEncoding:!0===ee.isXRRenderTarget?ee.texture.encoding:t.LinearEncoding,u=(a.isMeshStandardMaterial?Ce:Ee).get(a.envMap||o),d=!0===a.vertexColors&&!!i.attributes.color&&4===i.attributes.color.itemSize,p=!!a.normalMap&&!!i.attributes.tangent,h=!!i.morphAttributes.position,g=!!i.morphAttributes.normal,c=!!i.morphAttributes.color,f=a.toneMapped?J.toneMapping:t.NoToneMapping,m=i.morphAttributes.position||i.morphAttributes.normal||i.morphAttributes.color,b=void 0!==m?m.length:0,v=Ge.get(a),x=X.state.lights;if(!0===fe&&(!0===me||e!==re)){var w=e===re&&a.id===te;Fe.setState(a,e,w)}var M=!1;a.version===v.__version?v.needsLights&&v.lightsStateVersion!==x.state.version||v.outputEncoding!==l||n.isInstancedMesh&&!1===v.instancing?M=!0:n.isInstancedMesh||!0!==v.instancing?n.isSkinnedMesh&&!1===v.skinning?M=!0:n.isSkinnedMesh||!0!==v.skinning?v.envMap!==u||!0===a.fog&&v.fog!==s?M=!0:void 0===v.numClippingPlanes||v.numClippingPlanes===Fe.numPlanes&&v.numIntersection===Fe.numIntersection?(v.vertexAlphas!==d||v.vertexTangents!==p||v.morphTargets!==h||v.morphNormals!==g||v.morphColors!==c||v.toneMapping!==f||!0===Se.isWebGL2&&v.morphTargetsCount!==b)&&(M=!0):M=!0:M=!0:M=!0:(M=!0,v.__version=a.version);var L=v.currentProgram;!0===M&&(L=dt(a,r,n));var T=!1,S=!1,W=!1,y=L.getUniforms(),G=v.uniforms;We.useProgram(L.program)&&(T=!0,S=!0,W=!0);a.id!==te&&(te=a.id,S=!0);if(T||re!==e){if(y.setValue(qe,"projectionMatrix",e.projectionMatrix),Se.logarithmicDepthBuffer&&y.setValue(qe,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),re!==e&&(re=e,S=!0,W=!0),a.isShaderMaterial||a.isMeshPhongMaterial||a.isMeshToonMaterial||a.isMeshStandardMaterial||a.envMap){var R=y.map.cameraPosition;void 0!==R&&R.setValue(qe,we.setFromMatrixPosition(e.matrixWorld))}(a.isMeshPhongMaterial||a.isMeshToonMaterial||a.isMeshLambertMaterial||a.isMeshBasicMaterial||a.isMeshStandardMaterial||a.isShaderMaterial)&&y.setValue(qe,"isOrthographic",!0===e.isOrthographicCamera),(a.isMeshPhongMaterial||a.isMeshToonMaterial||a.isMeshLambertMaterial||a.isMeshBasicMaterial||a.isMeshStandardMaterial||a.isShaderMaterial||a.isShadowMaterial||n.isSkinnedMesh)&&y.setValue(qe,"viewMatrix",e.matrixWorldInverse)}if(n.isSkinnedMesh){y.setOptional(qe,n,"bindMatrix"),y.setOptional(qe,n,"bindMatrixInverse");var E=n.skeleton;E&&(Se.floatVertexTextures?(null===E.boneTexture&&E.computeBoneTexture(),y.setValue(qe,"boneTexture",E.boneTexture,Re),y.setValue(qe,"boneTextureSize",E.boneTextureSize)):console.warn("THREE.WebGLRenderer: SkinnedMesh can only be used with WebGL 2. With WebGL 1 OES_texture_float and vertex textures support is required."))}var C=i.morphAttributes;(void 0!==C.position||void 0!==C.normal||void 0!==C.color&&!0===Se.isWebGL2)&&ke.update(n,i,a,L);(S||v.receiveShadow!==n.receiveShadow)&&(v.receiveShadow=n.receiveShadow,y.setValue(qe,"receiveShadow",n.receiveShadow));S&&(y.setValue(qe,"toneMappingExposure",J.toneMappingExposure),v.needsLights&&(A=W,(P=G).ambientLightColor.needsUpdate=A,P.lightProbe.needsUpdate=A,P.directionalLights.needsUpdate=A,P.directionalLightShadows.needsUpdate=A,P.pointLights.needsUpdate=A,P.pointLightShadows.needsUpdate=A,P.spotLights.needsUpdate=A,P.spotLightShadows.needsUpdate=A,P.rectAreaLights.needsUpdate=A,P.hemisphereLights.needsUpdate=A),s&&!0===a.fog&&Ve.refreshFogUniforms(G,s),Ve.refreshMaterialUniforms(G,a,le,oe,be),_.WebGLUniforms.upload(qe,v.uniformsList,G,Re));var P,A;a.isShaderMaterial&&!0===a.uniformsNeedUpdate&&(_.WebGLUniforms.upload(qe,v.uniformsList,G,Re),a.uniformsNeedUpdate=!1);a.isSpriteMaterial&&y.setValue(qe,"center",n.center);return y.setValue(qe,"modelViewMatrix",n.modelViewMatrix),y.setValue(qe,"normalMatrix",n.normalMatrix),y.setValue(qe,"modelMatrix",n.matrixWorld),L}(e,r,i,a,n);We.setMaterial(a,o);var u=i.index,d=i.attributes.position;if(null===u){if(void 0===d||0===d.count)return}else if(0===u.count)return;var p,h=1;!0===a.wireframe&&(u=Pe.getWireframeAttribute(i),h=2),Ne.setup(n,a,l,i,u);var g=He;null!==u&&(p=_e.get(u),(g=ze).setIndex(p));var c=null!==u?u.count:d.count,f=i.drawRange.start*h,m=i.drawRange.count*h,b=null!==s?s.start*h:0,v=null!==s?s.count*h:1/0,x=Math.max(f,b),w=Math.min(c,f+m,b+v)-1,M=Math.max(0,w-x+1);if(0!==M){if(n.isMesh)!0===a.wireframe?(We.setLineWidth(a.wireframeLinewidth*Le()),g.setMode(1)):g.setMode(4);else if(n.isLine){var L=a.linewidth;void 0===L&&(L=1),We.setLineWidth(L*Le()),n.isLineSegments?g.setMode(1):n.isLineLoop?g.setMode(2):g.setMode(3)}else n.isPoints?g.setMode(0):n.isSprite&&g.setMode(4);if(n.isInstancedMesh)g.renderInstances(x,M,n.count);else if(i.isInstancedBufferGeometry){var T=Math.min(i.instanceCount,i._maxInstanceCount);g.renderInstances(x,M,T)}else g.render(x,M)}},this.compile=function(e,t){(X=Ue.get(e)).init(),K.push(X),e.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(X.pushLight(e),e.castShadow&&X.pushShadow(e))})),X.setupLights(J.physicallyCorrectLights),e.traverse((function(t){var r=t.material;if(r)if(Array.isArray(r))for(var i=0;i<r.length;i++){dt(r[i],e,t)}else dt(r,e,t)})),K.pop(),X=null};var rt=null;function it(){nt.stop()}function at(){nt.start()}var nt=new l.WebGLAnimation;function st(e,t,r,i){if(!1!==e.visible){if(e.layers.test(t.layers))if(e.isGroup)r=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)X.pushLight(e),e.castShadow&&X.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||ce.intersectsSprite(e)){i&&we.setFromMatrixPosition(e.matrixWorld).applyMatrix4(ve);var a=Ae.update(e),n=e.material;n.visible&&q.push(e,a,n,r,we.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.frame!==ye.render.frame&&(e.skeleton.update(),e.skeleton.frame=ye.render.frame),!e.frustumCulled||ce.intersectsObject(e))){i&&we.setFromMatrixPosition(e.matrixWorld).applyMatrix4(ve);var s=Ae.update(e),o=e.material;if(Array.isArray(o))for(var l=s.groups,u=0,d=l.length;u<d;u++){var p=l[u],h=o[p.materialIndex];h&&h.visible&&q.push(e,s,h,r,we.z,p)}else o.visible&&q.push(e,s,o,r,we.z,null)}for(var g=e.children,c=0,f=g.length;c<f;c++)st(g[c],t,r,i)}}function ot(e,i,a,n){var s=e.opaque,o=e.transmissive,l=e.transparent;X.setupLightsView(a),o.length>0&&function(e,i,a){var n=Se.isWebGL2;null===be&&(be=new G.WebGLRenderTarget(1,1,{generateMipmaps:!0,type:Te.has("EXT_color_buffer_half_float")?t.HalfFloatType:t.UnsignedByteType,minFilter:t.LinearMipmapLinearFilter,samples:n&&!0===k?4:0}));J.getDrawingBufferSize(xe),n?be.setSize(xe.x,xe.y):be.setSize(r.floorPowerOfTwo(xe.x),r.floorPowerOfTwo(xe.y));var s=J.getRenderTarget();J.setRenderTarget(be),J.clear();var o=J.toneMapping;J.toneMapping=t.NoToneMapping,lt(e,i,a),J.toneMapping=o,Re.updateMultisampleRenderTarget(be),Re.updateRenderTargetMipmap(be),J.setRenderTarget(s)}(s,i,a),n&&We.viewport(ie.copy(n)),s.length>0&&lt(s,i,a),o.length>0&&lt(o,i,a),l.length>0&&lt(l,i,a),We.buffers.depth.setTest(!0),We.buffers.depth.setMask(!0),We.buffers.color.setMask(!0),We.setPolygonOffset(!1)}function lt(e,t,r){for(var i=!0===t.isScene?t.overrideMaterial:null,a=0,n=e.length;a<n;a++){var s=e[a],o=s.object,l=s.geometry,u=null===i?s.material:i,d=s.group;o.layers.test(r.layers)&&ut(o,t,r,l,u,d)}}function ut(e,r,i,a,n,s){e.onBeforeRender(J,r,i,a,n,s),e.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),n.onBeforeRender(J,r,i,a,e,s),!0===n.transparent&&n.side===t.DoubleSide?(n.side=t.BackSide,n.needsUpdate=!0,J.renderBufferDirect(i,r,a,n,e,s),n.side=t.FrontSide,n.needsUpdate=!0,J.renderBufferDirect(i,r,a,n,e,s),n.side=t.DoubleSide):J.renderBufferDirect(i,r,a,n,e,s),e.onAfterRender(J,r,i,a,n,s)}function dt(e,t,r){!0!==t.isScene&&(t=Me);var i=Ge.get(e),a=X.state.lights,n=X.state.shadowsArray,s=a.state.version,o=De.getParameters(e,a.state,n,t,r),l=De.getProgramCacheKey(o),u=i.programs;i.environment=e.isMeshStandardMaterial?t.environment:null,i.fog=t.fog,i.envMap=(e.isMeshStandardMaterial?Ce:Ee).get(e.envMap||i.environment),void 0===u&&(e.addEventListener("dispose",tt),u=new Map,i.programs=u);var d=u.get(l);if(void 0!==d){if(i.currentProgram===d&&i.lightsStateVersion===s)return pt(e,o),d}else o.uniforms=De.getUniforms(e),e.onBuild(r,o,J),e.onBeforeCompile(o,J),d=De.acquireProgram(o,l),u.set(l,d),i.uniforms=o.uniforms;var p=i.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(p.clippingPlanes=Fe.uniform),pt(e,o),i.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),i.lightsStateVersion=s,i.needsLights&&(p.ambientLightColor.value=a.state.ambient,p.lightProbe.value=a.state.probe,p.directionalLights.value=a.state.directional,p.directionalLightShadows.value=a.state.directionalShadow,p.spotLights.value=a.state.spot,p.spotLightShadows.value=a.state.spotShadow,p.rectAreaLights.value=a.state.rectArea,p.ltc_1.value=a.state.rectAreaLTC1,p.ltc_2.value=a.state.rectAreaLTC2,p.pointLights.value=a.state.point,p.pointLightShadows.value=a.state.pointShadow,p.hemisphereLights.value=a.state.hemi,p.directionalShadowMap.value=a.state.directionalShadowMap,p.directionalShadowMatrix.value=a.state.directionalShadowMatrix,p.spotShadowMap.value=a.state.spotShadowMap,p.spotShadowMatrix.value=a.state.spotShadowMatrix,p.pointShadowMap.value=a.state.pointShadowMap,p.pointShadowMatrix.value=a.state.pointShadowMatrix);var h=d.getUniforms(),g=_.WebGLUniforms.seqWithValue(h.seq,p);return i.currentProgram=d,i.uniformsList=g,d}function pt(e,t){var r=Ge.get(e);r.outputEncoding=t.outputEncoding,r.instancing=t.instancing,r.skinning=t.skinning,r.morphTargets=t.morphTargets,r.morphNormals=t.morphNormals,r.morphColors=t.morphColors,r.morphTargetsCount=t.morphTargetsCount,r.numClippingPlanes=t.numClippingPlanes,r.numIntersection=t.numClipIntersection,r.vertexAlphas=t.vertexAlphas,r.vertexTangents=t.vertexTangents,r.toneMapping=t.toneMapping}nt.setAnimationLoop((function(e){rt&&rt(e)})),"undefined"!=typeof self&&nt.setContext(self),this.setAnimationLoop=function(e){rt=e,Qe.setAnimationLoop(e),null===e?nt.stop():nt.start()},Qe.addEventListener("sessionstart",it),Qe.addEventListener("sessionend",at),this.render=function(e,t){if(void 0===t||!0===t.isCamera){if(!0!==Q){!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),!0===Qe.enabled&&!0===Qe.isPresenting&&(!0===Qe.cameraAutoUpdate&&Qe.updateCamera(t),t=Qe.getCamera()),!0===e.isScene&&e.onBeforeRender(J,e,t,ee),(X=Ue.get(e,K.length)).init(),K.push(X),ve.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),ce.setFromProjectionMatrix(ve),me=this.localClippingEnabled,fe=Fe.init(this.clippingPlanes,me,t),(q=Be.get(e,Y.length)).init(),Y.push(q),st(e,t,0,J.sortObjects),q.finish(),!0===J.sortObjects&&q.sort(ue,de),!0===fe&&Fe.beginShadows();var r=X.state.shadowsArray;if(Ie.render(r,e,t),!0===fe&&Fe.endShadows(),!0===this.info.autoReset&&this.info.reset(),Oe.render(q,e),X.setupLights(J.physicallyCorrectLights),t.isArrayCamera)for(var i=t.cameras,a=0,n=i.length;a<n;a++){var s=i[a];ot(q,e,s,s.viewport)}else ot(q,e,t);null!==ee&&(Re.updateMultisampleRenderTarget(ee),Re.updateRenderTargetMipmap(ee)),!0===e.isScene&&e.onAfterRender(J,e,t),Ne.resetDefaultState(),te=-1,re=null,K.pop(),X=K.length>0?K[K.length-1]:null,Y.pop(),q=Y.length>0?Y[Y.length-1]:null}}else console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.getActiveCubeFace=function(){return Z},this.getActiveMipmapLevel=function(){return $},this.getRenderTarget=function(){return ee},this.setRenderTargetTextures=function(e,t,r){Ge.get(e.texture).__webglTexture=t,Ge.get(e.depthTexture).__webglTexture=r;var i=Ge.get(e);i.__hasExternalTextures=!0,i.__hasExternalTextures&&(i.__autoAllocateDepthBuffer=void 0===r,i.__autoAllocateDepthBuffer||!0===Te.has("WEBGL_multisampled_render_to_texture")&&(console.warn("THREE.WebGLRenderer: Render-to-texture extension was disabled because an external texture was provided"),i.__useRenderToTexture=!1))},this.setRenderTargetFramebuffer=function(e,t){var r=Ge.get(e);r.__webglFramebuffer=t,r.__useDefaultFramebuffer=void 0===t},this.setRenderTarget=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=0),ee=e,Z=t,$=r;var i=!0;if(e){var a=Ge.get(e);void 0!==a.__useDefaultFramebuffer?(We.bindFramebuffer(36160,null),i=!1):void 0===a.__webglFramebuffer?Re.setupRenderTarget(e):a.__hasExternalTextures&&Re.rebindTextures(e,Ge.get(e.texture).__webglTexture,Ge.get(e.depthTexture).__webglTexture)}var n=null,s=!1,o=!1;if(e){var l=e.texture;(l.isData3DTexture||l.isDataArrayTexture)&&(o=!0);var u=Ge.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(n=u[t],s=!0):n=Se.isWebGL2&&e.samples>0&&!1===Re.useMultisampledRTT(e)?Ge.get(e).__webglMultisampledFramebuffer:u,ie.copy(e.viewport),ae.copy(e.scissor),ne=e.scissorTest}else ie.copy(pe).multiplyScalar(le).floor(),ae.copy(he).multiplyScalar(le).floor(),ne=ge;if(We.bindFramebuffer(36160,n)&&Se.drawBuffers&&i&&We.drawBuffers(e,n),We.viewport(ie),We.scissor(ae),We.setScissorTest(ne),s){var d=Ge.get(e.texture);qe.framebufferTexture2D(36160,36064,34069+t,d.__webglTexture,r)}else if(o){var p=Ge.get(e.texture),h=t||0;qe.framebufferTextureLayer(36160,36064,p.__webglTexture,r||0,h)}te=-1},this.readRenderTargetPixels=function(e,r,i,a,n,s,o){if(e&&e.isWebGLRenderTarget){var l=Ge.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==o&&(l=l[o]),l){We.bindFramebuffer(36160,l);try{var u=e.texture,d=u.format,p=u.type;if(d!==t.RGBAFormat&&je.convert(d)!==qe.getParameter(35739))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");var h=p===t.HalfFloatType&&(Te.has("EXT_color_buffer_half_float")||Se.isWebGL2&&Te.has("EXT_color_buffer_float"));if(!(p===t.UnsignedByteType||je.convert(p)===qe.getParameter(35738)||p===t.FloatType&&(Se.isWebGL2||Te.has("OES_texture_float")||Te.has("WEBGL_color_buffer_float"))||h))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");r>=0&&r<=e.width-a&&i>=0&&i<=e.height-n&&qe.readPixels(r,i,a,n,je.convert(d),je.convert(p),s)}finally{var g=null!==ee?Ge.get(ee).__webglFramebuffer:null;We.bindFramebuffer(36160,g)}}}else console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.")},this.copyFramebufferToTexture=function(e,t,r){void 0===r&&(r=0);var i=Math.pow(2,-r),a=Math.floor(t.image.width*i),n=Math.floor(t.image.height*i);Re.setTexture2D(t,0),qe.copyTexSubImage2D(3553,r,0,0,e.x,e.y,a,n),We.unbindTexture()},this.copyTextureToTexture=function(e,t,r,i){void 0===i&&(i=0);var a=t.image.width,n=t.image.height,s=je.convert(r.format),o=je.convert(r.type);Re.setTexture2D(r,0),qe.pixelStorei(37440,r.flipY),qe.pixelStorei(37441,r.premultiplyAlpha),qe.pixelStorei(3317,r.unpackAlignment),t.isDataTexture?qe.texSubImage2D(3553,i,e.x,e.y,a,n,s,o,t.image.data):t.isCompressedTexture?qe.compressedTexSubImage2D(3553,i,e.x,e.y,t.mipmaps[0].width,t.mipmaps[0].height,s,t.mipmaps[0].data):qe.texSubImage2D(3553,i,e.x,e.y,s,o,t.image),0===i&&r.generateMipmaps&&qe.generateMipmap(3553),We.unbindTexture()},this.copyTextureToTexture3D=function(e,t,r,i,a){if(void 0===a&&(a=0),J.isWebGL1Renderer)console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");else{var n,s=e.max.x-e.min.x+1,o=e.max.y-e.min.y+1,l=e.max.z-e.min.z+1,u=je.convert(i.format),d=je.convert(i.type);if(i.isData3DTexture)Re.setTexture3D(i,0),n=32879;else{if(!i.isDataArrayTexture)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");Re.setTexture2DArray(i,0),n=35866}qe.pixelStorei(37440,i.flipY),qe.pixelStorei(37441,i.premultiplyAlpha),qe.pixelStorei(3317,i.unpackAlignment);var p=qe.getParameter(3314),h=qe.getParameter(32878),g=qe.getParameter(3316),c=qe.getParameter(3315),f=qe.getParameter(32877),m=r.isCompressedTexture?r.mipmaps[0]:r.image;qe.pixelStorei(3314,m.width),qe.pixelStorei(32878,m.height),qe.pixelStorei(3316,e.min.x),qe.pixelStorei(3315,e.min.y),qe.pixelStorei(32877,e.min.z),r.isDataTexture||r.isData3DTexture?qe.texSubImage3D(n,a,t.x,t.y,t.z,s,o,l,u,d,m.data):r.isCompressedTexture?(console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: untested support for compressed srcTexture."),qe.compressedTexSubImage3D(n,a,t.x,t.y,t.z,s,o,l,u,m.data)):qe.texSubImage3D(n,a,t.x,t.y,t.z,s,o,l,u,d,m),qe.pixelStorei(3314,p),qe.pixelStorei(32878,h),qe.pixelStorei(3316,g),qe.pixelStorei(3315,c),qe.pixelStorei(32877,f),0===a&&i.generateMipmaps&&qe.generateMipmap(n),We.unbindTexture()}},this.initTexture=function(e){Re.setTexture2D(e,0),We.unbindTexture()},this.resetState=function(){Z=0,$=0,ee=null,We.reset(),Ne.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))},Object.defineProperty(e,"__esModule",{value:!0})}));

/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
define(["exports","./WebGLUniforms","./WebGLShader","../shaders/ShaderChunk","../../constants"],(function(e,n,r,i,t){"use strict";var a=0;function o(e,n,r){var i=e.getShaderParameter(n,35713),t=e.getShaderInfoLog(n).trim();if(i&&""===t)return"";var a=/ERROR: 0:(\d+)/.exec(t);if(a){var o=parseInt(a[1]);return r.toUpperCase()+"\n\n"+t+"\n\n"+function(e,n){for(var r=e.split("\n"),i=[],t=Math.max(n-6,0),a=Math.min(n+6,r.length),o=t;o<a;o++){var d=o+1;i.push((d===n?">":" ")+" "+d+": "+r[o])}return i.join("\n")}(e.getShaderSource(n),o)}return t}function d(e,n){var r=function(e){switch(e){case t.LinearEncoding:return["Linear","( value )"];case t.sRGBEncoding:return["sRGB","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",e),["Linear","( value )"]}}(n);return"vec4 "+e+"( vec4 value ) { return LinearTo"+r[0]+r[1]+"; }"}function E(e,n){var r;switch(n){case t.LinearToneMapping:r="Linear";break;case t.ReinhardToneMapping:r="Reinhard";break;case t.CineonToneMapping:r="OptimizedCineon";break;case t.ACESFilmicToneMapping:r="ACESFilmic";break;case t.CustomToneMapping:r="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",n),r="Linear"}return"vec3 "+e+"( vec3 color ) { return "+r+"ToneMapping( color ); }"}function s(e){return""!==e}function p(e,n){return e.replace(/NUM_DIR_LIGHTS/g,n.numDirLights).replace(/NUM_SPOT_LIGHTS/g,n.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,n.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,n.numPointLights).replace(/NUM_HEMI_LIGHTS/g,n.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,n.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,n.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,n.numPointLightShadows)}function f(e,n){return e.replace(/NUM_CLIPPING_PLANES/g,n.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,n.numClippingPlanes-n.numClipIntersection)}var S=/^[ \t]*#include +<([\w\d./]+)>/gm;function M(e){return e.replace(S,u)}function u(e,n){var r=i.ShaderChunk[n];if(void 0===r)throw new Error("Can not resolve #include <"+n+">");return M(r)}var _=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,c=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function l(e){return e.replace(c,A).replace(_,g)}function g(e,n,r,i){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),A(e,n,r,i)}function A(e,n,r,i){for(var t="",a=parseInt(n);a<parseInt(r);a++)t+=i.replace(/\[\s*i\s*\]/g,"[ "+a+" ]").replace(/UNROLLED_LOOP_INDEX/g,a);return t}function h(e){var n="precision "+e.precision+" float;\nprecision "+e.precision+" int;";return"highp"===e.precision?n+="\n#define HIGH_PRECISION":"mediump"===e.precision?n+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(n+="\n#define LOW_PRECISION"),n}e.WebGLProgram=function(e,S,u,_){var c,g,A=e.getContext(),P=u.defines,T=u.vertexShader,m=u.fragmentShader,U=function(e){var n="SHADOWMAP_TYPE_BASIC";return e.shadowMapType===t.PCFShadowMap?n="SHADOWMAP_TYPE_PCF":e.shadowMapType===t.PCFSoftShadowMap?n="SHADOWMAP_TYPE_PCF_SOFT":e.shadowMapType===t.VSMShadowMap&&(n="SHADOWMAP_TYPE_VSM"),n}(u),N=function(e){var n="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case t.CubeReflectionMapping:case t.CubeRefractionMapping:n="ENVMAP_TYPE_CUBE";break;case t.CubeUVReflectionMapping:n="ENVMAP_TYPE_CUBE_UV"}return n}(u),L=function(e){var n="ENVMAP_MODE_REFLECTION";e.envMap&&e.envMapMode===t.CubeRefractionMapping&&(n="ENVMAP_MODE_REFRACTION");return n}(u),C=function(e){var n="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case t.MultiplyOperation:n="ENVMAP_BLENDING_MULTIPLY";break;case t.MixOperation:n="ENVMAP_BLENDING_MIX";break;case t.AddOperation:n="ENVMAP_BLENDING_ADD"}return n}(u),O=function(e){var n=e.envMapCubeUVHeight;if(null===n)return null;var r=Math.log2(n)-2,i=1/n;return{texelWidth:1/(3*Math.max(Math.pow(2,r),112)),texelHeight:i,maxMip:r}}(u),I=u.isWebGL2?"":function(e){return[e.extensionDerivatives||e.envMapCubeUVHeight||e.bumpMap||e.tangentSpaceNormalMap||e.clearcoatNormalMap||e.flatShading||"physical"===e.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(e.extensionFragDepth||e.logarithmicDepthBuffer)&&e.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",e.extensionDrawBuffers&&e.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(e.extensionShaderTextureLOD||e.envMap||e.transmission)&&e.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(s).join("\n")}(u),R=function(e){var n=[];for(var r in e){var i=e[r];!1!==i&&n.push("#define "+r+" "+i)}return n.join("\n")}(P),v=A.createProgram(),b=u.glslVersion?"#version "+u.glslVersion+"\n":"";u.isRawShaderMaterial?((c=[R].filter(s).join("\n")).length>0&&(c+="\n"),(g=[I,R].filter(s).join("\n")).length>0&&(g+="\n")):(c=[h(u),"#define SHADER_NAME "+u.shaderName,R,u.instancing?"#define USE_INSTANCING":"",u.instancingColor?"#define USE_INSTANCING_COLOR":"",u.supportsVertexTextures?"#define VERTEX_TEXTURES":"",u.useFog&&u.fog?"#define USE_FOG":"",u.useFog&&u.fogExp2?"#define FOG_EXP2":"",u.map?"#define USE_MAP":"",u.envMap?"#define USE_ENVMAP":"",u.envMap?"#define "+L:"",u.lightMap?"#define USE_LIGHTMAP":"",u.aoMap?"#define USE_AOMAP":"",u.emissiveMap?"#define USE_EMISSIVEMAP":"",u.bumpMap?"#define USE_BUMPMAP":"",u.normalMap?"#define USE_NORMALMAP":"",u.normalMap&&u.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",u.normalMap&&u.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",u.clearcoatMap?"#define USE_CLEARCOATMAP":"",u.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",u.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",u.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",u.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",u.displacementMap&&u.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",u.specularMap?"#define USE_SPECULARMAP":"",u.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",u.specularColorMap?"#define USE_SPECULARCOLORMAP":"",u.roughnessMap?"#define USE_ROUGHNESSMAP":"",u.metalnessMap?"#define USE_METALNESSMAP":"",u.alphaMap?"#define USE_ALPHAMAP":"",u.transmission?"#define USE_TRANSMISSION":"",u.transmissionMap?"#define USE_TRANSMISSIONMAP":"",u.thicknessMap?"#define USE_THICKNESSMAP":"",u.sheenColorMap?"#define USE_SHEENCOLORMAP":"",u.sheenRoughnessMap?"#define USE_SHEENROUGHNESSMAP":"",u.vertexTangents?"#define USE_TANGENT":"",u.vertexColors?"#define USE_COLOR":"",u.vertexAlphas?"#define USE_COLOR_ALPHA":"",u.vertexUvs?"#define USE_UV":"",u.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",u.flatShading?"#define FLAT_SHADED":"",u.skinning?"#define USE_SKINNING":"",u.morphTargets?"#define USE_MORPHTARGETS":"",u.morphNormals&&!1===u.flatShading?"#define USE_MORPHNORMALS":"",u.morphColors&&u.isWebGL2?"#define USE_MORPHCOLORS":"",u.morphTargetsCount>0&&u.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",u.morphTargetsCount>0&&u.isWebGL2?"#define MORPHTARGETS_TEXTURE_STRIDE "+u.morphTextureStride:"",u.morphTargetsCount>0&&u.isWebGL2?"#define MORPHTARGETS_COUNT "+u.morphTargetsCount:"",u.doubleSided?"#define DOUBLE_SIDED":"",u.flipSided?"#define FLIP_SIDED":"",u.shadowMapEnabled?"#define USE_SHADOWMAP":"",u.shadowMapEnabled?"#define "+U:"",u.sizeAttenuation?"#define USE_SIZEATTENUATION":"",u.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",u.logarithmicDepthBuffer&&u.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(s).join("\n"),g=[I,h(u),"#define SHADER_NAME "+u.shaderName,R,u.useFog&&u.fog?"#define USE_FOG":"",u.useFog&&u.fogExp2?"#define FOG_EXP2":"",u.map?"#define USE_MAP":"",u.matcap?"#define USE_MATCAP":"",u.envMap?"#define USE_ENVMAP":"",u.envMap?"#define "+N:"",u.envMap?"#define "+L:"",u.envMap?"#define "+C:"",O?"#define CUBEUV_TEXEL_WIDTH "+O.texelWidth:"",O?"#define CUBEUV_TEXEL_HEIGHT "+O.texelHeight:"",O?"#define CUBEUV_MAX_MIP "+O.maxMip+".0":"",u.lightMap?"#define USE_LIGHTMAP":"",u.aoMap?"#define USE_AOMAP":"",u.emissiveMap?"#define USE_EMISSIVEMAP":"",u.bumpMap?"#define USE_BUMPMAP":"",u.normalMap?"#define USE_NORMALMAP":"",u.normalMap&&u.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",u.normalMap&&u.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",u.clearcoat?"#define USE_CLEARCOAT":"",u.clearcoatMap?"#define USE_CLEARCOATMAP":"",u.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",u.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",u.iridescence?"#define USE_IRIDESCENCE":"",u.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",u.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",u.specularMap?"#define USE_SPECULARMAP":"",u.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",u.specularColorMap?"#define USE_SPECULARCOLORMAP":"",u.roughnessMap?"#define USE_ROUGHNESSMAP":"",u.metalnessMap?"#define USE_METALNESSMAP":"",u.alphaMap?"#define USE_ALPHAMAP":"",u.alphaTest?"#define USE_ALPHATEST":"",u.sheen?"#define USE_SHEEN":"",u.sheenColorMap?"#define USE_SHEENCOLORMAP":"",u.sheenRoughnessMap?"#define USE_SHEENROUGHNESSMAP":"",u.transmission?"#define USE_TRANSMISSION":"",u.transmissionMap?"#define USE_TRANSMISSIONMAP":"",u.thicknessMap?"#define USE_THICKNESSMAP":"",u.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",u.vertexTangents?"#define USE_TANGENT":"",u.vertexColors||u.instancingColor?"#define USE_COLOR":"",u.vertexAlphas?"#define USE_COLOR_ALPHA":"",u.vertexUvs?"#define USE_UV":"",u.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",u.gradientMap?"#define USE_GRADIENTMAP":"",u.flatShading?"#define FLAT_SHADED":"",u.doubleSided?"#define DOUBLE_SIDED":"",u.flipSided?"#define FLIP_SIDED":"",u.shadowMapEnabled?"#define USE_SHADOWMAP":"",u.shadowMapEnabled?"#define "+U:"",u.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",u.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",u.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",u.logarithmicDepthBuffer&&u.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",u.toneMapping!==t.NoToneMapping?"#define TONE_MAPPING":"",u.toneMapping!==t.NoToneMapping?i.ShaderChunk.tonemapping_pars_fragment:"",u.toneMapping!==t.NoToneMapping?E("toneMapping",u.toneMapping):"",u.dithering?"#define DITHERING":"",u.opaque?"#define OPAQUE":"",i.ShaderChunk.encodings_pars_fragment,d("linearToOutputTexel",u.outputEncoding),u.useDepthPacking?"#define DEPTH_PACKING "+u.depthPacking:"","\n"].filter(s).join("\n")),T=f(T=p(T=M(T),u),u),m=f(m=p(m=M(m),u),u),T=l(T),m=l(m),u.isWebGL2&&!0!==u.isRawShaderMaterial&&(b="#version 300 es\n",c=["precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+c,g=["#define varying in",u.glslVersion===t.GLSL3?"":"layout(location = 0) out highp vec4 pc_fragColor;",u.glslVersion===t.GLSL3?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+g);var x,D,G=b+c+T,H=b+g+m,V=r.WebGLShader(A,35633,G),w=r.WebGLShader(A,35632,H);if(A.attachShader(v,V),A.attachShader(v,w),void 0!==u.index0AttributeName?A.bindAttribLocation(v,0,u.index0AttributeName):!0===u.morphTargets&&A.bindAttribLocation(v,0,"position"),A.linkProgram(v),e.debug.checkShaderErrors){var F=A.getProgramInfoLog(v).trim(),W=A.getShaderInfoLog(V).trim(),B=A.getShaderInfoLog(w).trim(),X=!0,y=!0;if(!1===A.getProgramParameter(v,35714)){X=!1;var k=o(A,V,"vertex"),j=o(A,w,"fragment");console.error("THREE.WebGLProgram: Shader Error "+A.getError()+" - VALIDATE_STATUS "+A.getProgramParameter(v,35715)+"\n\nProgram Info Log: "+F+"\n"+k+"\n"+j)}else""!==F?console.warn("THREE.WebGLProgram: Program Info Log:",F):""!==W&&""!==B||(y=!1);y&&(this.diagnostics={runnable:X,programLog:F,vertexShader:{log:W,prefix:c},fragmentShader:{log:B,prefix:g}})}return A.deleteShader(V),A.deleteShader(w),this.getUniforms=function(){return void 0===x&&(x=new n.WebGLUniforms(A,v)),x},this.getAttributes=function(){return void 0===D&&(D=function(e,n){for(var r={},i=e.getProgramParameter(n,35721),t=0;t<i;t++){var a=e.getActiveAttrib(n,t),o=a.name,d=1;35674===a.type&&(d=2),35675===a.type&&(d=3),35676===a.type&&(d=4),r[o]={type:a.type,location:e.getAttribLocation(n,o),locationSize:d}}return r}(A,v)),D},this.destroy=function(){_.releaseStatesOfProgram(this),A.deleteProgram(v),this.program=void 0},this.name=u.shaderName,this.id=a++,this.cacheKey=S,this.usedTimes=1,this.program=v,this.vertexShader=V,this.fragmentShader=w,this},Object.defineProperty(e,"__esModule",{value:!0})}));
